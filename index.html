



<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="page-title">Kelas Pagi Sistem Informasi</title>
     <link rel="icon" type="image/png" href="https://i.imgur.com/22RGWuH.png">
     <meta name="description" content="Pusat administrasi dan kegiatan daring Sistem Informasi Kelas Pagi Universitas Batam. Layanan absensi kehadiran, komunikasi mahasiswa, upload tugas, dan informasi akademik terpadu.">
<meta name="keywords" content="Absensi UNIBA, Tugas Sistem Informasi, Universitas Batam Kelas Pagi, Portal Mahasiswa UNIBA">

<meta property="og:title" content="Portal Akademik SI Kelas Pagi - Universitas Batam">
<meta property="og:description" content="Pusat kegiatan daring: Absensi kehadiran, koordinasi tugas, komunikasi antar mahasiswa, dan akses materi kuliah Sistem Informasi UNIBA.">
<meta property="og:image" content="https://i.imgur.com/22RGWuH.png">
<meta property="og:url" content="https://sisteminformasi-id.netlify.app/">
<meta property="og:type" content="website">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Sistem Informasi UNIBA (Kelas Pagi)">
<meta name="twitter:description" content="Akses cepat absensi, upload tugas, dan ruang komunikasi daring mahasiswa Sistem Informasi Universitas Batam.">
<meta name="twitter:image" content="https://i.imgur.com/FC12V8E.png">

<link rel="icon" type="image/png" href="https://i.imgur.com/22RGWuH.png">
    <style> 
        /* ======================================= */
        /* === SCRIPT BY ADITYA / XIAOLIN === */
        /* ======================================= */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            /* Warna Latar Belakang dan Glassmorphism (ASLI) */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --dark-overlay: rgba(0, 0, 0, 0.5); 
            
            /* Warna Notifikasi (ASLI - Digunakan untuk mode Login) */
            --notif-bg: var(--glass-bg); 
            --notif-border: var(--glass-border);
            --notif-text: var(--text-color); 
            
            /* Warna Lain */
            --btn-bg: rgba(255, 255, 255, 0.75);
            --btn-text: #1f1f1f;
            --text-color: rgba(255, 255, 255, 0.9); /* Hampir Putih */
            --input-placeholder: rgba(255, 255, 255, 0.7); 
            --secondary-text: rgba(255, 255, 255, 0.9); /* Jaminan teks kecil (seperti 'belum punya akun?') tetap putih */
            --focus-glow: rgba(255, 255, 255, 0.2); 
            
            /* Warna Toggle (ASLI) */
            --toggle-bg: rgba(255, 255, 255, 0.2);
            --toggle-active-bg: rgba(255, 255, 255, 0.8);
            --background-image-url: url('https://i.imgur.com/bybafqv.jpeg'); 

            /* === WARNA DASHBOARD BARU (Untuk Konsistensi) === */
            --sidebar-bg: #36374f;        /* Biru gelap keabu-abuan (dari gambar) */
            --sidebar-hover: #4b4e6c;     /* Versi sedikit lebih terang untuk hover */
            --sidebar-active-bg: #40435e;
            --sidebar-link-text: #fff;
            --navbar-bg: #ffffff;
            --main-bg: #f4f7f6;
            --header-border: #e0e0e0;
            --table-header-bg: #f8f9fa;
            --action-edit: #28a745;
            --action-delete: #dc3545;
            --button-primary: #28a745;
            --button-secondary: #007bff;
            --warning-bg: #ffc107;
            --warning-text: #343a40;
            --info-bg: #d1ecf1; /* PERUBAHAN BARU: Warna info */
            --info-text: #0c5460;
            --info-border: #bee5eb;
            --success-bg: #d4edda; /* PERUBAHAN BARU: Warna sukses */
            --success-text: #155724;
            --success-border: #c3e6cb;


            /* Warna Chat */
            --chat-bg-self: #dcf8c6; /* Hijau muda (Mirip WhatsApp) */
            --chat-bg-other: #ffffff;
            --chat-timestamp: #888;
        }

        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            /* BASE STYLE: Disesuaikan untuk dua mode */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-image: linear-gradient(var(--dark-overlay), var(--dark-overlay)), var(--background-image-url);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow: hidden;
            flex-direction: column; 
        }
        

body.login-mode {
    background-image: linear-gradient(var(--dark-overlay), var(--dark-overlay)), var(--background-image-url);
    justify-content: center;
    align-items: center;
    overflow: hidden;
    animation: panBackgroundSlowly 20s ease-in-out infinite alternate;
}

        body.dashboard-mode {
            background-image: none;
            background-color: var(--main-bg); 
            overflow: auto;
            justify-content: flex-start;
            align-items: flex-start;
            flex-direction: row;
        }
        
        .login-container {
            position: relative;
            width: 350px;
            padding: 40px;
            border-radius: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            text-align: center;
            transition: opacity 0.5s, transform 0.5s;
        }
        
        /* Sembunyikan form login saat di mode dashboard */
        body.dashboard-mode .login-container {
            display: none;
        }
        
        /* GAYA ASLI (DIPERTAHINKAN) */
        #notification-bubble {
            position: fixed; top: 0; left: 50%; transform: translate(-50%, -200%); background-color: var(--notif-bg); border: 1px solid var(--notif-border); backdrop-filter: blur(10px); color: var(--notif-text); padding: 15px 30px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); font-size: 16px; font-weight: 500; z-index: 1000; transition: transform 0.5s ease-in-out; 
        }
        #notification-bubble.show {
            transform: translate(-50%, 0); 
        }
        #notification-bubble.hide {
            transform: translate(-50%, -200%); 
        }

        /* ======================================= */
        /* === MODIFIKASI: Notifikasi di Dashboard === */
        /* ======================================= */
        body.dashboard-mode #notification-bubble {
            /* Menimpa warna dari :root untuk mode dashboard */
            --notif-text: #1f1f1f; /* Warna teks hitam */
            --notif-bg: rgba(255, 255, 255, 0.9); /* Latar belakang putih buram */
            --notif-border: #ccc; /* Border abu-abu terang */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* Shadow lebih lembut untuk latar belakang terang */
        }
        
        /* GAYA ASLI (Lanjutan) */
        .role-toggle-container {
            display: flex; justify-content: center; align-items: center; margin-bottom: 30px; padding: 8px; background: var(--toggle-bg); border-radius: 30px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .role-toggle-button {
            flex-grow: 1; padding: 10px 15px; font-size: 14px; font-weight: 600; color: var(--secondary-text); background: transparent; border: none; border-radius: 30px; cursor: pointer; transition: all 0.3s ease;
        }
        .role-toggle-button.active {
            color: var(--btn-text); background: var(--toggle-active-bg); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .form-wrapper {
            transition: opacity 0.3s ease;
        }
        .form-wrapper.hidden {
            display: none; opacity: 0;
        }
        .header-text {
            margin-bottom: 20px; text-align: left;
        }
        .header-text h2 {
            font-size: 28px; color: var(--text-color); font-weight: 700; margin-bottom: 5px;
        }
        .header-text p {
            font-size: 14px; color: var(--secondary-text); font-weight: 400;
        }
        .input-group {
            margin-bottom: 20px; position: relative; height: 50px; border-radius: 25px; background-color: rgba(255, 255, 255, 0.1); display: flex; align-items: center; padding: 0 15px; border: 1px solid transparent; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .input-group.focus {
            background-color: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 0 15px var(--focus-glow); transform: scale(1.02);
        }
        .input-group input {
            width: 100%; height: 100%; background: transparent; border: none; outline: none; color: var(--text-color); font-size: 16px; padding-left: 10px;
        }
        .input-group input::placeholder {
            color: var(--input-placeholder);
        }
        .input-group .icon {
            color: var(--input-placeholder); font-size: 20px; transition: color 0.3s ease;
        }
        .input-group.focus .icon {
            color: var(--text-color);
        }
        .btn-submit {
            width: 100%; height: 50px; border: none; border-radius: 25px; background-color: var(--btn-bg); color: var(--btn-text); font-size: 18px; font-weight: 600; cursor: pointer; margin-top: 15px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-submit:hover {
            background-color: rgba(255, 255, 255, 1); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-submit:active {
            transform: scale(0.98);
        }
        .options {
            display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 14px;
        }
        
        /* KOREKSI: Pastikan label (termasuk "Remember me") berwarna putih/terang */
        .options label {
            color: var(--secondary-text); /* Menggunakan secondary-text yang kini putih */
            display: flex; align-items: center; cursor: pointer;
        }
        
        .options input[type="checkbox"] {
            appearance: none; width: 14px; height: 14px; 
            border: 1px solid var(--secondary-text); /* Border checkbox juga diubah */
            border-radius: 3px; margin-right: 8px; cursor: pointer; position: relative; background-color: transparent; transition: all 0.2s ease;
        }
        .options input[type="checkbox"]:checked {
            background-color: var(--text-color); border-color: var(--text-color);
        }
        .options input[type="checkbox"]:checked::after {
            content: 'âœ“'; position: absolute; top: -3px; left: 1px; font-size: 12px; color: var(--btn-text); 
        }
        
        /* KOREKSI: Pastikan link "Forgot Password?" berwarna putih/terang */
        .options a {
            color: var(--secondary-text); /* Menggunakan secondary-text yang kini putih */
            text-decoration: none; font-weight: 500; transition: color 0.3s ease;
        }

        .options a:hover {
            color: var(--text-color);
            cursor: pointer; /* Menambahkan kursor pointer */
        }
        
        /* KOREKSI: Pastikan teks "Belum punya akun?" berwarna putih/terang */
        .switch-mode {
            margin-top: 30px; font-size: 14px; 
            color: var(--secondary-text); /* Menggunakan secondary-text yang kini putih */
        }
        .switch-mode a {
            color: var(--text-color); text-decoration: none; font-weight: 600; cursor: pointer; transition: color 0.3s ease;
        }
        .switch-mode a:hover {
            color: rgba(255, 255, 255, 1); text-decoration: underline;
        }
        
        /* ======================================= */
        /* === BAGIAN BARU: CSS MODAL IKLAN === */
        /* ======================================= */
        .ad-modal {
            display: none; /* Default: Sembunyikan */
            position: fixed;
            z-index: 2000; /* Pastikan di atas semua elemen lain */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Background gelap transparan */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .ad-modal.show {
            display: flex;
            opacity: 1;
        }

        .ad-modal-content {
            position: relative;
            background-color: #fefefe;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 650px; /* Lebar maksimal desktop diperbesar sedikit */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8);
            animation: fadeInScale 0.4s ease-out;
            overflow: hidden; /* Pastikan gambar dan tombol tutup di dalam batas */
        }

        .ad-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px; /* Sesuaikan dengan border-radius content */
        }

        /* Tombol Tutup */
        .ad-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001; /* Di atas gambar */
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            line-height: 32px;
            text-align: center;
            transition: background-color 0.2s;
        }

        .ad-close-btn:hover,
        .ad-close-btn:focus {
            background-color: rgba(0, 0, 0, 0.9);
            text-decoration: none;
        }

        /* Animasi Pop-in */
        @keyframes fadeInScale {
            from {
                transform: scale(0.9) translateY(20px);
                opacity: 0.8;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        /* Media Query untuk Mobile (HP) */
        @media (max-width: 650px) {
            .ad-modal-content {
                width: 95%; /* Agak lebih lebar di mobile */
                max-width: 95%;
            }
        }

        /* ======================================= */
        /* === BAGIAN 2: CSS DASHBOARD BARU (dari SS) === */
        /* ======================================= */

        #dashboard-wrapper {
            display: none;
            width: 100vw;
            min-height: 100vh;
            position: absolute; 
            top: 0;
            left: 0;
        }

        body.dashboard-mode #dashboard-wrapper {
            display: flex;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 230px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-link-text);
            padding-top: 0;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 900;
        }
        
        .sidebar-header {
            background-color: var(--sidebar-bg);
            padding: 15px 20px;
            font-size: 20px;
            font-weight: 700;
            color: var(--sidebar-link-text);
            height: 60px; 
            display: flex;
            align-items: center;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            padding-top: 10px;
            /* Flex column untuk menempatkan logout di bawah */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: calc(100vh - 60px); /* Memastikan menu mengisi sisa tinggi */
        }
        
        .main-menu-items {
             padding: 0;
             list-style: none;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--sidebar-link-text);
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .menu-link:hover {
            background-color: var(--sidebar-hover);
        }
        
        .menu-link.active {
            background-color: var(--sidebar-active-bg);
        }

        .menu-link i {
            margin-right: 15px;
            font-size: 18px;
        }

        /* Logout button di sidebar */
        .sidebar-footer {
            margin-top: auto; /* Mendorong ke bawah */
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-footer #logout-sidebar-button {
             /* Menggunakan style menu link agar konsisten */
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 20px;
            color: #ffffff; /* Warna merah muda untuk logout */
            background: transparent;
            border: none;
            cursor: pointer;
            text-align: left;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-footer #logout-sidebar-button:hover {
            background-color: var(--sidebar-hover);
            color: white;
        }
        
        /* --- Main Content Area --- */
        .main-content {
            margin-left: 230px; 
            flex-grow: 1;
            padding-top: 60px; 
            min-height: 100vh;
            background-color: var(--main-bg);
            transition: margin-left 0.3s ease;
            width: calc(100% - 230px); 
        }
        
        /* --- Top Navbar --- */
        .navbar {
            position: fixed;
            top: 0;
            left: 230px;
            right: 0;
            height: 60px;
            background-color: var(--navbar-bg);
            border-bottom: 1px solid var(--header-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 800;
            transition: left 0.3s ease;
        }

        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-right {
            display: flex;
            align-items: center;
            gap: 20px; 
        }

        /* Tombol Logout di Navbar (Desktop) - Dihapus dari HTML */
        #logout-button-desktop {
            display: none;
        }
        
        /* Wrapper untuk Hamburger (memperbesar area klik) */
        .hamburger-wrapper {
            padding: 10px; /* Area klik 44px x 44px */
            cursor: pointer;
            color: #333;
            margin-right: 10px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .hamburger-menu {
            font-size: 24px;
            color: #333;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .user-info i {
            font-size: 20px;
            color: #5f4b8b;
        }
        
        /* PERBAIKAN CSS FOTO PROFIL NAVBAR */
        .user-info img {
            width: 40px; /* Diperbesar sedikit */
            height: 40px; /* Diperbesar sedikit */
            border-radius: 50%;
            margin-left: 0; 
            border: 2px solid var(--sidebar-bg);
            object-fit: cover; /* Penting: Memastikan gambar menutupi area tanpa distorsi */
            transition: transform 0.2s;
        }
        
        .user-info:hover img {
            transform: scale(1.05);
        }
        /* END PERBAIKAN CSS */

        
        /* Breadcrumb */
        .breadcrumb {
            color: #6c757d;
            font-size: 14px;
        }
        
        .breadcrumb a {
            color: var(--sidebar-bg);
            text-decoration: none;
        }
        
        .breadcrumb span {
            margin: 0 5px;
        }


        /* --- Page Content --- */
        .page-content {
            padding: 20px;
        }

        .content-card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .content-card h3 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
        
        /* Styling untuk User Profile Card (BARU) */
        .profile-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .profile-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--sidebar-bg);
            margin-bottom: 15px;
            /* PERUBAHAN: Tambahkan cursor pointer */
            cursor: pointer;
            transition: filter 0.2s;
        }

        .profile-card img:hover {
            filter: brightness(0.9);
        }
        
        .profile-info {
            width: 100%;
            max-width: 400px;
        }
        
        .profile-info .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }
        
        .profile-info .data-item:last-child {
            border-bottom: none;
        }
        
        .profile-info .data-item strong {
            color: #333;
            font-weight: 600;
        }
        
        .profile-info .data-item span {
            color: #555;
        }
        
        .profile-header {
            margin-bottom: 30px;
        }
        
        .profile-header h4 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .profile-header p {
            color: #6c757d;
            font-size: 14px;
        }
        
        .profile-action button {
            margin-top: 15px;
        }

        /* Toggle Content Display */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }


        /* Tombol Aksi */
        .action-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .btn-action {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-action i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background-color: var(--button-primary);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--button-secondary);
            color: white;
        }
        
        .btn-primary:hover { background-color: #218838; }
        .btn-secondary:hover { background-color: #0056b3; }


        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            text-align: left;
        }

        .data-table th {
            background-color: var(--table-header-bg);
            padding: 12px 15px;
            border-bottom: 2px solid #e9ecef;
            color: #495057;
            font-weight: 600;
        }
        
        /* Update untuk membuat sel klik di daftar mahasiswa */
        #mahasiswa-table-body td:nth-child(2),
        #mahasiswa-table-body td:nth-child(3),
        #mahasiswa-table-body td:nth-child(4) {
             cursor: pointer;
             transition: background-color 0.1s;
        }
        
        #mahasiswa-table-body tr:hover td:nth-child(2),
        #mahasiswa-table-body tr:hover td:nth-child(3),
        #mahasiswa-table-body tr:hover td:nth-child(4) {
             /* highlight baris saat hover di kolom ID/Name/Avatar */
             background-color: #f0f0f0; 
        }

        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            color: #343a40;
            /* PERUBAHAN: Pastikan sel tabel rata tengah secara vertikal */
            vertical-align: middle;
        }
        
        .data-table tr:hover {
            background-color: #fcfcfc;
        }

        /* Action Buttons in Table */
        .table-actions .btn-action {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 12px;
        }
        
        .btn-edit {
            background-color: var(--action-edit);
            color: white;
        }
        
        .btn-delete {
            background-color: var(--action-delete);
            color: white;
        }
        
        .btn-edit:hover { background-color: #1e7e34; }
        .btn-delete:hover { background-color: #c82333; }

        /* Toggle Switch (Bootstrap-like) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--button-primary);
        }

        input:checked + .slider:before {
            transform: translateX(16px);
        }


        /* CSS Tambahan untuk Dropdown Dosen */
        .select-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .select-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        /* PERBAIKAN: Terapkan style ini juga ke input password baru */
        .select-group select,
        .select-group input[type="text"],
        .select-group input[type="email"], /* Tambahkan email */
        .select-group input[type="password"], /* Tambahkan password */
        .select-group input[type="time"] {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 15px;
            /* Hentikan tampilan panah default untuk select */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            
            /* Pastikan input text, email, password, dan time tidak terpengaruh panah */
            background-image: none;
        }

        /* Tambahkan panah custom HANYA untuk select */
        .select-group select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%20173.5c-4%204-9.3%206-14.7%206s-10.7-2-14.7-6L146.2%2069.9%2034.8%20173.5c-4%204-9.3%206-14.7%206s-10.7-2-14.7-6c-8-8-8-20.7%200-28.7l125.7-125.7c8-8%2020.7-8%2028.7%200l125.7%20125.7c8%208%208%2020.7%200%2028.7z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px auto;
            /* HACK: Pastikan override IE/Edge lama */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%20173.5c-4%204-9.3%206-14.7%206s-10.7-2-14.7-6L146.2%2069.9%2034.8%20173.5c-4%204-9.3%206-14.7%206s-10.7-2-14.7-6c-8-8-8-20.7%200-28.7l125.7-125.7c8-8%2020.7-8%2028.7%200l125.7%20125.7c8%208%208%2020.7%200%2028.7z%22%2F%3E%3C%2Fsvg%3E') \9; 
        }

        .alert-warning {
            padding: 15px;
            border-radius: 8px;
            background-color: var(--warning-bg);
            color: var(--warning-text);
            font-weight: 500;
            margin-bottom: 15px;
            text-align: center; /* PERUBAHAN BARU */
        }
        
        /* PERUBAHAN BARU: Style untuk Info dan Sukses */
        .alert-info {
            padding: 15px; border-radius: 8px; background-color: var(--info-bg);
            color: var(--info-text); border: 1px solid var(--info-border);
            font-weight: 500; margin-bottom: 15px; text-align: center;
        }
        .alert-success {
            padding: 15px; border-radius: 8px; background-color: var(--success-bg);
            color: var(--success-text); border: 1px solid var(--success-border);
            font-weight: 500; margin-bottom: 15px; text-align: center;
        }
        
        /* Modal Style untuk Tanda Tangan */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Default hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        #signature-canvas {
            border: 1px solid #ccc;
            background: #f9f9f9;
            touch-action: none; /* Penting untuk touch screen drawing */
        }
        
        /* === STYLE BARU UNTUK PUBLIC PROFILE MODAL === */
        #public-profile-modal .modal-content {
            max-width: 500px;
        }
        
        .public-profile-info .data-item {
            padding: 8px 0;
        }
        
        .exp-bar {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .exp-bar-fill {
            height: 100%;
            background-color: #ffc107; /* Warning color for EXP */
            transition: width 0.5s ease;
        }
        /* ============================================= */

        /* --- CHAT SECTION STYLES --- */
        #chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0; /* Chat background */
        }
        #chat-messages {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .chat-input-area {
            display: flex;
            flex-direction: column; /* Mengubah ke kolom untuk menampung reply-preview */
            padding: 10px;
            background: #fff;
            border-top: 1px solid #ddd;
        }
        .chat-input-wrapper {
            display: flex;
            width: 100%;
        }
        .chat-input-area input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 14px;
        }
        .chat-input-area button {
            background-color: var(--button-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            min-width: 40px; /* Tambahkan min-width agar tidak menyusut */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* NEW: Reply Preview Styling */
        #reply-preview {
            display: none; /* Default tersembunyi */
            background-color: #f1f1f1;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--sidebar-bg); /* Garis warna hijau/ungu */
            position: relative;
            overflow: hidden;
        }
        #reply-preview.active {
            display: block;
        }
        #reply-preview .reply-text {
            font-size: 13px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #reply-preview .reply-sender {
            font-weight: 600;
            color: var(--sidebar-bg);
            font-size: 14px;
            margin-bottom: 2px;
        }
        #cancel-reply-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.2s;
        }
        #cancel-reply-btn:hover {
            color: #333;
        }


        /* Chat Bubbles */
        .chat-message {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            width: 100%; /* Memastikan menempati full width untuk alignment */
            cursor: pointer; /* Memberi indikasi bisa di-klik/swipe */
        }
        .chat-message:hover .reply-icon {
             opacity: 1;
             transform: translateX(0);
        }
        .chat-message.self {
            align-self: flex-end;
            align-items: flex-end;
        }
        .chat-message.other {
            align-self: flex-start;
            align-items: flex-start;
        }
        
        /* NEW: Reply Icon/Button (Hidden by default, shown on hover/touch) */
        .reply-icon {
             position: absolute;
             font-size: 18px;
             color: #999;
             padding: 5px;
             cursor: pointer;
             opacity: 0;
             transition: all 0.2s ease;
             z-index: 50;
        }
        .chat-message.self .reply-icon {
            right: 100%; /* Di luar bubble kanan */
            transform: translateX(10px);
        }
        .chat-message.other .reply-icon {
            left: 100%; /* Di luar bubble kiri */
            transform: translateX(-10px);
        }
        /* Mobile: Tampilkan ikon reply saat disentuh/klik lama */
        @media (max-width: 768px) {
            .chat-message .reply-icon {
                display: none !important; /* Hilangkan ikon hover */
            }
        }
        
        
        .chat-bubble-content {
             /* Wrapper untuk bubble agar mentok 80% */
            max-width: 80%;
            display: flex;
            flex-direction: column;
            position: relative; /* Agar reply-icon bisa di-absolut-kan relatif terhadap ini */
        }
        .chat-bubble {
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }
        .chat-message.self .chat-bubble {
            background-color: var(--chat-bg-self);
            color: #1f1f1f;
            border-bottom-right-radius: 2px;
        }
        .chat-message.other .chat-bubble {
            background-color: var(--chat-bg-other);
            color: #1f1f1f;
            border-bottom-left-radius: 2px;
        }
        
        /* NEW: Quoted Reply Box inside bubble */
        .chat-quoted-reply {
            margin: -5px -8px 5px -8px; /* Margin negatif untuk menempel ke atas bubble */
            padding: 8px;
            border-radius: 12px 12px 4px 4px;
            font-size: 13px;
            border-left: 3px solid #5f4b8b; /* Warna ungu untuk border */
            overflow: hidden;
        }
        .chat-message.self .chat-quoted-reply {
            background-color: rgba(95, 75, 139, 0.1); /* Latar belakang transparan di bubble hijau */
        }
        .chat-message.other .chat-quoted-reply {
            background-color: rgba(95, 75, 139, 0.05); /* Latar belakang transparan di bubble putih */
        }
        .chat-quoted-reply .quoted-sender {
            font-weight: 700;
            color: #5f4b8b;
            margin-bottom: 2px;
        }
        .chat-quoted-reply .quoted-text {
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            display: block;
        }
        
        .chat-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
            color: #5f4b8b;
        }
        .chat-timestamp {
            font-size: 10px;
            color: var(--chat-timestamp);
            margin-top: 2px;
            align-self: flex-end; /* Memastikan timestamp selalu di bawah kanan bubble */
        }

        /* --- ACCORDION PANDUAN (BARU) --- */
        .accordion-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .accordion-item {
            border-bottom: 1px solid #e0e0e0;
        }
        .accordion-item:last-child {
            border-bottom: none;
        }
        .accordion-header {
            width: 100%;
            background-color: #f8f9fa;
            border: none;
            outline: none;
            padding: 15px 20px;
            text-align: left;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .accordion-header:hover {
            background-color: #f1f3f5;
        }
        .accordion-header i {
            transition: transform 0.3s ease;
            color: var(--sidebar-bg);
        }
        .accordion-header.active i {
            transform: rotate(180deg);
        }
        .accordion-content {
            padding: 0 20px;
            background-color: #ffffff;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .accordion-content p {
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #555;
        }
        /* Style untuk padding saat terbuka */
        .accordion-content.open {
            /* padding: 15px 20px; (Dihapus, dikontrol JS untuk transisi) */
            max-height: 500px; /* Set max-height yang cukup */
        }
        
        /* PERUBAHAN BARU: Style untuk Countdown Timer */
        #countdown-timer {
            font-size: 24px;
            font-weight: 700;
            color: var(--sidebar-bg);
            margin-top: 10px;
        }

        /* PERUBAHAN BARU: Style untuk Log Absensi */
        #absen-log-container h4 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-top: 25px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--sidebar-bg);
        }
        #absen-log-container h5 {
            font-size: 16px;
            font-weight: 600;
            color: #555;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        #absen-log-container .log-status-hadir {
            color: #155724; /* success-text */
            font-weight: 600;
        }
        #absen-log-container .log-status-absen {
            color: #dc3545; /* action-delete */
            font-weight: 600;
        }


        /* ======================================= */
        /* === BAGIAN 3: MEDIA QUERY (RESPONSIVE) === */
        /* ======================================= */
        
        @media (max-width: 768px) {
            
            /* Sembunyikan sidebar secara default di mobile */
            .sidebar {
                transform: translateX(-230px);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                z-index: 950; /* Perbaikan z-index */
            }
            
            /* Tampilkan saat tombol hamburger diklik */
            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100vw;
            }
            
            .navbar {
                left: 0;
                /* Hapus padding kiri agar menu hamburger bisa di ujung */
                padding: 0 20px; 
                z-index: 900; /* Perbaikan z-index */
            }
            
            /* Tampilkan wrapper hamburger */
            .hamburger-wrapper {
                display: flex !important; /* Perbaikan: pastikan terlihat */
                align-items: center; /* Perbaikan */
                justify-content: center; /* Perbaikan */
                padding: 0 15px; /* Area klik lebih baik */
                height: 60px; /* Samakan tinggi navbar */
            }
            
            .navbar-left {
                width: auto; 
                justify-content: flex-start;
            }
            
            .navbar-left .breadcrumb {
                display: none;
            }
            
            /* Overlay saat sidebar terbuka */
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 920; /* Perbaikan z-index (di bawah sidebar) */
                display: none;
            }
            
            .overlay.active {
                display: block;
            }
            
            .content-card {
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 600px; 
            }
            
            .profile-info {
                max-width: 100%;
            }

            /* Sembunyikan tombol logout desktop di mobile */
            #logout-button-desktop {
                display: none;
            }
             /* Chat Bubbles di mobile */
            .chat-message {
                max-width: 100%; /* Gunakan full width container */
            }
            .chat-bubble-content {
                max-width: 90%; /* Bubble max 90% di mobile */
            }

        }
        /* ======================================= */
/* === CSS KHUSUS UNTUK LINK ZOOM/DISCORD === */
/* ======================================= */

/* Memberi style utama (teks putih, padding, dll) */
.menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"] {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: var(--sidebar-link-text); /* Ini akan membuat teks & ikon jadi PUTIH */
    text-decoration: none;
    font-size: 15px;
    font-weight: 500;
    transition: background-color 0.2s ease;
}

/* Style saat di-hover */
.menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"]:hover {
    background-color: var(--sidebar-hover);
}

/* Memberi jarak antara ikon dan teks */
.menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"] i {
     margin-right: 15px;
     font-size: 18px;
}

/* ======================================= */
/* === CSS BARU: MENU KONTEKS CHAT (TENGAH) === */
/* ======================================= */
#chat-context-menu {
    display: none; 
    position: fixed;
    z-index: 1100; /* Di atas overlay */
    
    /* === GAYA BARU UNTUK POSISI TENGAH === */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    /* ================================== */
    
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    min-width: 200px;
    overflow: hidden;
}
#chat-context-menu ul {
    list-style: none;
    padding: 5px 0;
    margin: 0;
}
#chat-context-menu li {
    padding: 10px 15px;
    font-size: 14px;
    color: #333;
    cursor: pointer;
    display: flex;
    align-items: center;
}
#chat-context-menu li i {
    margin-right: 12px;
    width: 15px;
    text-align: center;
    color: #555;
}
#chat-context-menu li:hover {
    background-color: #f4f4f4;
}
#chat-context-menu li.menu-separator {
    border-top: 1px solid #eee;
    margin-top: 5px;
    padding-top: 10px;
}
/* Style khusus untuk Hapus (merah) */
#chat-context-menu li#ctx-delete-all {
    color: var(--action-delete);
}
#chat-context-menu li#ctx-delete-all i {
    color: var(--action-delete);
}
/* ======================================= */
/* === CSS BARU: MENU KONTEKS CHAT (TENGAH) === */
/* ======================================= */
#chat-context-menu {
    display: none; 
    position: fixed;
    z-index: 1100; /* Di atas overlay */
    
    /* === GAYA BARU UNTUK POSISI TENGAH === */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    /* ================================== */
    
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    min-width: 200px;
    overflow: hidden;
}
#chat-context-menu ul {
    list-style: none;
    padding: 5px 0;
    margin: 0;
}
#chat-context-menu li {
    padding: 10px 15px;
    font-size: 14px;
    color: #333;
    cursor: pointer;
    display: flex;
    align-items: center;
}
#chat-context-menu li i {
    margin-right: 12px;
    width: 15px;
    text-align: center;
    color: #555;
}
#chat-context-menu li:hover {
    background-color: #f4f4f4;
}
#chat-context-menu li.menu-separator {
    border-top: 1px solid #eee;
    margin-top: 5px;
    padding-top: 10px;
}
/* Style khusus untuk Hapus (merah) */
#chat-context-menu li#ctx-delete-all {
    color: var(--action-delete);
}
#chat-context-menu li#ctx-delete-all i {
    color: var(--action-delete);
}
/* ======================================= */
/* === CSS BARU: TYPING INDICATOR === */
/* ======================================= */
#typing-indicator {
    /* Sembunyi by default */
    display: none; 
    font-size: 13px;
    font-style: italic;
    color: #888;
    padding: 0 10px 5px 10px; /* Padding di bawah, sebelum input */
    height: 20px; /* Beri tinggi agar layout tidak 'loncat' */
    line-height: 20px;
    transition: opacity 0.3s ease;
}
#typing-indicator.active {
    /* Tampilkan saat aktif */
    display: block; 
}

@keyframes panBackgroundSlowly {
    0% {
        /* Mulai dari Kiri-Tengah */
        background-position: 0% 50%;
    }
    100% {
        /* Selesai di Kanan-Tengah */
        background-position: 100% 50%;
    }
}
@media (min-width: 1024px) {
    body.login-mode {
        /* Terapkan animasi hanya jika lebar layar 1024px atau lebih */
        animation: panBackgroundSlowly 20s ease-in-out infinite alternate;
    }
}
/* WRAPPER VIDEO */
.news-video-wrapper {
    width: 100%;
    display: flex;
    justify-content: center; /* ðŸ“± default: tengah */
    margin-top: 16px;
}

/* VIDEO */
.news-video {
    width: 100%;
    max-width: 420px;
    aspect-ratio: 16 / 9;
    border-radius: 12px;
    background: #000;
    display: block;
}

/* ===== PC MODE ===== */
@media (min-width: 1024px) {
    .news-video-wrapper {
        justify-content: flex-start; /* ðŸ–¥ï¸ pindah ke kiri */
        padding-left: 32px;         /* âœ¨ biar manis, ga nempel */
    }

    .news-video {
        margin: 0; /* hapus auto-center */
    }
}
/* ===== CSS UNTUK FITUR PDF ===== */
.pdf-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.pdf-controls .select-group {
    flex: 1;
    min-width: 200px;
}

.pdf-preview-container {
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    background-color: #f9f9f9;
    text-align: center;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.pdf-preview-container h4 {
    color: #555;
    margin-bottom: 15px;
}

.pdf-signature-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--sidebar-bg);
}

.signature-canvas-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin: 20px 0;
}

#dosen-signature-canvas {
    border: 2px solid #ccc;
    background-color: #fff;
    border-radius: 5px;
    touch-action: none;
}

.signature-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
}

.pdf-status {
    padding: 10px 15px;
    border-radius: 5px;
    margin-top: 15px;
    font-weight: 500;
    display: none;
}

.pdf-status.success {
    background-color: var(--success-bg);
    color: var(--success-text);
    border: 1px solid var(--success-border);
    display: block;
}

.pdf-status.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

.pdf-download-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #e8f4fd;
    border-radius: 8px;
    text-align: center;
}

#pdf-preview-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    display: none;
}

#pdf-preview-table th {
    background-color: var(--sidebar-bg);
    color: white;
    padding: 12px;
    text-align: left;
}

#pdf-preview-table td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}

#pdf-preview-table tr:hover {
    background-color: #f5f5f5;
}
/* ======================================= */
/* === CSS UNTUK DROPDOWN MENU SIDEBAR === */
/* ======================================= */
.menu-item.has-dropdown {
    position: relative;
}

.menu-item.has-dropdown > .menu-link {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.menu-item.has-dropdown > .menu-link::after {
    content: '\f078';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    font-size: 12px;
    transition: transform 0.3s ease;
}

.menu-item.has-dropdown.open > .menu-link::after {
    transform: rotate(180deg);
}

.dropdown-menu {
    display: none;
    list-style: none;
    padding: 0;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 0 0 5px 5px;
    overflow: hidden;
    animation: slideDown 0.3s ease;
}

.dropdown-menu.open {
    display: block;
}

.dropdown-menu .menu-link {
    padding-left: 50px; /* Indentasi untuk submenu */
    font-size: 14px;
}

.dropdown-menu .menu-link:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Mobile responsive */
@media (max-width: 768px) {
    .dropdown-menu .menu-link {
        padding-left: 60px;
    }
}
/* Tambahkan di bagian CSS (setelah .sidebar-menu style) */
.menu-group {
    margin: 15px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 10px;
}

.menu-group:last-child {
    border-bottom: none;
}

.menu-group-title {
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 20px;
    margin-top: 5px;
    display: flex;
    align-items: center;
}

.menu-group-title i {
    margin-right: 10px;
    font-size: 10px;
}

/* Perbaikan untuk item menu agar lebih rapi */
.main-menu-items {
    padding: 0;
    list-style: none;
    overflow-y: auto;
    max-height: calc(100vh - 140px);
}

.menu-item {
    margin: 2px 0;
}

.menu-link {
    padding: 10px 20px !important;
    font-size: 14px !important;
    border-radius: 5px;
    margin: 2px 10px;
    transition: all 0.2s ease;
}

.menu-link:hover {
    background-color: var(--sidebar-hover) !important;
    transform: translateX(5px);
}

.menu-link.active {
    background-color: var(--sidebar-active-bg) !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

/* Untuk mobile, sembunyikan judul grup */
@media (max-width: 768px) {
    .menu-group-title {
        font-size: 11px;
        padding: 5px 15px;
    }
    
    .menu-link {
        padding: 8px 15px !important;
        font-size: 13px !important;
    }
}/* ======================================= */
/* === ANIMASI UNTUK ZOOM MAHASISWA === */
/* ======================================= */

.menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"] {
    display: flex;
    align-items: center;
    padding: 10px 20px !important;
    color: var(--sidebar-link-text) !important;
    text-decoration: none;
    font-size: 14px !important;
    border-radius: 5px;
    margin: 2px 10px;
    transition: all 0.2s ease;
}

/* Style saat di-hover (sama seperti menu-link lainnya) */
.menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"]:hover {
    background-color: var(--sidebar-hover) !important;
    transform: translateX(5px);
}

/* Style saat aktif (jika diperlukan) */
.menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"].active {
    background-color: var(--sidebar-active-bg) !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

/* Memberi jarak antara ikon dan teks */
.menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"] i {
    margin-right: 15px;
    font-size: 18px;
    transition: transform 0.2s ease;
}

/* Animasi ikon saat di-hover */
.menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"]:hover i {
    transform: scale(1.1);
}

/* Untuk mobile, sesuaikan padding */
@media (max-width: 768px) {
    .menu-item a[href*="https://sisteminformasi-zoom.netlify.app/"] {
        padding: 8px 15px !important;
        font-size: 13px !important;
    }
}
/* ======================================= */
/* === HIDE SCROLLBAR UNTUK PC/DESKTOP === */
/* ======================================= */

/* Untuk desktop (lebar > 768px) */
@media (min-width: 769px) {
    /* Sembunyikan scrollbar untuk semua elemen yang bisa discroll */
    *::-webkit-scrollbar {
        width: 0px !important;
        height: 0px !important;
        background: transparent !important;
        display: none !important;
    }
    
    /* Untuk Firefox */
    * {
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
    }
    
    /* Untuk IE dan Edge */
    * {
        -ms-overflow-style: none !important;
    }
    
    /* Pastikan konten masih bisa discroll */
    .sidebar-menu,
    .main-menu-items,
    #chat-messages,
    .content-card,
    .table-responsive,
    .accordion-container,
    #absen-log-container,
    #schedule-display-container,
    #pdf-preview-absensi,
    .modal-content,
    #chat-messages,
    .chat-messages {
        overflow-y: auto !important;
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
    }
    
    .sidebar-menu::-webkit-scrollbar,
    .main-menu-items::-webkit-scrollbar,
    #chat-messages::-webkit-scrollbar,
    .content-card::-webkit-scrollbar,
    .table-responsive::-webkit-scrollbar,
    .accordion-container::-webkit-scrollbar,
    #absen-log-container::-webkit-scrollbar,
    #schedule-display-container::-webkit-scrollbar,
    #pdf-preview-absensi::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar,
    #chat-messages::-webkit-scrollbar,
    .chat-messages::-webkit-scrollbar {
        display: none !important;
    }
}

/* Untuk mobile (lebar â‰¤ 768px) - biarkan scrollbar normal */
@media (max-width: 768px) {
    /* Di mobile, scrollbar tetap muncul karena touch screen */
    *::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    *::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    *::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    
    *::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
}
/* ======================================= */
/* === MODAL UPLOAD FOTO PROFIL === */
/* ======================================= */
#upload-photo-modal .modal-content {
    max-width: 400px;
    padding: 25px;
}

.upload-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin: 20px 0;
}

.upload-option {
    display: flex;
    align-items: center;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-option:hover {
    border-color: var(--sidebar-bg);
    background-color: rgba(95, 75, 139, 0.05);
}

.upload-option i {
    font-size: 24px;
    margin-right: 15px;
    color: var(--sidebar-bg);
    width: 40px;
    text-align: center;
}

.upload-option-content {
    flex: 1;
}

.upload-option-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 3px;
}

.upload-option-desc {
    font-size: 12px;
    color: #666;
}

#url-upload-section,
#file-upload-section {
    display: none;
    margin-top: 15px;
}

#url-upload-section.active,
#file-upload-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.url-preview,
.file-preview {
    margin-top: 10px;
    text-align: center;
}

.url-preview img,
.file-preview img {
    max-width: 150px;
    max-height: 150px;
    border-radius: 8px;
    border: 2px solid #ddd;
    margin-bottom: 10px;
}

.upload-progress {
    width: 100%;
    height: 4px;
    background-color: #eee;
    border-radius: 2px;
    margin-top: 10px;
    overflow: hidden;
    display: none;
}

.upload-progress-bar {
    height: 100%;
    background-color: var(--button-primary);
    width: 0%;
    transition: width 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* ======================================= */
/* === HIDE SCROLLBAR UNTUK SEMUA DEVICE === */
/* ======================================= */

/* Untuk semua device (desktop & mobile) */
*::-webkit-scrollbar {
    width: 0px !important;
    height: 0px !important;
    background: transparent !important;
    display: none !important;
}

/* Untuk Firefox */
* {
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
}

/* Untuk IE dan Edge */
* {
    -ms-overflow-style: none !important;
}

/* Pastikan konten masih bisa discroll */
.sidebar-menu,
.main-menu-items,
#chat-messages,
.content-card,
.table-responsive,
.accordion-container,
#absen-log-container,
#schedule-display-container,
#pdf-preview-absensi,
.modal-content,
#chat-messages,
.chat-messages,
.sidebar,
.page-content,
.main-content {
    overflow-y: auto !important;
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
}

/* Hapus semua scrollbar webkit */
.sidebar-menu::-webkit-scrollbar,
.main-menu-items::-webkit-scrollbar,
#chat-messages::-webkit-scrollbar,
.content-card::-webkit-scrollbar,
.table-responsive::-webkit-scrollbar,
.accordion-container::-webkit-scrollbar,
#absen-log-container::-webkit-scrollbar,
#schedule-display-container::-webkit-scrollbar,
#pdf-preview-absensi::-webkit-scrollbar,
.modal-content::-webkit-scrollbar,
#chat-messages::-webkit-scrollbar,
.chat-messages::-webkit-scrollbar,
.sidebar::-webkit-scrollbar,
.page-content::-webkit-scrollbar,
.main-content::-webkit-scrollbar,
body::-webkit-scrollbar,
html::-webkit-scrollbar,
*::-webkit-scrollbar {
    display: none !important;
}
/* ======================================= */
/* === CSS UNTUK PREVIEW FOTO PROFIL === */
/* ======================================= */
#photo-preview-modal .modal-content {
    max-width: 500px;
    padding: 25px;
}

.preview-main-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin: 20px 0;
}

#photo-preview-canvas {
    width: 100%;
    max-width: 300px;
    max-height: 300px;
    border: 2px solid #ddd;
    border-radius: 10px;
    background-color: #f9f9f9;
    object-fit: contain;
}

.preview-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    max-width: 300px;
}

.zoom-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.zoom-controls button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background-color: var(--sidebar-bg);
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

.zoom-controls button:hover {
    background-color: var(--sidebar-hover);
}

.zoom-controls span {
    font-weight: 600;
    color: #333;
    min-width: 60px;
    text-align: center;
}

.position-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.position-slider {
    display: flex;
    align-items: center;
    gap: 10px;
}

.position-slider label {
    font-size: 14px;
    color: #333;
    min-width: 80px;
    font-weight: 500;
}

.position-slider input[type="range"] {
    flex-grow: 1;
    height: 6px;
    border-radius: 3px;
    background: #e0e0e0;
    outline: none;
    -webkit-appearance: none;
}

.position-slider input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--sidebar-bg);
    cursor: pointer;
}

.reset-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}

/* Tombol Hapus Foto */
#delete-photo-btn {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s;
}

#delete-photo-btn:hover {
    background-color: #c82333;
}

#delete-photo-btn i {
    font-size: 14px;
}

.preview-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
    width: 100%;
}

#cancel-preview-btn {
    background-color: #6c757d;
    color: white;
}

#save-photo-btn {
    background-color: var(--button-primary);
    color: white;
}

.preview-crop-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 2px dashed var(--sidebar-bg);
    pointer-events: none;
    display: none;
}

.preview-container {
    position: relative;
    width: 100%;
    max-width: 300px;
    max-height: 300px;
    overflow: hidden;
    border-radius: 10px;
}
/* ======================================= */
/* === CSS UNTUK TUTORIAL ONBOARDING === */
/* ======================================= */

#onboarding-tutorial {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#onboarding-tutorial.show {
    display: flex;
    opacity: 1;
}

.tutorial-container {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: tutorialPopIn 0.4s ease-out;
}

.tutorial-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 25px;
    background: var(--sidebar-bg);
    color: white;
}

.tutorial-header h3 {
    margin: 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}

#skip-tutorial-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

#skip-tutorial-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.tutorial-content {
    display: flex;
    min-height: 400px;
}

.tutorial-image-side {
    flex: 1;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 30px;
}

.tutorial-image-wrapper {
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.tutorial-image {
    max-width: 100%;
    max-height: 300px;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.tutorial-text-side {
    flex: 1;
    padding: 40px 30px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.tutorial-step-indicator {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 30px;
}

.step-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #ddd;
    transition: all 0.3s;
}

.step-dot.active {
    background: var(--sidebar-bg);
    transform: scale(1.2);
}

.tutorial-text-content {
    margin-bottom: 30px;
    min-height: 150px;
}

.tutorial-title {
    font-size: 22px;
    color: var(--sidebar-bg);
    margin-bottom: 15px;
    font-weight: 600;
}

#tutorial-text {
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    min-height: 80px;
}

#tutorial-text.typing {
    border-right: 2px solid var(--sidebar-bg);
    animation: blinkCursor 0.7s infinite;
}

.tutorial-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

.tutorial-nav-buttons {
    display: flex;
    gap: 10px;
}

.tutorial-btn {
    padding: 10px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

#prev-tutorial-btn {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #ddd;
}

#prev-tutorial-btn:hover:not(:disabled) {
    background: #e9ecef;
}

#prev-tutorial-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#next-tutorial-btn {
    background: var(--sidebar-bg);
    color: white;
}

#next-tutorial-btn:hover {
    background: var(--sidebar-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(95, 75, 139, 0.3);
}

.step-counter {
    color: #666;
    font-size: 14px;
    font-weight: 500;
}

/* Animations */
@keyframes tutorialPopIn {
    from {
        transform: scale(0.9) translateY(20px);
        opacity: 0;
    }
    to {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

@keyframes blinkCursor {
    0%, 50% { border-color: transparent; }
    51%, 100% { border-color: var(--sidebar-bg); }
}

/* Responsive */
@media (max-width: 768px) {
    .tutorial-container {
        width: 95%;
        max-height: 95vh;
    }
    
    .tutorial-content {
        flex-direction: column;
        min-height: auto;
    }
    
    .tutorial-image-side {
        padding: 20px;
        min-height: 200px;
    }
    
    .tutorial-text-side {
        padding: 25px;
    }
    
    .tutorial-title {
        font-size: 20px;
    }
    
    #tutorial-text {
        font-size: 15px;
    }
    
    .tutorial-buttons {
        flex-direction: column;
        gap: 15px;
    }
    
    .step-counter {
        order: 1;
    }
    
    .tutorial-nav-buttons {
        order: 2;
        width: 100%;
        justify-content: space-between;
    }
    
    .tutorial-btn {
        flex: 1;
        justify-content: center;
    }
}
/* ======================================= */
/* === OPTIMIZED MOBILE TUTORIAL CSS === */
/* ======================================= */

/* Responsive untuk tutorial di mobile */
@media (max-width: 768px) {
    .tutorial-container {
        width: 95%;
        max-height: 85vh; /* Lebih kecil dari sebelumnya */
        margin: 10px;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .tutorial-content {
        flex-direction: column;
        min-height: auto;
        max-height: 70vh; /* Batasi tinggi maksimal */
    }
    
    .tutorial-image-side {
        padding: 15px;
        min-height: 180px; /* Kurangi tinggi gambar */
        max-height: 35vh; /* Batasi tinggi gambar */
        flex: 0 0 auto; /* Tidak grow */
    }
    
    .tutorial-image-wrapper {
        max-width: 90%;
        max-height: 150px;
    }
    
    .tutorial-image {
        max-height: 140px;
        object-fit: contain;
    }
    
    .tutorial-text-side {
        padding: 20px;
        flex: 1;
        overflow-y: auto; /* Biarkan bisa discroll jika konten panjang */
        max-height: 50vh; /* Batasi tinggi teks */
    }
    
    .tutorial-title {
        font-size: 18px !important;
        margin-bottom: 10px;
        line-height: 1.3;
    }
    
    #tutorial-text {
        font-size: 14px !important;
        line-height: 1.5;
        max-height: 150px; /* Batasi tinggi teks */
        overflow-y: auto; /* Scroll jika perlu */
        padding-right: 5px;
    }
    
    .tutorial-text-content {
        min-height: 120px; /* Kurangi tinggi minimum */
        margin-bottom: 15px;
    }
    
    .tutorial-step-indicator {
        margin-bottom: 15px;
    }
    
    .tutorial-buttons {
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
    }
    
    .step-counter {
        order: 1;
        font-size: 12px;
        margin-bottom: 5px;
    }
    
    .tutorial-nav-buttons {
        order: 2;
        width: 100%;
        justify-content: space-between;
        gap: 10px;
    }
    
    .tutorial-btn {
        flex: 1;
        justify-content: center;
        padding: 10px 15px;
        font-size: 13px;
        min-width: 120px;
    }
    
    .tutorial-header {
        padding: 12px 20px;
    }
    
    .tutorial-header h3 {
        font-size: 16px;
    }
    
    #skip-tutorial-btn {
        padding: 5px 12px;
        font-size: 13px;
    }
    
    /* Hapus border-right animasi typing di mobile */
    #tutorial-text.typing {
        border-right: none;
        animation: none;
    }
    
    /* Scrollbar styling untuk mobile */
    .tutorial-text-side::-webkit-scrollbar {
        width: 4px;
    }
    
    .tutorial-text-side::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
    }
    
    .tutorial-text-side::-webkit-scrollbar-thumb {
        background: var(--sidebar-bg);
        border-radius: 2px;
    }
}

/* Untuk device yang sangat kecil (iPhone SE dll) */
@media (max-width: 375px) {
    .tutorial-container {
        max-height: 80vh;
        width: 98%;
    }
    
    .tutorial-image-side {
        min-height: 150px;
        padding: 10px;
    }
    
    .tutorial-image {
        max-height: 120px;
    }
    
    .tutorial-text-side {
        padding: 15px;
    }
    
    .tutorial-title {
        font-size: 16px !important;
    }
    
    #tutorial-text {
        font-size: 13px !important;
        max-height: 130px;
    }
    
    .tutorial-btn {
        padding: 8px 12px;
        font-size: 12px;
        min-width: 110px;
    }
}

/* Untuk tablet (768px - 1024px) */
@media (min-width: 769px) and (max-width: 1024px) {
    .tutorial-container {
        max-width: 700px;
        max-height: 80vh;
    }
    
    .tutorial-image {
        max-height: 250px;
    }
    
    .tutorial-text-side {
        padding: 30px;
    }
}

/* Animasi yang lebih smooth untuk mobile */
@keyframes mobileSlideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@media (max-width: 768px) {
    .tutorial-container {
        animation: mobileSlideUp 0.3s ease-out;
    }
}

/* Pastikan modal overlay menutupi seluruh layar */
@media (max-width: 768px) {
    #onboarding-tutorial {
        background-color: rgba(0, 0, 0, 0.9); /* Lebih gelap di mobile */
    }
}

/* Optimasi untuk landscape mode di mobile */
@media (max-width: 768px) and (orientation: landscape) {
    .tutorial-container {
        max-height: 90vh;
        width: 90%;
    }
    
    .tutorial-content {
        flex-direction: row;
        max-height: 70vh;
    }
    
    .tutorial-image-side {
        min-height: 200px;
        max-height: 60vh;
        flex: 0 0 40%;
    }
    
    .tutorial-text-side {
        flex: 0 0 60%;
        max-height: 60vh;
        padding: 20px;
    }
    
    .tutorial-image {
        max-height: 180px;
    }
    
    .tutorial-buttons {
        flex-direction: row;
        gap: 10px;
    }
    
    .step-counter {
        order: 1;
        flex: 1;
    }
    
    .tutorial-nav-buttons {
        order: 2;
        flex: 2;
    }
}

/* Mencegah text overflow yang terlalu panjang */
.tutorial-text-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
}

/* Adjust untuk teks yang terlalu panjang */
#tutorial-text {
    word-break: break-word;
}
/* ======================================= */
/* === CSS DASHBOARD KETUA KELAS === */
/* ======================================= */

#ketua-kelas-content .status-select {
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
    background: white;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

#ketua-kelas-content .status-select:hover {
    border-color: #888;
}

#ketua-kelas-content .status-select:focus {
    outline: none;
    border-color: var(--sidebar-bg);
    box-shadow: 0 0 0 2px rgba(95, 75, 139, 0.2);
}

#ketua-kelas-content .btn-view-signature {
    padding: 5px 10px;
    font-size: 12px;
}

/* Kartu Statistik */
#statistik-kehadiran p {
    margin: 8px 0;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

#statistik-kehadiran p:last-child {
    border-bottom: none;
}

/* Responsive */
@media (max-width: 768px) {
    #ketua-absensi-table {
        min-width: 800px;
    }
    
    .row {
        flex-direction: column;
    }
}
/* ======================================= */
/* === MODAL IKLAN PURE PNG (KOTAK) === */
/* ======================================= */
.ad-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.ad-modal-overlay.show {
    display: flex;
}

.ad-box {
    position: relative;
    width: 90%;
    max-width: 500px; /* Ukuran kotak iklan */
    aspect-ratio: 1 / 1; /* Pastikan 1:1 */
    background: transparent;
}

.ad-box img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
}

.ad-close-icon {
    position: absolute;
    top: -15px;
    right: -15px;
    width: 35px;
    height: 35px;
    background: #fff;
    color: #000;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    z-index: 10000;
}

/* UI Pilihan setelah klik silang */
.ad-options-ui {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 15px;
    width: 280px;
    text-align: center;
    box-shadow: 0 5px 25px rgba(0,0,0,0.5);
}

.ad-options-ui.show {
    display: block;
}

.ad-options-ui p {
    color: #333;
    font-weight: 600;
    margin-bottom: 15px;
}

.ad-opt-btn {
    display: block;
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: 0.2s;
}

.btn-always { background: #eee; color: #333; }
.btn-week { background: #2d2e3c; color: white; }
.ad-opt-btn:hover { opacity: 0.8; }
/* ======================================= */
/* === CSS UNTUK SETTINGS DAN AUTHOR === */
/* ======================================= */

/* PIN Keypad Styles */
.pin-btn, .pin-btn-verify {
    padding: 15px;
    border: none;
    border-radius: 8px;
    background-color: #f8f9fa;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
}

.pin-btn:hover, .pin-btn-verify:hover {
    background-color: #e9ecef;
    transform: scale(1.05);
}

.pin-btn:active, .pin-btn-verify:active {
    transform: scale(0.95);
}

/* File Converter Styles */
.stored-file-item {
    transition: all 0.3s;
}

.stored-file-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.btn-use-file, .btn-delete-file {
    margin-left: 5px;
}

/* Conversion Status */
#conversion-status, #upload-status, #pin-status, #password-change-status {
    min-height: 50px;
}
.sidebar-header {
    width: 100%;
    height: 70px; /* pas untuk header, tidak besar */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 10px;
    box-sizing: border-box;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.sidebar-header-img {
    max-width: 250%;
    max-height: 250%;
    object-fit: contain; /* biar PNG horizontal rapi */
}
/* ======================================= */
/* === CSS UNTUK DROPDOWN SIDEBAR GRUP === */
/* ======================================= */

.menu-group-title.dropdown-toggle {
    cursor: pointer;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 20px;
}

.menu-group-title.dropdown-toggle:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.menu-group-title.dropdown-toggle .dropdown-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.menu-group-title.dropdown-toggle.open .dropdown-icon {
    transform: rotate(180deg);
}

.dropdown-menu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    background-color: rgba(0, 0, 0, 0.1);
}

.dropdown-menu.open {
    max-height: 500px; /* Tinggi cukup untuk menampung semua item */
}

.dropdown-menu .menu-link {
    padding-left: 40px !important; /* Indentasi untuk submenu */
    background-color: rgba(0, 0, 0, 0.05);
}

.dropdown-menu .menu-link:hover {
    background-color: var(--sidebar-hover) !important;
    padding-left: 42px !important; /* Sedikit efek geser saat hover */
}

/* Untuk mobile */
@media (max-width: 768px) {
    .menu-group-title.dropdown-toggle {
        padding: 5px 15px;
    }
    
    .dropdown-menu .menu-link {
        padding-left: 35px !important;
    }
}
/* ============================= */
/* ICON CHEVRON */
/* ============================= */

.dropdown-icon {
    transition: transform 0.35s cubic-bezier(.4,0,.2,1);
    transform: rotate(0deg); /* ke atas */
}

.menu-group-title.open .dropdown-icon {
    transform: rotate(180deg); /* ke bawah */
}

/* ============================= */
/* DROPDOWN ANIMATION */
/* ============================= */

.dropdown-menu {
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transform: translateY(-12px);
    transition:
        max-height 0.45s ease,
        opacity 0.25s ease,
        transform 0.35s ease;
}

/* OPEN */
.dropdown-menu.open {
    max-height: 600px;
    opacity: 1;
    transform: translateY(0);
}

.menu-group-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

/* ikon default: ke atas */
.dropdown-icon {
    transition: transform 0.25s ease;
    transform: rotate(0deg);
}

/* saat dropdown OPEN â†’ ikon ke bawah */
.menu-group-title.open .dropdown-icon {
    transform: rotate(180deg);
}
/* ============================= */
/* ICON CHEVRON ANIMATION */
/* ============================= */

.menu-group-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

/* icon default (ke atas) */
.dropdown-icon {
    transition: transform 0.35s cubic-bezier(.4,0,.2,1);
    transform: rotate(0deg);
}

/* icon saat dropdown terbuka (ke bawah) */
.menu-group-title.open .dropdown-icon {
    transform: rotate(180deg);
}


/* ============================= */
/* DROPDOWN ANIMATION */
/* ============================= */

.menu-group-list {
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transform: translateY(-10px);
    transition:
        max-height 0.45s ease,
        opacity 0.25s ease,
        transform 0.35s ease;
    pointer-events: none;
}

/* saat dropdown terbuka */
.menu-group-list.open {
    max-height: 500px; /* cukup besar */
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

/* ============================= */
/* CLOSING EFFECT (NAIK DULU) */
/* ============================= */

.menu-group-list:not(.open) {
    transform: translateY(-10px);
    opacity: 0;
}
/* ============================= */
/* ICON CHEVRON */
/* ============================= */
.dropdown-icon {
    transition: transform 0.4s cubic-bezier(.4,0,.2,1);
    transform: rotate(0deg);
}

.menu-group-title.open .dropdown-icon {
    transform: rotate(180deg);
}


/* ============================= */
/* DROPDOWN ANIMATION */
/* ============================= */
.dropdown-menu {
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transform: translateY(-14px);
    pointer-events: none;

    transition:
        max-height 0.55s ease,
        opacity 0.35s ease,
        transform 0.55s cubic-bezier(.4,0,.2,1);
}

/* OPEN */
.dropdown-menu.open {
    max-height: 700px;
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

/* CLOSING â€” naik dulu, baru ilang */
.dropdown-menu:not(.open) {
    opacity: 0;
    transform: translateY(-14px);
}
.global-copyright{
    margin-top:35px;
    padding-top:15px;
    text-align:center;
    font-size:13px;
    color:#888;
    border-top:1px solid rgba(255,255,255,0.08);
}
/* =========================================
   TEMA IMLEK - UKURAN BESAR & TENGAH
   ========================================= */

.lampion-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none; /* Klik tetap tembus ke menu */
    z-index: 9999;
    display: flex;
    justify-content: center; 
    align-items: flex-start;
}

/* Tulisan Tengah */
.imlek-text {
    color: #ffd700;
    font-weight: 800;
    font-size: 18px; /* Lebih besar di PC */
    padding-top: 15px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7), 0 0 15px rgba(255, 215, 0, 0.5);
    font-family: 'Arial Black', Gadget, sans-serif;
    white-space: nowrap;
    text-transform: uppercase;
}

/* Base Lampion */
.lampion {
    position: absolute;
    top: -5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: ayunLampion 3s ease-in-out infinite alternate;
    transform-origin: top center;
}

/* Jarak dari tengah */
.lampion-left { left: 20%; }
.lampion-right { right: 20%; }

.tali {
    width: 3px;
    height: 30px;
    background: #ffd700;
}

.bulatan {
    width: 45px;
    height: 40px;
    background: #d40000;
    border-radius: 50%;
    position: relative;
    border: 2px solid #ffcc00;
    box-shadow: 0 0 20px rgba(212, 0, 0, 0.6);
}

.bulatan::after {
    content: '';
    position: absolute;
    top: 0; left: 25%;
    width: 50%; height: 100%;
    border-left: 2px solid rgba(255, 204, 0, 0.5);
    border-right: 2px solid rgba(255, 204, 0, 0.5);
    border-radius: 50%;
}

.rumbai {
    width: 5px;
    height: 18px;
    background: #ffcc00;
    position: absolute;
    bottom: -18px;
    left: 50%;
    transform: translateX(-50%);
    box-shadow: 0 4px 0 #d40000;
}

@keyframes ayunLampion {
    from { transform: rotate(-7deg); }
    to { transform: rotate(7deg); }
}

/* PENYESUAIAN KHUSUS MOBILE (DIBUAT LEBIH GEDE) */
@media (max-width: 768px) {
    .imlek-text {
        font-size: 14px; /* Tetap besar di HP */
        padding-top: 18px;
        letter-spacing: 0.5px;
    }
    
    .lampion-left { left: 10%; } /* Geser agak ke pinggir sedikit agar muat teks */
    .lampion-right { right: 10%; }
    
    .bulatan { 
        width: 38px;  /* Ukuran lampion di HP ditambah */
        height: 34px; 
    }
    
    .tali { 
        height: 25px; 
    }
    
    .lampion { 
        top: -3px; 
    }

    .rumbai {
        height: 15px;
        bottom: -15px;
    }
}
.imlek-text {
    cursor: pointer;
    pointer-events: auto !important; /* Supaya teks bisa diklik walau container-nya none */
    user-select: none; /* Supaya teks tidak ter-block biru saat di-tap */
}
.imlek-png {
    height: 45px; /* Sesuaikan tinggi dengan navbar kamu */
    width: auto;
    padding-top: 5px;
    cursor: pointer;
    pointer-events: auto !important;
    user-select: none;
    transition: transform 0.3s ease, filter 0.3s ease;
    z-index: 10000;
}

/* Efek saat musik menyala (kita pakai filter glow) */
.imlek-png.playing {
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
    transform: scale(1.1);
}

.imlek-png:active {
    transform: scale(0.9);
}

/* Penyesuaian Mobile */
@media (max-width: 768px) {
    .imlek-png {
        height: 35px; /* Sedikit lebih kecil di HP */
        padding-top: 8px;
    }
}
/* Styling Gambar PNG Imlek di Header */
.imlek-png {
    height: 50px; /* Ukuran di PC */
    width: auto;
    padding-top: 5px;
    cursor: pointer;
    pointer-events: auto !important; /* Supaya bisa diklik */
    user-select: none;
    transition: all 0.3s ease;
    z-index: 10000;
    /* Efek bayangan emas halus agar gambar menyatu */
    filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3));
}

/* Efek saat musik menyala (Klik Pertama) */
.imlek-png.playing {
    filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
    transform: scale(1.1);
    animation: pulseGlow 2s infinite;
}

/* Animasi denyut halus saat musik jalan */
@keyframes pulseGlow {
    0% { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.7)); }
    50% { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.9)); }
    100% { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.7)); }
}

/* Penyesuaian KHUSUS MOBILE (Dibuat Lebih Gede) */
@media (max-width: 768px) {
    .imlek-png {
        height: 42px; /* Ukuran di HP (Sudah diperbesar) */
        padding-top: 5px;
        /* Geser posisi sedikit jika nabrak lampion */
        margin: 0 5px; 
    }
}

/* Efek saat ditekan jari */
.imlek-png:active {
    transform: scale(0.9);
}
@import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

/* Overlay Hitam Transparan */
#imlek-overlay-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Hitam transparan */
    z-index: 9998;
    opacity: 0;
    visibility: hidden;
    transition: all 0.5s ease;
}

#imlek-overlay-bg.active {
    opacity: 1;
    visibility: visible;
}

/* Teks Happy Chinese New Year */
.imlek-overlay-text {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.5);
    color: #ffde59;
    font-family: 'Ma Shan Zheng', cursive;
    text-align: center;
    text-shadow: 0 0 20px #ff0000, 0 0 40px #ffde59;
    z-index: 10001;
    pointer-events: none;
    transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    opacity: 0;
    width: 90%; /* Biar gak luber di mobile */
}

.imlek-overlay-text h1 { font-size: 3.5rem; margin: 0; line-height: 1.2; }
.imlek-overlay-text p { font-size: 1.5rem; margin: 0; font-family: sans-serif; font-weight: bold; }

.imlek-overlay-text.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
}

/* Penyesuaian Mobile */
@media (max-width: 768px) {
    .imlek-overlay-text h1 { font-size: 2.2rem; }
    .imlek-overlay-text p { font-size: 1rem; }
}
/* Container Utama */
.ornamen-container-double {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 0; /* Menghindari blokir klik di tengah layar */
    z-index: 999;
    pointer-events: none;
}

/* Style Dasar Item PNG - SEJAJAR PRESISI */
.ornamen-item {
    position: absolute;
    bottom: 0; /* Terkunci di dasar yang sama */
    width: 110px; /* Lebar sama */
    height: 110px; /* Tinggi dikunci sama agar sejajar */
    object-fit: contain; /* Memastikan gambar tidak gepeng tapi tetap dalam kotak yang sama */
    opacity: 0.95;
    filter: drop-shadow(0 0 5px rgba(0,0,0,0.1));
    transition: all 0.3s ease;
}

/* Sisi Kiri */
.kiri {
    left: 0;
    margin-bottom: -35px; /* Angka potong sama */
}

/* Sisi Kanan */
.kanan {
    right: 0;
    margin-bottom: -35px; /* Angka potong sama */
}

/* --- KHUSUS MOBILE --- */
@media (max-width: 768px) {
    .ornamen-item {
        width: 85px; /* Ukuran HP diperkecil sedikit agar tidak sumpek */
        height: 85px; /* Tinggi tetap dikunci sama dengan lebar */
    }
    
    .kiri {
        left: -5px;
        margin-bottom: -25px; /* Potongan di HP sama rata */
    }

    .kanan {
        right: -5px;
        margin-bottom: -25px; /* Potongan di HP sama rata */
    }
}
/* Container Utama */
.ornamen-container-double {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 0;
    z-index: 999;
    pointer-events: none;
}

.ornamen-item {
    position: absolute;
    bottom: 0;
    width: 110px; 
    height: 110px;
    object-fit: contain;
    opacity: 0.95;
    filter: drop-shadow(0 0 5px rgba(0,0,0,0.1));
    transition: all 0.3s ease;
}

/* --- SETTING PC --- */
.kiri {
    /* Geser ke kanan sedikit agar tidak tertutup sidebar */
    left: 260px; 
    margin-bottom: -35px;
}

.kanan {
    right: 20px; /* Kasih jarak sedikit dari pinggir kanan layar */
    margin-bottom: -35px;
}

/* --- SETTING MOBILE (Kembali ke Pojok) --- */
@media (max-width: 768px) {
    .ornamen-item {
        width: 85px;
        height: 85px;
    }
    
    .kiri {
        /* Di mobile sidebar biasanya hilang/tertutup, jadi balikin ke pojok kiri */
        left: -5px; 
        margin-bottom: -25px;
    }

    .kanan {
        right: -5px;
        margin-bottom: -25px;
    }
}
/* Styling untuk status absensi */
.status-hadir {
    color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
}

.status-alpha {
    color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
}

.status-izin {
    color: #856404;
    background-color: rgba(255, 193, 7, 0.2);
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
}

.status-sakit {
    color: #0c5460;
    background-color: rgba(23, 162, 184, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
}

/* Styling untuk select status */
.status-select {
    font-weight: 600;
    padding: 6px 10px;
    border-radius: 4px;
    border: 2px solid #ddd;
    cursor: pointer;
    transition: all 0.3s ease;
}

.status-select:focus {
    outline: none;
    border-color: #5f4b8b;
}

/* Styling untuk input keterangan */
.keterangan-input {
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
    transition: border-color 0.3s;
}

.keterangan-input:focus {
    outline: none;
    border-color: #5f4b8b;
    box-shadow: 0 0 0 2px rgba(95, 75, 139, 0.1);
}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<div class="ornamen-container-double">
    <img src="https://i.imgur.com/IlvvZf9.png" alt="Ornamen Kiri" class="ornamen-item kiri">
    <img src="https://i.imgur.com/St7t4PN.png" alt="Ornamen Kanan" class="ornamen-item kanan">
</div>

<body class="login-mode">
 <div id="ad-modal" class="ad-modal-overlay">
    <div class="ad-box">
        <div class="ad-close-icon" onclick="showAdOptions()">Ã—</div>
        
        <img src="https://i.imgur.com/x3r60hg.png" alt="Informasi">

        <div id="ad-options" class="ad-options-ui">
            <p>Menu Pilihan</p>
            <button class="ad-opt-btn btn-always" onclick="closeAdAndSet(false)">Tampilkan setiap masuk</button>
            <button class="ad-opt-btn btn-week" onclick="closeAdAndSet(true)">Hapus selama 1 minggu</button>
        </div>
    </div>
</div>
    
    <div id="notification-bubble">
        <span id="notification-text">Ini adalah pesan notifikasi!</span>
    </div>

    <div class="login-container" id="auth-container">
        <div class="header-text">
            <h2 id="form-title">Daftar Akun Mahasiswa</h2>
            <p id="form-subtitle">Buat akun dengan NPM dan password untuk masuk.</p>
        </div>
        
        <div class="role-toggle-container" id="role-toggle">
            <button class="role-toggle-button" id="btn-mahasiswa" data-role="Mahasiswa">
                <i class="fas fa-user-graduate"></i> Mahasiswa
            </button>
            <button class="role-toggle-button" id="btn-dosen" data-role="Dosen">
                <i class="fas fa-chalkboard-teacher"></i> Dosen
            </button>
        </div>
        
        <div class="form-wrapper" id="register-form-wrapper">
            <form id="form-register">
                <div class="input-group">
                    <i class="icon fas fa-user"></i> 
                    <input type="text" placeholder="Nama Lengkap" id="register-name-input" required>
                </div>
                <div class="input-group">
                    <i class="icon fas fa-id-badge" id="register-id-icon"></i> 
                    <input type="text" placeholder="NPM (Nomor Pokok Mhs)" id="register-id-input" required>
                </div>
                <div class="input-group">
                    <i class="icon fas fa-lock"></i>
                    <input type="password" placeholder="Buat Password Baru" id="register-password-input" required>
                </div>
                <button type="submit" class="btn-submit">Daftar Akun</button>
            </form>
        </div>

        <div class="form-wrapper hidden" id="login-form-wrapper">
            <form id="form-login">
                <div class="input-group">
                    <i class="icon fas fa-id-badge" id="login-id-icon"></i> 
                    <input type="text" placeholder="NPM (Nomor Pokok Mhs) / NIDN Dosen" id="login-id-input" required>
                </div>
                <div class="input-group">
                    <i class="icon fas fa-lock"></i>
                    <input type="password" placeholder="Password" id="login-password-input" required>
                </div>
                <div class="options">
                    <label>
                        <!-- ID DITAMBAHKAN di sini -->
                        <input type="checkbox" name="remember-me" id="remember-me-checkbox">
                        Remember me
                    </label>
                    <!-- ID DITAMBAHKAN di sini -->
                    <a href="#" id="forgot-password-link">Forgot Password?</a>
                </div>
                <button type="submit" class="btn-submit">Sign In</button>
            </form>
        </div>
        
        <div class="switch-mode" id="switch-text">
            Sudah punya akun? <a href="#" id="switch-link">Masuk Sekarang</a>
        </div>
    </div>

    
    <div id="dashboard-wrapper">
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="https://i.imgur.com/6vLWn9I.png" alt="Dashboard Mahasiswa" class="sidebar-header-img">
    </div>

    <ul class="sidebar-menu">
        <div class="main-menu-items">
            
            <!-- GRUP UTAMA: ABSENSI DAN PROFIL -->
            <div class="menu-group">
                <div class="menu-group-title dropdown-toggle" data-target="mahasiswa-group">
                    <i class="fas fa-chalkboard-teacher"></i> MAHASISWA
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </div>
                <div class="dropdown-menu" id="mahasiswa-group">
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="info-update-website">
                            <i class="fas fa-bullhorn"></i> Berita Kelas
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="user-content">
                            <i class="fas fa-user"></i> User Profile
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="settings-content">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                    </li>
                </div>
            </div>
            
            <!-- GRUP ABSENSI -->
            <div class="menu-group">
                <div class="menu-group-title dropdown-toggle" data-target="absensi-group">
                    <i class="fas fa-file-alt"></i> ABSENSI
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </div>
                <div class="dropdown-menu" id="absensi-group">
                    <li class="menu-item">
                        <a href="#" class="menu-link active" data-content-id="mahasiswa-list-content">
                            <i class="fas fa-users"></i> Absen Mahasiswa
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="absen-log-content">
                            <i class="fas fa-history"></i> Riwayat Absensi
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="pdf-absensi-content">
                            <i class="fas fa-file-pdf"></i> Cetak Absen
                        </a>
                    </li>
                </div>
            </div>
            
            <!-- GRUP KOMUNIKASI -->
            <div class="menu-group">
                <div class="menu-group-title dropdown-toggle" data-target="komunikasi-group">
                    <i class="fas fa-comments"></i> Komunikasi
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </div>
                <div class="dropdown-menu" id="komunikasi-group">
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="chat-content">
                            <i class="fas fa-comments"></i> Chat Kelas
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="https://sisteminformasi-zoom.netlify.app/" target="_blank">
                            <i class="fas fa-video"></i> Zoom Mahasiswa
                        </a>
                    </li>
                </div>
            </div>
            
            <!-- GRUP DASHBOARD KETUA KELAS (HANYA NPM 15125033) -->
            <div class="menu-group" id="ketua-kelas-group" style="display: none;">
                <div class="menu-group-title dropdown-toggle" data-target="ketua-group">
                    <i class="fas fa-user-tie"></i> DASHBOARD SIPEN
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </div>
                <div class="dropdown-menu" id="ketua-group">
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="ketua-kelas-content">
                            <i class="fas fa-desktop"></i> Edit Absensi Mahasiswa
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="ketua-kelas-laporan">
                            <i class="fas fa-chart-bar"></i> Laporan Kehadiran
                        </a>
                    </li>
                </div>
            </div>
            
            <!-- GRUP BANTUAN -->
            <div class="menu-group">
                <div class="menu-group-title dropdown-toggle" data-target="bantuan-group">
                    <i class="fas fa-question-circle"></i> Panduan
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </div>
                <div class="dropdown-menu" id="bantuan-group">
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="panduan-content">
                            <i class="fas fa-gavel"></i> Peraturan
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" id="show-tutorial-btn">
                            <i class="fas fa-clipboard-list"></i> Panduan
                        </a>
                    </li>
                </div>
            </div>
            
            <!-- GRUP PERKULIAHAN -->
            <div class="menu-group">
                <div class="menu-group-title dropdown-toggle" data-target="perkuliahan-group">
                    <i class="fas fa-cloud-upload-alt"></i> PERKULIAHAN
                    <i class="fas fa-chevron-down dropdown-icon"></i>
                </div>
                <div class="dropdown-menu" id="perkuliahan-group">
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="module-content">
                            <i class="fas fa-upload"></i> Upload Tugas
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-content-id="jadwal-content">
                            <i class="fas fa-calendar-alt"></i> Jadwal Matakuliah
                        </a>
                    </li>
                </div>
            </div>
        </div>

        <!-- Tombol Logout di Sidebar (Mobile/Bawah) -->
        <div class="sidebar-footer">
            <button id="logout-sidebar-button">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </ul>
</div>
   
        
        <div class="main-content" id="main-content">
            
            <div class="navbar">
          <div class="lampion-container">
    <div class="lampion lampion-left">
        <div class="tali"></div>
        <div class="bulatan"><div class="rumbai"></div></div>
    </div>

    <img src="https://i.imgur.com/hnQBRQc.png" alt="Xin Nian Kuai Le" class="imlek-png" id="imlekBtn">

    <div class="lampion lampion-right">
        <div class="tali"></div>
        <div class="bulatan"><div class="rumbai"></div></div>
    </div>
</div>
                <div class="navbar-left">
                    <span class="hamburger-wrapper" id="hamburger-menu">
                         <i class="fas fa-bars hamburger-menu"></i>
                    </span>
                    <div class="breadcrumb" id="breadcrumb">
                        <a href="#">Home</a> <span>/</span>Absen Mahasiswa
                    </div>
                </div>
                <div class="navbar-right">
                    <button id="logout-button-desktop" style="display: none;"><i class="fas fa-sign-out-alt"></i> Logout</button>
                    <!-- PENAMBAHAN: Tambahkan ID ke user-info agar mudah diklik -->
                    <div class="user-info" id="navbar-user-info-link"> 
                        <!-- PERUBAHAN FOTO PROFIL: Menggunakan default baru BVVboCP.png -->
                        <img src="https://i.imgur.com/BVVboCP.png" alt="User Avatar"> 
                    </div>
                </div>
            </div>
            <div id="chat-context-menu">
    <ul>
        <li id="ctx-reply"><i class="fas fa-reply"></i> Balas Pesan</li>
        <li id="ctx-delete-self"><i class="fas fa-trash-alt"></i> Hapus untuk saya</li>
        <li id="ctx-delete-all" class="menu-separator"><i class="fas fa-trash-restore"></i> Hapus untuk semua orang</li>
    </ul>
</div>
            
            <div class="page-content">
                <!-- ===== KONTEN SETTINGS ===== -->
<div class="content-section" id="settings-content">
    <div class="content-card">
        <h3><i class="fas fa-cog"></i> Settings</h3>
        
        <!-- Ubah Password Section -->
        <div class="change-password-section" style="margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;">
            <h4><i class="fas fa-key"></i> Ubah Password</h4>
            <div class="select-group">
                <label for="current-password">Password Saat Ini:</label>
                <input type="password" id="current-password" placeholder="Masukkan password saat ini">
            </div>
            <div class="select-group">
                <label for="new-password">Password Baru:</label>
                <input type="password" id="new-password" placeholder="Masukkan password baru (min. 6 karakter)">
            </div>
            <div class="select-group">
                <label for="confirm-password">Konfirmasi Password Baru:</label>
                <input type="password" id="confirm-password" placeholder="Ulangi password baru">
            </div>
            <button class="btn-action btn-primary" id="btn-change-password">
                <i class="fas fa-save"></i> Simpan Password Baru
            </button>
            <div id="password-change-status" style="margin-top: 10px;"></div>
        </div>
        
        <!-- PIN Verification Section -->
        <div class="pin-verification-section" style="padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;">
            <h4><i class="fas fa-shield-alt"></i>Verification (2FA)</h4>
            <p style="color: #666; margin-bottom: 15px;">Dalam tahap pengembangan. Belum tersedia untuk pengguna.</p>
            
            <div class="select-group">
                <label for="enable-pin-toggle">SEGERA HADIR</label>
                
                </label>
            </div>
            
            <!-- PIN Setup UI -->
            <div id="pin-setup-container" style="display: none; margin-top: 20px;">
                <h5>Atur PIN 6 Digit</h5>
                <div id="pin-display" style="display: flex; justify-content: center; gap: 10px; margin: 20px 0;">
                    <div class="pin-digit" style="width: 40px; height: 40px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 36px; font-size: 20px; font-weight: bold;"></div>
                    <div class="pin-digit" style="width: 40px; height: 40px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 36px; font-size: 20px; font-weight: bold;"></div>
                    <div class="pin-digit" style="width: 40px; height: 40px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 36px; font-size: 20px; font-weight: bold;"></div>
                    <div class="pin-digit" style="width: 40px; height: 40px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 36px; font-size: 20px; font-weight: bold;"></div>
                    <div class="pin-digit" style="width: 40px; height: 40px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 36px; font-size: 20px; font-weight: bold;"></div>
                    <div class="pin-digit" style="width: 40px; height: 40px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 36px; font-size: 20px; font-weight: bold;"></div>
                </div>
                
                <!-- Keypad -->
                <div id="pin-keypad" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 200px; margin: 0 auto;">
                    <button class="pin-btn" data-number="1">1</button>
                    <button class="pin-btn" data-number="2">2</button>
                    <button class="pin-btn" data-number="3">3</button>
                    <button class="pin-btn" data-number="4">4</button>
                    <button class="pin-btn" data-number="5">5</button>
                    <button class="pin-btn" data-number="6">6</button>
                    <button class="pin-btn" data-number="7">7</button>
                    <button class="pin-btn" data-number="8">8</button>
                    <button class="pin-btn" data-number="9">9</button>
                    <button class="pin-btn" style="grid-column: 1/3;" data-action="clear">Clear</button>
                    <button class="pin-btn" data-number="0">0</button>
                    <button class="pin-btn" data-action="backspace"><i class="fas fa-backspace"></i></button>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn-action btn-primary" id="btn-save-pin" disabled>
                        <i class="fas fa-check"></i> Simpan PIN
                    </button>
                    <button class="btn-action btn-secondary" id="btn-cancel-pin">
                        Batal
                    </button>
                </div>
            </div>
            
            <div id="pin-status" style="margin-top: 15px;"></div>
        </div>
    </div>
</div>

<!-- ===== KONTEN AUTHOR ===== -->
<div class="content-section" id="author-content">
    <div class="content-card">
        <h3><i class="fas fa-user-edit"></i> File Converter</h3>
        <p>Ubah file dari satu format ke format lainnya / relog website jika telah menyelesaikan proses konversi.</p>
        
        <div class="converter-container" style="margin-top: 20px;">
            <!-- File Upload Section -->
            <div class="upload-section" style="margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h4><i class="fas fa-upload"></i> Upload File</h4>
                <div class="select-group">
                    <label for="converter-file-input">Pilih File:</label>
                    <input type="file" id="converter-file-input" accept=".txt,.pdf,.xlsx,.xls,.csv,.doc,.docx">
                    <small style="color: #666;">Mendukung beberapa format file.</small>
                </div>
                
                <div id="file-preview" style="margin-top: 15px; display: none;">
                    <h5>File Info:</h5>
                    <p><strong>Nama:</strong> <span id="file-name">-</span></p>
                    <p><strong>Ukuran:</strong> <span id="file-size">-</span></p>
                    <p><strong>Format:</strong> <span id="file-format">-</span></p>
                </div>
                
                <button class="btn-action btn-primary" id="btn-upload-converter" style="margin-top: 15px;">
                    <i class="fas fa-cloud-upload-alt"></i> Upload ke Local Storage
                </button>
                <div id="upload-status" style="margin-top: 10px;"></div>
            </div>
            
            <!-- Conversion Section -->
            <div class="conversion-section" style="padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h4><i class="fas fa-exchange-alt"></i> Konversi File</h4>
                
                <div class="select-group">
                    <label for="source-format">Format Sumber:</label>
                    <select id="source-format" class="form-control">
                        <option value="">Pilih format</option>
                        <option value="txt">TXT (Plain Text)</option>
                        <option value="pdf">PDF</option>
                        <option value="xlsx">Excel (XLSX)</option>
                        <option value="csv">CSV</option>
                        <option value="docx">Word (DOCX)</option>
                    </select>
                </div>
                
                <div class="select-group">
                    <label for="target-format">Konversi ke:</label>
                    <select id="target-format" class="form-control">
                        <option value="">Pilih format tujuan</option>
                        <option value="txt">TXT (Plain Text)</option>
                        <option value="pdf">PDF</option>
                        <option value="xlsx">Excel (XLSX)</option>
                        <option value="csv">CSV</option>
                        <option value="docx">Word (DOCX)</option>
                    </select>
                </div>
                
                <button class="btn-action btn-primary" id="btn-convert-file" disabled style="margin-top: 20px;">
                    <i class="fas fa-sync-alt"></i> Konversi File
                </button>
                
                <!-- Download Section -->
                <div id="download-section" style="margin-top: 20px; display: none; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                    <h5><i class="fas fa-download"></i> File Hasil Konversi</h5>
                    <p>File berhasil dikonversi. Klik tombol di bawah untuk mendownload.</p>
                    <button class="btn-action btn-success" id="btn-download-converted">
                        <i class="fas fa-file-download"></i> Download File
                    </button>
                    <div id="converted-info" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                </div>
                
                <div id="conversion-status" style="margin-top: 15px;"></div>
            </div>
            
            <!-- Stored Files List -->
            <div class="stored-files-section" style="margin-top: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;">
                <h4><i class="fas fa-database"></i> File dalam Local Storage</h4>
                <div id="stored-files-list">
                    <!-- File list akan ditampilkan di sini -->
                </div>
                <button class="btn-action btn-secondary" id="btn-clear-storage">
                    <i class="fas fa-trash"></i> Hapus Semua File
                </button>
            </div>
        </div>
    </div>
</div>
                <!-- ===== KONTEN DASHBOARD KETUA KELAS ===== -->
<div class="content-section" id="ketua-kelas-content">
    <div class="content-card">
        <h3><i class="fas fa-user-tie"></i> Dashboard Ketua Kelas</h3>
        
        <!-- Filter Tanggal -->
        <div class="pdf-controls">
            <div class="select-group">
                <label for="ketua-filter-date"><i class="fas fa-calendar-day"></i> Pilih Tanggal:</label>
                <input type="date" id="ketua-filter-date" class="form-control" value="<?php echo date('Y-m-d'); ?>">
            </div>
            
            <div class="select-group">
                <label for="ketua-filter-matkul"><i class="fas fa-book"></i> Pilih Mata Kuliah:</label>
                <select id="ketua-filter-matkul" class="form-control">
                    <option value="">Semua Mata Kuliah</option>
                <option value="Sistem Informasi Manajemen">Sistem Informasi Manajemen</option>
<option value="Matematika Diskrit">Matematika Diskrit</option>
<option value="Konsep Basis Data">Konsep Basis Data</option>
<option value="Kewirausahaan">Kewirausahaan</option>
<option value="Pendidikan Anti Korupsi">Pendidikan Anti Korupsi</option>
<option value="Pancasila">Pancasila</option>
<option value="Statistika dan Probabilitas">Statistika dan Probabilitas</option>
<option value="Sistem Operasi">Sistem Operasi</option>
<option value="Hima Prodi">Hima Prodi</option>
</select>

           
            </div>
            
            <div class="select-group">
                <label>&nbsp;</label>
                <button class="btn-action btn-secondary" id="btn-load-absensi-ketua">
                    <i class="fas fa-search"></i> Muat Data Absensi
                </button>
            </div>
        </div>
        
        <!-- Tabel Data Absensi -->
        <div id="ketua-absensi-table-container" style="margin-top: 20px; display: none;">
            <h4><i class="fas fa-list-check"></i> Data Absensi Mahasiswa</h4>
            <div class="table-responsive">
                <table class="data-table" id="ketua-absensi-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>NPM</th>
                            <th>Nama</th>
                            <th>Mata Kuliah</th>
                            <th>Status</th>
                            <th>Keterangan</th>
                            <th>Waktu Absen</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="ketua-absensi-table-body">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Tombol Simpan Perubahan -->
            <div class="action-bar" style="margin-top: 20px; justify-content: flex-end;">
                <button class="btn-action btn-primary" id="btn-save-changes" style="display: none;">
                    <i class="fas fa-save"></i> Simpan Perubahan
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="ketua-loading-state" style="display: none; text-align: center; padding: 40px;">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="sr-only">Loading...</span>
            </div>
            <p style="margin-top: 15px; color: #555;">Memuat data absensi...</p>
        </div>
        
        <!-- Empty State -->
        <div id="ketua-empty-state" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-file-excel" style="font-size: 48px; color: #6c757d;"></i>
            <h4 style="margin-top: 15px; color: #6c757d;">Belum Ada Data</h4>
            <p>Pilih tanggal dan mata kuliah untuk melihat data absensi.</p>
        </div>
    </div>
</div>

<!-- KONTEN LAPORAN -->
<div class="content-section" id="ketua-kelas-laporan">
    <div class="content-card">
        <h3><i class="fas fa-chart-bar"></i> Laporan Kehadiran Kelas</h3>
        <p>Statistik kehadiran mahasiswa per mata kuliah.</p>
        
        <!-- Filter Laporan -->
        <div class="pdf-controls">
            <div class="select-group">
                <label for="laporan-bulan"><i class="fas fa-calendar-alt"></i> Pilih Bulan:</label>
                <input type="month" id="laporan-bulan" class="form-control" value="<?php echo date('Y-m'); ?>">
            </div>
            
            <div class="select-group">
                <label>&nbsp;</label>
                <button class="btn-action btn-secondary" id="btn-generate-laporan">
                    <i class="fas fa-chart-pie"></i> Generate Laporan
                </button>
            </div>
        </div>
        
        <!-- Grafik/Statistik -->
        <div id="laporan-container" style="margin-top: 20px; display: none;">
            <div class="row" style="display: flex; flex-wrap: wrap; gap: 20px;">
                <!-- Kartu Statistik -->
                <div class="content-card" style="flex: 1; min-width: 300px;">
                    <h5><i class="fas fa-users"></i> Statistik Kehadiran</h5>
                    <div id="statistik-kehadiran">
                        <!-- Akan diisi JavaScript -->
                    </div>
                </div>
                
                <!-- Grafik -->
                <div class="content-card" style="flex: 2; min-width: 300px;">
                    <h5><i class="fas fa-chart-line"></i> Grafik Kehadiran</h5>
                    <canvas id="kehadiran-chart" height="250"></canvas>
                </div>
            </div>
            
            <!-- Tabel Detail -->
            <div class="content-card" style="margin-top: 20px;">
                <h5><i class="fas fa-table"></i> Detail Per Mahasiswa</h5>
                <div class="table-responsive">
                    <table class="data-table" id="detail-laporan-table">
                        <thead>
                            <tr>
                                <th>NPM</th>
                                <th>Nama</th>
                                <th>Hadir</th>
                                <th>Alpha</th>
                                <th>Izin</th>
                                <th>Sakit</th>
                                <th>Persentase</th>
                            </tr>
                        </thead>
                        <tbody id="detail-laporan-body">
                            <!-- Akan diisi JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
        
            
                <!-- Konten Daftar Mahasiswa (Mahasiswa List) -->
                <div class="content-section active" id="mahasiswa-list-content">
                    <div class="content-card">
                        <h3>Absen Kelas Pagi</h3>
                        
                        <!-- 
                          PERUBAHAN LOGIKA ABSENSI:
                          Kontrol Dosen (Buka/Tutup Absen) telah DIHAPUS.
                          Sistem absensi sekarang berjalan OTOMATIS berdasarkan jam.
                          Area ini akan menampilkan status sesi otomatis (misal: "Absen Terbuka", "Kelas Berakhir", "Countdown")
                        -->
                        
                        <!-- Kontrol Dosen / Tabel Mahasiswa akan dirender di sini -->
                        <div id="mahasiswa-content-wrapper">
                            <!-- Konten dimuat oleh JavaScript -->
                        </div>
                        
                    </div>
                </div>
                
                <!-- Konten User Profile (Public View dan Private Edit View) -->
                <div class="content-section" id="user-content">
                    <div class="content-card profile-card">
                        
                        <!-- PERUBAHAN FOTO PROFIL: Default src diubah ke BVVboCP.png -->
                        <img src="https://i.imgur.com/BVVboCP.png" alt="User Profile Picture" id="profile-pic-img" style="cursor: pointer;" title="Klik untuk ganti foto"> 
                        
                        <div class="profile-header">
                            <h4 id="profile-name">Nama Pengguna</h4>
                            <p id="profile-role">Peran / Jurusan</p>
                            <!-- EXP Bar Baru -->
                            <div style="font-size: 14px; color: #555; margin-top: 5px;">
                                Level: <strong id="profile-level">1</strong> (EXP: <span id="profile-exp">0</span> / 100)
                                <div class="exp-bar">
                                    <div class="exp-bar-fill" id="profile-exp-bar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="profile-info">
                            <div class="data-item">
                                <strong id="id-label"><i class="fas fa-id-card"></i> Nomor ID</strong>
                                <span id="profile-id">ID Pengguna</span>
                            </div>
                            <!-- Email dipertahankan di sini, tapi dihilangkan di Public Profile Modal -->
                            <div class="data-item">
                                <strong><i class="fas fa-envelope"></i> Email Aktif</strong>
                                <span id="profile-email">email@example.com</span> 
                            </div>
                            <div class="data-item">
                                <strong id="role-dependent-stat"><i class="fas fa-clipboard-list"></i> Jumlah Kehadiran Mengajar</strong>
                                <span id="profile-tasks">0</span>
                            </div>
                            <div class="data-item">
                                <strong><i class="fas fa-calendar-alt"></i> Status</strong>
                                <span>Aktif</span>
                            </div>
                            <div class="data-item">
                                <strong><i class="fas fa-cog"></i> Pengaturan Akun</strong>
                                <span>Edit Profile</span>
                            </div>
                        </div>
                        
                        <div class="profile-action">
                            <button class="btn-action btn-secondary" id="btn-edit-email">
                                <i class="fas fa-edit"></i> Edit Email
                            </button>
                            <!-- Tambahkan di dalam div class="profile-action" -->
<button class="btn-action btn-delete" id="btn-delete-photo" style="margin-left: 10px;">
    <i class="fas fa-trash"></i> Hapus Foto
</button>
                            <!-- TOMBOL BARU UNTUK UPDATE FOTO DENGAN URL -->
                            <button class="btn-action btn-primary" id="btn-update-photo-url" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Ganti Foto Profile
                            </button>
                        </div>
                    </div>
                </div>
                
            
                <!-- Konten Upload Tugas (MAHASISWA VIEW) / Daftar Tugas (DOSEN VIEW) -->
                <div class="content-section" id="module-content">
                    <!-- Area ini akan diisi secara dinamis oleh JavaScript -->
                    <div class="content-card" id="module-card">
                        <!-- Konten akan dimuat di sini -->
                    </div>
                </div>
                
                <!-- Konten Chat Realtime BARU -->
                 <div class="content-section" id="chat-content">
                    <div class="content-card">
                        <h3><i class="fas fa-comments"></i> Chat Kelas Sistem Informasi</h3>
                         <div id="chat-container">
                            <div id="chat-messages">
                                <!-- Pesan akan dimuat di sini -->
                            </div>
                            <div class="chat-input-area">
                                
                                <div id="typing-indicator"></div>
                                <div id="reply-preview">
                                    <button id="cancel-reply-btn"><i class="fas fa-times"></i></button>
                                    <div class="reply-sender" id="reply-sender-name"></div>
                                    <div class="reply-text" id="reply-quoted-text"></div>
                                </div>
                                <div class="chat-input-wrapper">
                                    <input type="text" id="chat-input" placeholder="Ketik pesan..." maxlength="100">
                                    <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- KONTEN PANDUAN MAHASISWA BARU -->
                   <div class="content-section" id="panduan-content">
                    <div class="content-card">
                        <h3><i class="fas fa-list-alt"></i> PERATURAN KELAS</h3>
                        <p>Semua peraturan di bawah wajib! di patuhi oleh seluruh mahasiswa dan dosen.</p>
                        
                        <!-- Accordion Wrapper -->
                        <div class="accordion-container" style="margin-top: 20px;">
                            
                 <div class="accordion-item">
    <button class="accordion-header">
        <span>KEHADIRAN</span>
        <i class="fas fa-chevron-down"></i>
    </button>
    <div class="accordion-content">
        <p>1. Mahasiswa wajib menghadiri mata kuliah sesuai jadwal yang telah ditentukan.</p>
        <p>2. Dosen wajib melaksanakan kelas sesuai jadwal online maupun offline.</p>
        <p>3. Dosen yang berhalangan hadir wajib memberikan informasi sebelum kelas dimulai.</p>
        <p>4. Mahasiswa yang tidak dapat hadir wajib memberi pemberitahuan sebelum sesi kelas berlangsung.</p>
        <p>5. Absensi wajib diisi sesuai ketentuan kelas.</p>
    </div>
</div>

<div class="accordion-item">
    <button class="accordion-header">
        <span>ATURAN PENGUMPULAN TUGAS</span>
        <i class="fas fa-chevron-down"></i>
    </button>
    <div class="accordion-content">
        <p>1. Mahasiswa wajib mengumpulkan tugas sebelum batas waktu yang ditentukan.</p>
        <p>2. Tugas yang terlambat berpotensi tidak dinilai sesuai kebijakan dosen.</p>
        <p>3. File tugas wajib sesuai format yang diminta dosen pengampu.</p>
        <p>4. Dilarang mengunggah file kosong, rusak, atau tidak sesuai dengan tugas.</p>
        <p>5. Segala kesalahan pengiriman menjadi tanggung jawab mahasiswa.</p>
        <p>6. Plagiarisme atau kecurangan akademik akan dikenakan sanksi.</p>
    </div>
</div>

<div class="accordion-item">
    <button class="accordion-header">
        <span>PERATURAN WAJIB DISETUJUI MAHASISWA</span>
        <i class="fas fa-chevron-down"></i>
    </button>
    <div class="accordion-content">
        <p>1. Mahasiswa wajib menjaga etika komunikasi di dalam sistem.</p>
        <p>2. Dilarang mengirim spam, ujaran kebencian, atau konten tidak pantas.</p>
        <p>3. Setiap aktivitas akun merupakan tanggung jawab pemilik akun.</p>
        <p>4. Dilarang membagikan akses akun kepada pihak lain.</p>
        <p>5. Wajib mengikuti seluruh kebijakan akademik yang berlaku.</p>
        <p>6. Pelanggaran dapat menyebabkan pembatasan atau pemblokiran akun.</p>
    </div>
</div>

<div class="accordion-item">
    <button class="accordion-header">
        <span>KETENTUAN PENGGUNAAN SISTEM</span>
        <i class="fas fa-chevron-down"></i>
    </button>
    <div class="accordion-content">
        <p>1. Sistem hanya digunakan untuk keperluan akademik resmi.</p>
        <p>2. Data yang diinput wajib benar dan dapat dipertanggungjawabkan.</p>
        <p>3. Semua aktivitas dapat direkam sebagai log sistem.</p>
        <p>4. Admin berhak menghapus konten yang melanggar aturan.</p>
        <p>5. Dengan menggunakan sistem, mahasiswa dianggap menyetujui semua ketentuan.</p>
    </div>
</div>


                        </div>
                    </div>
                </div>

                <!-- KONTEN JADWAL MATKUL BARU -->
                <div class="content-section" id="jadwal-content">
                    <div class="content-card">
                        <h3><i class="fas fa-calendar-alt"></i> Jadwal Mata Kuliah Reguler</h3>
                        <!-- PERUBAHAN: Teks disesuaikan -->
                        <p>Jadwal ini adalah jadwal tetap yang digunakan oleh sistem absensi otomatis.</p>
                        
                        <!-- Kontainer untuk tabel jadwal -->
                        <div id="schedule-display-container" style="margin-top: 20px;">
                            <!-- Jadwal akan dirender oleh JavaScript di sini -->
                        </div>
                    </div>
                </div>

                <!-- ===== PERUBAHAN BARU: KONTEN LOG ABSENSI ===== -->
                <div class="content-section" id="absen-log-content">
                    <div class="content-card">
                        <h3><i class="fas fa-history"></i> Riwayat Lengkap Absensi Kelas</h3>
                        <p>Halaman ini menampilkan seluruh riwayat absensi mahasiswa (Hadir & Tidak Hadir) berdasarkan jadwal mata kuliah yang telah ditentukan.</p>
                        
                        <!-- Kontainer untuk log -->
                        <div id="absen-log-container" style="margin-top: 20px;">
                            <!-- Log akan dirender oleh JavaScript di sini -->
                        </div>
                    </div>
                </div>
  <div class="content-section" id="info-update-website">
    <div class="content-card">
        <h3>
            <i class="fas fa-newspaper"></i> News
        </h3>
        
        <p>
            We Are Sistem Informasi
            Transforming Data into Decisions, and Vision into Reality. <img src="https://cdn-icons-gif.flaticon.com/16767/16767287.gif" alt="zoom" style="width: 20px; vertical-align: bottom;"> 
   <div class="news-video-wrapper">
    <img src="https://i.imgur.com/HiqXMi8.jpeg" alt="Sistem Informasi Nih Bang" class="news-video" style="width: 100%; height: auto; border-radius: 8px;">
</div>
 <img src="https://i.imgur.com/6CvihyL.jpeg" alt="Sistem Informasi Nih Bang" class="news-video" style="width: 100%; height: auto; border-radius: 8px;">
</div>

        
    </div>
</div>

            <!-- KONTEN BARU: Tanda Tangan Dosen & Laporan PDF -->
<div class="content-section" id="pdf-absensi-content">
    <div class="content-card">
        <h3><i class="fas fa-file-signature"></i>Laporan PDF absensi kelas pagi</h3>
    
        <!-- Kontrol untuk memilih tanggal & matkul -->
        <div class="pdf-controls">
            <div class="select-group">
                <label for="pdf-select-date"><i class="fas fa-calendar-day"></i> Pilih Tanggal:</label>
                <input type="date" id="pdf-select-date" class="form-control">
            </div>
            
            <div class="select-group">
                <label for="pdf-select-matkul"><i class="fas fa-book"></i> Pilih Mata Kuliah:</label>
                <select id="pdf-select-matkul" class="form-control">
                    <option value="">Pilih tanggal terlebih dahulu</option>
                </select>
            </div>
            
            <div class="select-group">
                <label>&nbsp;</label>
                <button class="btn-action btn-secondary" id="btn-load-absensi-data">
                    <i class="fas fa-search"></i> Muat Data Absensi
                </button>
            </div>
        </div>
        
        <!-- Preview Data Absensi -->
        <div id="pdf-preview-absensi" style="display: none;">
            <h4><i class="fas fa-list-check"></i> Preview Data Absensi</h4>
            <div class="table-responsive">
                <table class="data-table" id="pdf-preview-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>NPM</th>
                            <th>Nama</th>
                            <th>Status</th>
                            <th>Keterangan</th> 
                            <th>Waktu Absen</th>
                        </tr>
                    </thead>
                    <tbody id="pdf-preview-table-body">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Info Summary -->
            <div id="pdf-summary-info" style="margin-top: 15px; padding: 10px; background-color: #f0f8ff; border-radius: 5px;">
                <p style="margin: 0; color: #555;">
                    <strong>Total Mahasiswa:</strong> <span id="total-mahasiswa">0</span> | 
                    <strong>Hadir:</strong> <span id="total-hadir">0</span> | 
                    <strong>Tanpa Ket:</strong> <span id="total-tidak-hadir">0</span>
                </p>
            </div>
            
            <!-- Section Tanda Tangan Dosen -->
            <div class="pdf-signature-section" id="dosen-signature-section">
                <h4><i class="fas fa-signature"></i> Tanda Tangan Dosen Pengampu</h4>
                <p>Gunakan area di bawah untuk membuat tanda tangan digital. Tanda tangan ini akan muncul di PDF laporan absensi.</p>
                
                <div class="signature-canvas-container">
                    <canvas id="dosen-signature-canvas" width="400" height="150"></canvas>
                    
                    <div class="signature-actions">
                        <button class="btn-action btn-secondary" id="btn-clear-dosen-signature">
                            <i class="fas fa-trash"></i> Hapus Tanda Tangan
                        </button>
                        <button class="btn-action btn-primary" id="btn-save-dosen-signature">
                            <i class="fas fa-save"></i> Simpan Tanda Tangan
                        </button>
                    </div>
                </div>
                
                <!-- Preview Tanda Tangan yang Tersimpan -->
                <div id="dosen-signature-preview" style="display: none; margin-top: 20px;">
                    <h5><i class="fas fa-check-circle"></i> Tanda Tangan Tersimpan</h5>
                    <img id="dosen-signature-image" src="" alt="Tanda Tangan Dosen" style="max-width: 200px; border: 1px solid #ccc; padding: 5px;">
                    <p style="color: #28a745; margin-top: 10px;">
                        <i class="fas fa-check"></i> Tanda tangan tersimpan dan siap untuk PDF
                    </p>
                </div>
            </div>
            
            <!-- Status Message -->
            <div class="pdf-status" id="pdf-status-message"></div>
            
            <!-- Section Download PDF -->
            <div class="pdf-download-section">
                <h4><i class="fas fa-file-download"></i> Download Laporan PDF</h4>
                <p>PDF BERHASIL DIMUAT</p>
                
                <button class="btn-action btn-primary" id="btn-generate-pdf" style="padding: 12px 25px; font-size: 16px;">
                    <i class="fas fa-file-pdf"></i> Generate & Download PDF
                </button>
                
                <p style="margin-top: 15px; font-size: 14px; color: #666;">
                    <i class="fas fa-info-circle"></i> PDF akan berisi: 
                    <br>1. Data absensi lengkap 
                    <br>2. Tanda tangan dosen 
                    <br>3. Informasi mata kuliah dan tanggal
                </p>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="pdf-loading-state" style="display: none; text-align: center; padding: 40px;">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="sr-only">Loading...</span>
            </div>
            <p style="margin-top: 15px; color: #555;">Memuat data absensi...</p>
        </div>
        
        <!-- Empty State -->
        <div id="pdf-empty-state" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-file-excel" style="font-size: 48px; color: #6c757d;"></i>
            <h4 style="margin-top: 15px; color: #6c757d;">Belum Ada Data</h4>
            <p>Pilih tanggal dan mata kuliah terlebih dahulu untuk melihat data absensi.</p>
        </div>
    </div>
</div>
<!-- Modal Tanda Tangan Dosen (Backup) -->
<div id="dosen-signature-modal" class="modal">
    <div class="modal-content">
        <h3>Tanda Tangan Dosen</h3>
        <p style="margin-bottom: 15px;">Buat tanda tangan Anda untuk laporan absensi:</p>
        <canvas id="dosen-signature-canvas-modal" width="400" height="150"></canvas>
        <div class="action-bar" style="margin-top: 20px; justify-content: space-between;">
            <button class="btn-action btn-secondary" id="clear-dosen-signature-modal-btn">
                <i class="fas fa-trash"></i> Hapus
            </button>
            <button class="btn-action btn-primary" id="save-dosen-signature-modal-btn">
                <i class="fas fa-check"></i> Simpan Tanda Tangan
            </button>
        </div>
        <button class="btn-action" style="background-color: #6c757d; color: white; margin-top: 10px;" 
                onclick="document.getElementById('dosen-signature-modal').style.display='none'">
            Tutup
        </button>
    </div>
</div>              
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="overlay" id="overlay"></div>
    </div>
    
    <!-- Modal Tanda Tangan -->
    <div id="signature-modal" class="modal">
        <div class="modal-content">
            <h3>Tanda Tangan Kehadiran</h3>
            <p id="absensi-target-name" style="margin-bottom: 15px; font-weight: 600;"></p>
            <canvas id="signature-canvas" width="300" height="150" style="width: 100%; max-width: 350px;"></canvas>
            <div class="action-bar" style="margin-top: 20px; justify-content: space-between;">
                <button class="btn-action btn-secondary" id="clear-signature-btn">
                    <i class="fas fa-trash"></i> Hapus
                </button>
                <button class="btn-action btn-primary" id="save-signature-btn">
                    <i class="fas fa-check"></i> Absen Sekarang
                </button>
            </div>
            <button class="btn-action" style="background-color: #6c757d; color: white; margin-top: 10px;" onclick="document.getElementById('signature-modal').style.display='none'">
                Tutup
            </button>
        </div>
    </div>
    
    <!-- ========== MODAL BARU: PUBLIC PROFILE LAIN ========== -->
    <div id="public-profile-modal" class="modal">
        <div class="modal-content profile-card">
             <span class="ad-close-btn" onclick="document.getElementById('public-profile-modal').style.display='none'" style="position: absolute; top: 10px; right: 10px;">&times;</span>
             
             <img src="https://i.imgur.com/BVVboCP.png" alt="User Profile Picture" id="public-profile-pic-img" style="cursor: default;"> 
                        
            <div class="profile-header">
                <h4 id="public-profile-name">Nama Pengguna</h4>
                <p id="public-profile-role">Peran / Jurusan</p>
                <!-- EXP Bar Publik -->
                <div style="font-size: 14px; color: #555; margin-top: 5px;">
                    Level: <strong id="public-profile-level">1</strong> (EXP: <span id="public-profile-exp">0</span> / 100)
                    <div class="exp-bar">
                        <div class="exp-bar-fill" id="public-profile-exp-bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <div class="profile-info public-profile-info">
                 <div class="data-item">
                    <strong><i class="fas fa-id-card"></i> ID</strong>
                    <span id="public-profile-id">ID Pengguna</span>
                </div>
                <div class="data-item">
                    <strong><i class="fas fa-tasks"></i> Tugas Di-upload</strong>
                    <span id="public-profile-tasks">0</span>
                </div>
                 <div class="data-item">
                    <strong><i class="fas fa-calendar-alt"></i> Status</strong>
                    <span>Aktif</span>
                </div>
            </div>
             <button class="btn-action btn-secondary" style="margin-top: 20px;" onclick="document.getElementById('public-profile-modal').style.display='none'">
                Tutup
            </button>
        </div>
    </div>
    <!-- ==================================================== -->
<!-- === MODAL BARU: UPLOAD FOTO PROFIL === -->
<!-- ==================================================== -->
<div id="upload-photo-modal" class="modal">
    <div class="modal-content">
        <span class="ad-close-btn" onclick="closeUploadModal()">&times;</span>
        
        <h3><i class="fas fa-camera"></i> Ganti Foto Profil</h3>
        <p>Pilih metode untuk mengubah foto profil Anda</p>
        
        <div class="upload-options">
            <!-- Opsi 1: Upload File -->
            <div class="upload-option" onclick="selectUploadOption('file')">
                <i class="fas fa-file-upload"></i>
                <div class="upload-option-content">
                    <div class="upload-option-title">Upload dari Perangkat</div>
                    <div class="upload-option-desc">Pilih file gambar dari perangkat Anda</div>
                </div>
            </div>
            
            <!-- Opsi 2: URL -->
            <div class="upload-option" onclick="selectUploadOption('url')">
                <i class="fas fa-link"></i>
                <div class="upload-option-content">
                    <div class="upload-option-title">Gunakan URL Gambar</div>
                    <div class="upload-option-desc">Masukkan link gambar dari internet</div>
                </div>
            </div>
        </div>
        
        <!-- Section Upload File -->
        <div id="file-upload-section">
            <div class="select-group">
                <label for="photo-file-input"><i class="fas fa-image"></i> Pilih Gambar:</label>
                <input type="file" id="photo-file-input" accept="image/*" style="padding: 8px;">
                <small style="color: #666; display: block; margin-top: 5px;">Format: JPG, PNG, GIF (maks. 2MB)</small>
            </div>
            
            
            <div class="upload-progress" id="file-upload-progress">
                <div class="upload-progress-bar" id="file-progress-bar"></div>
            </div>
            
            <button class="btn-action btn-primary" id="upload-file-btn" style="width: 100%; margin-top: 15px;" disabled>
                <i class="fas fa-cloud-upload-alt"></i> Upload Gambar
            </button>
        </div>
        
        <!-- Section URL -->
        <div id="url-upload-section">
            <div class="select-group">
                <label for="photo-url-input"><i class="fas fa-link"></i> Masukkan URL Gambar:</label>
                <input type="url" id="photo-url-input" placeholder="https://example.com/image.jpg" style="padding: 8px;">
                <small style="color: #666; display: block; margin-top: 5px;">Pastikan URL gambar valid dan dapat diakses</small>
            </div>
            
            <button class="btn-action btn-primary" id="save-url-btn" style="width: 100%; margin-top: 15px;" disabled>
                <i class="fas fa-check"></i> Gunakan Gambar Ini
            </button>
        </div>
        
        <div class="alert-info" id="upload-status" style="display: none; margin-top: 15px;"></div>
    </div>
</div>
<!-- ==================================================== -->
<!-- === MODAL BARU: PREVIEW & EDIT FOTO PROFIL === -->
<!-- ==================================================== -->
<div id="photo-preview-modal" class="modal">
    <div class="modal-content">
        <span class="ad-close-btn" onclick="closePreviewModal()">&times;</span>
        
        <h3><i class="fas fa-crop-alt"></i> Edit Foto Profil</h3>
        <p>Atur posisi dan ukuran foto sebelum menyimpan</p>
        
        <div class="preview-main-area">
            <div class="preview-container">
                <canvas id="photo-preview-canvas"></canvas>
                <div class="preview-crop-overlay" id="crop-overlay"></div>
            </div>
            
            <div class="preview-controls">
                <!-- Kontrol Zoom -->
                <div class="zoom-controls">
                    <button id="zoom-out-btn" title="Perkecil">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <span id="zoom-level-text">100%</span>
                    <button id="zoom-in-btn" title="Perbesar">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
                
                <!-- Kontrol Posisi Horizontal -->
                <div class="position-controls">
                    <div class="position-slider">
                        <label>Geser Kanan/Kiri:</label>
                        <input type="range" id="position-x-slider" min="-100" max="100" value="0">
                    </div>
                    
                    <div class="position-slider">
                        <label>Geser Atas/Bawah:</label>
                        <input type="range" id="position-y-slider" min="-100" max="100" value="0">
                    </div>
                    
                    <div class="position-slider">
                        <label>Putar Gambar:</label>
                        <input type="range" id="rotate-slider" min="-180" max="180" value="0">
                    </div>
                </div>
                
                <!-- Tombol Reset -->
                <div class="reset-controls">
                    <button class="btn-action btn-secondary" id="reset-all-btn">
                        <i class="fas fa-redo"></i> Reset Semua
                    </button>
                    
                    <!-- Tombol Hapus Foto -->
                    <button class="btn-action" id="delete-photo-btn">
                        <i class="fas fa-trash"></i> Hapus Foto
                    </button>
                </div>
            </div>
        </div>
        
        <div class="preview-actions">
            <button class="btn-action" id="cancel-preview-btn" onclick="closePreviewModal()">
                <i class="fas fa-times"></i> Batal
            </button>
            <button class="btn-action btn-primary" id="save-photo-btn">
                <i class="fas fa-check"></i> Simpan Foto
            </button>
        </div>
        
        <div class="alert-info" id="preview-status" style="display: none; margin-top: 15px;"></div>
    </div>
</div>
    <!-- ==================================================== -->


    <!-- MODAL LUPA PASSWORD (Verifikasi) -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <h3>Reset Password (Verifikasi)</h3>
            <p style="margin-bottom: 20px; font-size: 14px; color: #555;">Masukkan ID dan Email terdaftar Anda. Kami akan memverifikasi data Anda sebelum mengizinkan reset password.</p>
            
            <div class="select-group">
                <label for="forgot-id-input">NPM / NIDN:</label>
                <!-- Gunakan style input yang sudah didefinisikan di .select-group -->
                <input type="text" id="forgot-id-input" placeholder="Masukkan ID Anda">
            </div>
            <div class="select-group">
                <label for="forgot-email-input">Email Terdaftar:</label>
                <input type="email" id="forgot-email-input" placeholder="Masukkan Email Anda">
            </div>

            <div class="action-bar" style="margin-top: 20px; justify-content: flex-end;">
                <button class="btn-action" style="background-color: #6c757d; color: white;" id="close-forgot-modal-btn">
                    Batal
                </button>
                <button class="btn-action btn-primary" id="send-reset-btn">
                    <i class="fas fa-check-circle"></i> Verifikasi Data
                </button>
            </div>
        </div>
    </div>
    
    <!-- ==================================================== -->
    <!-- === MODAL BARU: Untuk Mengisi Password Baru === -->
    <!-- ==================================================== -->
    <div id="reset-password-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <h3>Masukkan Password Baru</h3>
            <p style="margin-bottom: 20px; font-size: 14px; color: #555;">
                Verifikasi berhasil untuk ID: <strong id="reset-user-id-display" style="color: #333;">[USER ID]</strong>.
                <br>Silakan masukkan password baru Anda (minimal 6 karakter).
            </p>
            
            <div class="select-group">
                <label for="new-password-input">Password Baru:</label>
                <input type="password" id="new-password-input" placeholder="Masukkan password baru">
            </div>

            <div class="action-bar" style="margin-top: 20px; justify-content: flex-end;">
                <button class="btn-action" style="background-color: #6c757d; color: white;" id="close-reset-modal-btn">
                    Batal
                </button>
                <button class="btn-action btn-primary" id="save-new-password-btn">
                    <i class="fas fa-save"></i> Simpan Password Baru
                </button>
            </div>
        </div>
    </div>
<!-- ==================================================== -->
<!-- === MODAL TUTORIAL ONBOARDING === -->
<!-- ==================================================== -->
<div id="onboarding-tutorial">
    <div class="tutorial-container">
        <div class="tutorial-header">
            <h3>
                <i class="fas fa-graduation-cap"></i>
                Panduan Sistem Informasi
            </h3>
            <button id="skip-tutorial-btn">
                <i class="fas fa-forward"></i> Skip Tutorial
            </button>
        </div>
        
        <div class="tutorial-content">
            <!-- Sisi Gambar -->
            <div class="tutorial-image-side">
                <div class="tutorial-image-wrapper">
                    <img id="tutorial-image" src="" alt="Tutorial Image" class="tutorial-image">
                </div>
            </div>
            
            <!-- Sisi Teks -->
            <div class="tutorial-text-side">
                <!-- Step Indicator -->
                <div class="tutorial-step-indicator">
                    <div class="step-dot active" data-step="1"></div>
                    <div class="step-dot" data-step="2"></div>
                    <div class="step-dot" data-step="3"></div>
                    <div class="step-dot" data-step="4"></div>
                    <div class="step-dot" data-step="5"></div>
                </div>
                
                <!-- Konten Teks -->
                <div class="tutorial-text-content">
                    <h3 class="tutorial-title" id="tutorial-title"></h3>
                    <p id="tutorial-text"></p>
                </div>
                
                <!-- Tombol Navigasi -->
                <div class="tutorial-buttons">
                    <div class="step-counter">
                        Langkah <span id="current-step">1</span> dari 5
                    </div>
                    
                    <div class="tutorial-nav-buttons">
                        <button class="tutorial-btn" id="prev-tutorial-btn" disabled>
                            <i class="fas fa-chevron-left"></i> Sebelumnya
                        </button>
                        <button class="tutorial-btn" id="next-tutorial-btn">
                            Selanjutnya <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="admin-delete-container" style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
    <button id="btn-delete-all-history" style="
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(220,53,69,0.4);
        transition: all 0.3s;
        font-size: 14px;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220,53,69,0.6)'" 
    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(220,53,69,0.4)'">
        <i class="fas fa-trash-alt"></i> HAPUS SEMUA RIWAYAT ABSENSI
</div>

   <script type="module">
        // Import the functions you need from the SDKs you need
        // UPDATE VERSI KE 12.8.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
        
        // PENTING: Import Database dan Storage tetap dibutuhkan agar aplikasi jalan
        import { getDatabase, ref, set, get, child, update, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js";

        // Konfigurasi Firebase BARU Anda
        const firebaseConfig = {
            apiKey: "AIzaSyAfM6Cj0xCq6_6F4JknLnUe-np-up2ZaOU",
            authDomain: "sistem-informasi-database.firebaseapp.com",
            databaseURL: "https://sistem-informasi-database-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sistem-informasi-database",
            storageBucket: "sistem-informasi-database.firebasestorage.app",
            messagingSenderId: "434563106745",
            appId: "1:434563106745:web:b20e9bef8ae61fd55c1868",
            measurementId: "G-0D1DWYHFJ3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        
        // Inisialisasi Database dan Storage (Wajib untuk logika aplikasi di bawah)
        const db = getDatabase(app); 
        const storage = getStorage(app); 
        
        console.log("Firebase App (v12.8.0), Database, Analytics, dan Storage berhasil diinisialisasi dengan Config Baru.");
        // ============================================== //
// === NONAKTIFKAN TOTAL SISTEM OTOMATIS JADWAL === //
// ============================================== //

// 1. OVERRIDE PARSED_SCHEDULE - SELALU KOSONG
window.PARSED_SCHEDULE = {};

// 2. OVERRIDE FUNGSI PARSING JADWAL
window.parseFullSchedule = function() {
    console.log('â›” SISTEM JADWAL OTOMATIS DINONAKTIFKAN');
    window.PARSED_SCHEDULE = {};
    return {};
};

// 3. OVERRIDE FUNGSI CEK STATE
window.getCurrentExpectedState = function() {
    return { status: 'manual_only' };
};

// 4. OVERRIDE FUNGSI UPDATE CLASS SESSION
window.checkAndUpdateClassSession = async function() {
    console.log('â›” checkAndUpdateClassSession dinonaktifkan');
    return { status: 'disabled_by_admin' };
};

// 5. HAPUS SEMUA INTERVAL JADWAL
if (window.countdownTimerInterval) {
    clearInterval(window.countdownTimerInterval);
    window.countdownTimerInterval = null;
}

// 6. NONAKTIFKAN RENDER JADWAL
window.renderJadwalMatkul = function() {
    const container = document.getElementById('schedule-display-container');
    if (container) {
        container.innerHTML = '<div class="alert-info">Jadwal reguler dinonaktifkan. Absensi hanya via Super Admin.</div>';
    }
};

console.log('âœ… SISTEM OTOMATIS JADWAL TELAH DINONAKTIFKAN');

  // ================================================ //
// === SUPER ADMIN MASTER - PERSISTEN FORCE MODE === //
// === ANTI AUTO CLOSE - STABIL SAMPAI JAM HABIS === //
// === NO EMOJI - ALL FA/FAS ICONS === //
// ================================================ //

const SUPER_ADMIN_NPM = '15125029';
const FORCED_SESSION_KEY = 'forced_attendance_session_v2';
const FORCED_LOCK_KEY = 'forced_session_lock'; // Kunci pengunci sistem

// Data jadwal lengkap
const JADWAL_LENGKAP = {
    1: [ // Senin
        { matkul: "Sistem Informasi Manajemen", jam: "09:00 - 10:30", dosenId: "D002", dosenName: "Dr. Ir. John Friadi, S.Kom., M.Si.,M.TI" },
        { matkul: "Matematika Diskrit", jam: "10:30 - 12:00", dosenId: "D003", dosenName: "Dr. Nurhatisyah, S.T, SST, M.Kom" }
    ],
    2: [ // Selasa
        { matkul: "Konsep Basis Data", jam: "09:00 - 10:30", dosenId: "D004", dosenName: "Dr. Angelina E.R. S.Kom., M.MSI / Dr. Fendi Hidayat, S.T., M.Kom" },
        { matkul: "Kewirausahaan", jam: "10:30 - 12:00", dosenId: "D005", dosenName: "Dr. Ir. John Friadi, S.Kom., M.Si.,M.TI" }
    ],
    3: [ // Rabu
        { matkul: "Pendidikan Anti Korupsi", jam: "09:00 - 10:30", dosenId: "D001", dosenName: "To Be Advised" },
        { matkul: "Pancasila", jam: "10:30 - 12:00", dosenId: "D006", dosenName: "To Be Advised" }
    ],
    4: [ // Kamis
        { matkul: "Statistika dan Probabilitas", jam: "09:00 - 10:30", dosenId: "D007", dosenName: "Nanny, M.Kom" },
        { matkul: "Sistem Operasi", jam: "10:30 - 12:00", dosenId: "D008", dosenName: "Dodi Putra Yani, S.Kom, M.Si" }
    ],
    5: [ // Jumat
        { matkul: "Hima Prodi", jam: "19:00 - 21:00", dosenId: "-", dosenName: "Kaprodi Atau Dosen Pembina Hima Prodi" }
    ]
};

// ================================================ //
// === 1. ANTI AUTO CLOSE - PENGUNCI SISTEM === //
// ================================================ //

let forcedSessionMasterListener = null;
let originalCheckAndUpdateClassSession = null;
let originalOnValueSessionListener = null;
let systemLockActive = false;
let currentForcedSessionData = null;

/**
 * MEMATIKAN SEMUA SISTEM OTOMATIS YANG BISA NUTUP ABSEN
 */
function disableAllAutoSystems() {
    console.log('ðŸ”’ LOCK: Mematikan semua sistem otomatis...');
    
    // 1. Matikan checkAndUpdateClassSession
    if (typeof window.checkAndUpdateClassSession === 'function' && !originalCheckAndUpdateClassSession) {
        originalCheckAndUpdateClassSession = window.checkAndUpdateClassSession;
        window.checkAndUpdateClassSession = async function() {
            console.log('â›” SISTEM OTOMATIS DIBLOKIR - Forced session active');
            return { status: 'blocked_by_admin' };
        };
    }
    
    // 2. INTERCEPT semua listener session yang sudah ada
    // Hapus dan ganti dengan dummy jika perlu
    try {
        const sessionRef = ref(db, GLOBAL_SESSION_STATE_KEY);
        // Tidak bisa hapus listener orang lain, tapi kita akan override di Firebase saja
    } catch(e) { console.warn('Session intercept warning:', e); }
    
    // 3. Set flag lock
    systemLockActive = true;
    localStorage.setItem(FORCED_LOCK_KEY, 'true');
    
    console.log('âœ… LOCK: Sistem otomatis dinonaktifkan');
}

/**
 * MENGAKTIFKAN KEMBALI SISTEM OTOMATIS
 */
function enableAllAutoSystems() {
    console.log('ðŸ”“ UNLOCK: Mengaktifkan kembali sistem otomatis...');
    
    // 1. Kembalikan checkAndUpdateClassSession
    if (originalCheckAndUpdateClassSession) {
        window.checkAndUpdateClassSession = originalCheckAndUpdateClassSession;
        originalCheckAndUpdateClassSession = null;
    }
    
    // 2. Hapus flag lock
    systemLockActive = false;
    localStorage.removeItem(FORCED_LOCK_KEY);
    
    console.log('âœ… UNLOCK: Sistem otomatis aktif kembali');
}

// ================================================ //
// === 2. LISTENER UTAMA - TAHAN SAMPAI JAM HABIS === //
// ================================================ //

function initForcedSessionMasterV2() {
    if (forcedSessionMasterListener) return;
    
    const forcedSessionRef = ref(db, FORCED_SESSION_KEY);
    
    forcedSessionMasterListener = onValue(forcedSessionRef, (snapshot) => {
        const forcedData = snapshot.exists() ? snapshot.val() : null;
        
        if (forcedData && forcedData.status === 'open') {
            // SIMPAN DATA SESSION
            currentForcedSessionData = forcedData;
            
            // CEK APAKAH SUDAH LEWAT JAM?
            const now = Date.now();
            if (forcedData.sessionEndTime && now >= forcedData.sessionEndTime) {
                console.log('â° Sesi paksa telah mencapai jam akhir, auto close...');
                handleForcedSessionExpiry();
                return;
            }
            
            console.log('ðŸ”¥ FORCED SESSION MASTER AKTIF:', forcedData.matkulName);
            
            // 1. Matikan semua sistem otomatis
            disableAllAutoSystems();
            
            // 2. SET STATE GLOBAL - PAKSA!!!
            CURRENT_SESSION_STATE = {
                status: 'open',
                activeMatkulKey: forcedData.activeMatkulKey,
                matkulName: forcedData.matkulName,
                dosenId: forcedData.dosenId,
                dosenName: forcedData.dosenName,
                sessionEndTime: forcedData.sessionEndTime,
                forcedByAdmin: forcedData.forcedByAdmin,
                forcedAt: forcedData.forcedAt,
                isForceOpened: true,
                isMasterForced: true,
                systemAutoDisabled: true,
                antiAutoClose: true,
                lockedUntil: forcedData.sessionEndTime
            };
            
            // 3. PAKSA UPDATE KE MAIN SESSION - TERUS MENERUS AGAR TIDAK OVERTIME
            const mainSessionRef = ref(db, GLOBAL_SESSION_STATE_KEY);
            set(mainSessionRef, CURRENT_SESSION_STATE);
            
            // 4. KIRIM UPDATE KE FIREBASE LAGI (REINFORCE)
            setTimeout(() => {
                if (currentForcedSessionData) {
                    set(mainSessionRef, CURRENT_SESSION_STATE).catch(console.warn);
                }
            }, 500);
            
            // 5. SCHEDULE UNTUK AUTO CLOSE SAAT JAM HABIS
            const timeUntilEnd = forcedData.sessionEndTime - now;
            if (timeUntilEnd > 0) {
                setTimeout(() => {
                    // CEK LAGI, JANGAN SAMPAI KEDULUAN
                    if (currentForcedSessionData && currentForcedSessionData.status === 'open') {
                        const currentTime = Date.now();
                        if (currentTime >= forcedData.sessionEndTime) {
                            handleForcedSessionExpiry();
                        }
                    }
                }, timeUntilEnd + 1000); // +1 detik untuk jaga-jaga
            }
            
            // 6. REFRESH UI
            refreshAbsenUIV2();
            
        } else if (forcedData && forcedData.status === 'closed') {
            console.log('ðŸ”’ FORCED SESSION MASTER DITUTUP:', forcedData.closedMatkul || forcedData.matkulName);
            
            // 1. Aktifkan kembali sistem otomatis
            enableAllAutoSystems();
            
            // 2. Bersihkan data session
            currentForcedSessionData = null;
            
            // 3. Set state closed
            CURRENT_SESSION_STATE = {
                status: 'closed',
                nextSessionTime: forcedData.nextSessionTime,
                closedByAdmin: forcedData.closedByAdmin,
                closedAt: forcedData.closedAt,
                isForceClosed: true
            };
            
            // 4. Update ke Firebase
            const mainSessionRef = ref(db, GLOBAL_SESSION_STATE_KEY);
            set(mainSessionRef, CURRENT_SESSION_STATE).catch(console.warn);
            
            // 5. Refresh UI
            refreshAbsenUIV2();
            
        } else {
            // TIDAK ADA FORCED SESSION
            if (currentForcedSessionData) {
                enableAllAutoSystems();
                currentForcedSessionData = null;
                refreshAbsenUIV2();
            }
        }
    });
}

/**
 * HANDLE SAAT SESI PAKSA BERAKHIR OTOMATIS
 */
async function handleForcedSessionExpiry() {
    console.log('â° Eksekusi auto close forced session...');
    
    try {
        const forcedSessionRef = ref(db, FORCED_SESSION_KEY);
        const mainSessionRef = ref(db, GLOBAL_SESSION_STATE_KEY);
        
        // Hapus forced session
        await remove(forcedSessionRef);
        
        // Set main session ke closed
        await set(mainSessionRef, {
            status: 'closed',
            closedBy: 'system_expiry',
            closedAt: new Date().toISOString(),
            reason: 'forced_session_ended'
        });
        
        // Aktifkan sistem otomatis
        enableAllAutoSystems();
        currentForcedSessionData = null;
        
        window.showNotification('Sesi paksa berakhir sesuai jadwal', 4000);
        refreshAbsenUIV2();
        
    } catch (error) {
        console.error('Error auto close:', error);
    }
}

// ================================================ //
// === 3. FUNGSI FORCE OPEN - ANTI AUTO CLOSE === //
// ================================================ //

async function forceOpenSessionMasterV2(matkul, dosenId, dosenName, dayIndex, matkulIndex, startTimeStr, endTimeStr) {
    try {
        const forcedSessionRef = ref(db, FORCED_SESSION_KEY);
        const now = Date.now();

        // PARSE DURASI
        const [startHour, startMin] = startTimeStr.split(':').map(Number);
        const [endHour, endMin] = endTimeStr.split(':').map(Number);
        const today = new Date();
        
        // HITUNG DURASI ASLI (dalam milidetik)
        const normalStart = new Date(today.getFullYear(), today.getMonth(), today.getDate(), startHour, startMin).getTime();
        const normalEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHour, endMin).getTime();
        const originalDuration = normalEnd - normalStart;
        
        // PASTIKAN DURASI POSITIF
        if (originalDuration <= 0) {
            window.showNotification('Error: Durasi mata kuliah tidak valid', 4000);
            return false;
        }
        
        // SET END TIME = SEKARANG + DURASI ASLI
        const newEndTime = now + originalDuration;
        
        // BUAT UNIQUE KEY
        const activeMatkulKey = `${dayIndex}-${matkulIndex}-${Date.now()}`;

        const forcedSessionData = {
            status: 'open',
            activeMatkulKey: activeMatkulKey,
            matkulName: matkul,
            dosenId: dosenId || 'unknown',
            dosenName: dosenName,
            sessionEndTime: newEndTime,
            sessionStartTime: now,
            originalDuration: originalDuration,
            forcedByAdmin: SUPER_ADMIN_NPM,
            forcedAt: new Date().toISOString(),
            forcedDate: new Date().toLocaleDateString('id-ID'),
            forcedTime: new Date().toLocaleTimeString('id-ID'),
            isForceOpened: true,
            isMasterForced: true,
            systemAutoDisabled: true,
            antiAutoClose: true,
            version: 'v2',
            createdAt: now,
            lastUpdated: now,
            expiresAt: newEndTime
        };

        // SIMPAN KE FIREBASE
        await set(forcedSessionRef, forcedSessionData);
        
        // UPDATE MAIN SESSION
        const mainSessionRef = ref(db, GLOBAL_SESSION_STATE_KEY);
        await set(mainSessionRef, {
            ...forcedSessionData,
            status: 'open'
        });
        
        // UPDATE STATE LOKAL
        CURRENT_SESSION_STATE = {
            ...forcedSessionData,
            status: 'open'
        };
        currentForcedSessionData = forcedSessionData;
        
        // MATIKAN SISTEM OTOMATIS
        disableAllAutoSystems();
        
        // HITUNG WAKTU UNTUK AUTO CLOSE
        const timeUntilEnd = newEndTime - now;
        if (timeUntilEnd > 0) {
            setTimeout(() => {
                // CEK APAKAH MASIH SESI INI?
                if (currentForcedSessionData && 
                    currentForcedSessionData.activeMatkulKey === activeMatkulKey) {
                    handleForcedSessionExpiry();
                }
            }, timeUntilEnd + 500);
        }
        
        window.showNotification(
            `MASTER: ${matkul} DIBUKA PUKSA\nSesi akan berakhir: ${new Date(newEndTime).toLocaleTimeString('id-ID')}\nSistem otomatis NONAKTIF`, 
            7000
        );
        
        refreshAbsenUIV2();
        return true;

    } catch (error) {
        console.error('Force open master error:', error);
        window.showNotification('Gagal: ' + error.message, 5000);
        return false;
    }
}

// ================================================ //
// === 4. FUNGSI FORCE CLOSE - HAPUS SESI PAKSA === //
// ================================================ //

async function forceCloseSessionMasterV2(matkul) {
    try {
        const forcedSessionRef = ref(db, FORCED_SESSION_KEY);
        const mainSessionRef = ref(db, GLOBAL_SESSION_STATE_KEY);
        
        // HAPUS DARI FIREBASE
        await remove(forcedSessionRef);
        
        // CARI NEXT SESSION (JIKA ADA)
        const dayIndex = new Date().getDay();
        const todaySchedule = PARSED_SCHEDULE[dayIndex] || [];
        let nextSessionTime = null;

        for (const course of todaySchedule) {
            if (course.startTime > Date.now()) {
                nextSessionTime = course.startTime;
                break;
            }
        }

        const closedState = {
            status: 'closed',
            nextSessionTime: nextSessionTime,
            closedByAdmin: SUPER_ADMIN_NPM,
            closedAt: new Date().toISOString(),
            closedMatkul: matkul,
            isForceClosed: true
        };
        
        await set(mainSessionRef, closedState);
        
        // AKTIFKAN KEMBALI SISTEM OTOMATIS
        enableAllAutoSystems();
        currentForcedSessionData = null;
        CURRENT_SESSION_STATE = closedState;

        window.showNotification(`MASTER: ${matkul} DITUTUP PUKSA\nSistem otomatis kembali AKTIF`, 6000);
        
        refreshAbsenUIV2();
        return true;

    } catch (error) {
        console.error('Force close master error:', error);
        window.showNotification('Gagal menutup: ' + error.message, 5000);
        return false;
    }
}

// ================================================ //
// === 5. RENDER PANEL SUPER ADMIN - RESPONSIVE === //
// ================================================ //

function renderSuperAdminPanelV2() {
    if (!CURRENT_USER || CURRENT_USER.id !== SUPER_ADMIN_NPM) return;

    const wrapper = document.getElementById('mahasiswa-content-wrapper');
    if (!wrapper) return;

    if (document.getElementById('super-admin-panel-v2')) return;

    // CEK STATUS FORCED
    const isForcedActive = currentForcedSessionData !== null || 
                          (CURRENT_SESSION_STATE?.isMasterForced === true);
    const forcedMatkul = isForcedActive ? 
        (currentForcedSessionData?.matkulName || CURRENT_SESSION_STATE?.matkulName || '') : '';
    const forcedEndTime = isForcedActive ? 
        new Date(currentForcedSessionData?.sessionEndTime || CURRENT_SESSION_STATE?.sessionEndTime || Date.now())
            .toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '';

    // HITUNG SISA WAKTU
    let timeRemaining = '';
    if (isForcedActive && currentForcedSessionData?.sessionEndTime) {
        const remainingMs = currentForcedSessionData.sessionEndTime - Date.now();
        if (remainingMs > 0) {
            const hours = Math.floor(remainingMs / 3600000);
            const minutes = Math.floor((remainingMs % 3600000) / 60000);
            timeRemaining = `${hours}j ${minutes}m`;
        } else {
            timeRemaining = 'Berakhir';
        }
    }

    // GENERATE OPTIONS
    let matkulOptions = '<option value="" disabled selected>Pilih Mata Kuliah</option>';
    
    for (let day = 1; day <= 5; day++) {
        const dayName = getHariIndonesia(day);
        const courses = JADWAL_LENGKAP[day] || [];
        
        courses.forEach((course, index) => {
            if (!course.jam.includes('-')) return;
            const optionValue = `${day}-${index}`;
            const displayText = `${dayName} | ${course.matkul} (${course.jam})`;
            
            matkulOptions += `<option value="${optionValue}" 
                data-matkul="${course.matkul}"
                data-dosen-id="${course.dosenId}"
                data-dosen-name="${course.dosenName}"
                data-start="${course.jam.split(' - ')[0]}"
                data-end="${course.jam.split(' - ')[1]}"
                data-day="${day}">
                ${displayText}
            </option>`;
        });
    }

    const panelHTML = `
        <div id="super-admin-panel-v2" style="
            background: linear-gradient(145deg, #0a0c1a, #0e1a2f);
            border: ${isForcedActive ? '3px solid #00ffaa' : '2px solid #ffaa00'};
            border-radius: 24px;
            padding: 18px 16px;
            margin-bottom: 25px;
            color: white;
            box-shadow: ${isForcedActive 
                ? '0 10px 30px rgba(0, 255, 170, 0.3), inset 0 0 30px rgba(0,255,170,0.1)' 
                : '0 10px 30px rgba(255, 170, 0, 0.2)'};
            position: relative;
            transition: all 0.3s ease;
        ">
            <!-- ANIMASI SAAT AKTIF -->
            ${isForcedActive ? `
            <div style="
                position: absolute;
                top: -1px;
                left: -1px;
                right: -1px;
                height: 4px;
                background: linear-gradient(90deg, #00ffaa, #00ccff, #00ffaa);
                border-radius: 24px 24px 0 0;
                animation: scanLine 3s linear infinite;
            "></div>
            ` : ''}
            
            <div style="position: relative; z-index: 2;">
                
                <!-- HEADER -->
                <div style="
                    display: flex;
                    flex-direction: row;
                    flex-wrap: wrap;
                    align-items: center;
                    gap: 12px;
                    margin-bottom: 20px;
                ">
                    <div style="
                        background: ${isForcedActive ? '#00ffaa' : '#ffaa00'};
                        width: 48px;
                        height: 48px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: ${isForcedActive 
                            ? '0 0 20px #00ffaa' 
                            : '0 0 15px #ffaa00'};
                        flex-shrink: 0;
                    ">
                        <i class="fas ${isForcedActive ? 'fa-bolt' : 'fa-crown'}" style="color: #0a0c1a; font-size: 24px;"></i>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px;">
                        <h3 style="
                            margin: 0;
                            color: ${isForcedActive ? '#00ffaa' : '#ffaa00'};
                            font-size: clamp(16px, 5vw, 22px);
                            font-weight: 700;
                            display: flex;
                            align-items: center;
                            flex-wrap: wrap;
                            gap: 8px;
                        ">
                            <i class="fas fa-shield-alt"></i> SUPER ADMIN MASTER
                            ${isForcedActive ? `
                            <span style="
                                background: #00aa00;
                                padding: 4px 12px;
                                border-radius: 50px;
                                font-size: 11px;
                                font-weight: 600;
                                color: white;
                                display: inline-flex;
                                align-items: center;
                                gap: 5px;
                            ">
                                <i class="fas fa-lock"></i> FORCE AKTIF
                            </span>
                            ` : ''}
                        </h3>
                        <p style="
                            margin: 5px 0 0 0;
                            color: #aaddff;
                            font-size: 12px;
                            opacity: 0.9;
                        ">
                            <i class="fas fa-id-card"></i> ${SUPER_ADMIN_NPM} 
                            <i class="fas fa-database" style="margin-left: 10px;"></i> PERSISTEN 
                            <i class="fas fa-clock" style="margin-left: 10px;"></i> ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                        </p>
                    </div>
                </div>

                <!-- STATUS BANNER - FORCED ACTIVE -->
                ${isForcedActive ? `
                <div style="
                    background: linear-gradient(145deg, #002211, #003322);
                    border: 1px solid #00ffaa;
                    border-radius: 16px;
                    padding: 16px;
                    margin-bottom: 20px;
                    display: flex;
                    flex-direction: row;
                    flex-wrap: wrap;
                    align-items: center;
                    justify-content: space-between;
                    gap: 12px;
                ">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <i class="fas fa-exclamation-triangle" style="color: #ffaa00; font-size: 22px;"></i>
                        <div>
                            <div style="font-weight: 700; color: #00ffaa; font-size: 15px;">
                                <i class="fas fa-ban"></i> SISTEM OTOMATIS DINONAKTIFKAN
                            </div>
                            <div style="font-size: 13px; color: #ccffdd; margin-top: 3px;">
                                <i class="fas fa-book"></i> <strong>${forcedMatkul}</strong> â€¢ 
                                <i class="fas fa-hourglass-half"></i> ${timeRemaining} tersisa â€¢ 
                                <i class="fas fa-clock"></i> sampai ${forcedEndTime}
                            </div>
                        </div>
                    </div>
                    <span style="
                        background: #00ffaa20;
                        border: 1px solid #00ffaa;
                        border-radius: 50px;
                        padding: 6px 14px;
                        color: #00ffaa;
                        font-size: 12px;
                        font-weight: 600;
                        display: inline-flex;
                        align-items: center;
                        gap: 5px;
                    ">
                        <i class="fas fa-shield"></i> AUTO OFF
                    </span>
                </div>
                ` : ''}

                <!-- GRID RESPONSIF -->
                <div style="
                    display: grid;
                    grid-template-columns: 1fr;
                    gap: 16px;
                    margin-bottom: 10px;
                " class="admin-grid-v2">
                    
                    <!-- CARD 1: PILIH MATKUL -->
                    <div style="
                        background: rgba(255, 170, 0, 0.08);
                        border: 1px solid ${isForcedActive ? '#00ffaa40' : '#ffaa0040'};
                        border-radius: 20px;
                        padding: 18px;
                    ">
                        <label style="
                            display: block;
                            margin-bottom: 12px;
                            color: ${isForcedActive ? '#00ffaa' : '#ffaa00'};
                            font-weight: 700;
                            font-size: 14px;
                        ">
                            <i class="fas fa-book-open"></i> PILIH MATA KULIAH
                        </label>
                        
                        <select id="master-matkul-select-v2" style="
                            width: 100%;
                            padding: 14px 16px;
                            border-radius: 16px;
                            border: 2px solid ${isForcedActive ? '#00ffaa' : '#ffaa00'};
                            background: #0e1a2f;
                            color: white;
                            font-weight: 600;
                            font-size: 14px;
                            cursor: pointer;
                            outline: none;
                            appearance: none;
                            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="%23ffaa00"><path d="M7 10l5 5 5-5z"/></svg>');
                            background-repeat: no-repeat;
                            background-position: right 15px center;
                        ">
                            ${matkulOptions}
                        </select>
                        
                        <div id="master-selected-info-v2" style="
                            margin-top: 16px;
                            padding: 14px;
                            background: #0a0c1a;
                            border-radius: 14px;
                            border-left: 5px solid ${isForcedActive ? '#00ffaa' : '#ffaa00'};
                            display: none;
                        ">
                            <div style="color: #ffdd88; font-size: 12px; margin-bottom: 5px;">
                                <i class="fas fa-check-circle"></i> TERPILIH:
                            </div>
                            <div id="master-selected-detail-v2" style="color: white; font-weight: 600; font-size: 14px;"></div>
                        </div>
                    </div>

                    <!-- CARD 2: AKSI MASTER -->
                    <div style="
                        background: rgba(255, 170, 0, 0.08);
                        border: 1px solid ${isForcedActive ? '#00ffaa40' : '#ffaa0040'};
                        border-radius: 20px;
                        padding: 18px;
                    ">
                        <label style="
                            display: block;
                            margin-bottom: 16px;
                            color: ${isForcedActive ? '#00ffaa' : '#ffaa00'};
                            font-weight: 700;
                            font-size: 14px;
                        ">
                            <i class="fas fa-bolt"></i> AKSI MASTER
                        </label>
                        
                        <div style="
                            display: flex;
                            flex-direction: column;
                            gap: 12px;
                        ">
                            <button id="master-force-open-btn-v2" class="master-btn-v2" style="
                                background: linear-gradient(145deg, #0066cc, #0099ff);
                                border: none;
                                border-radius: 60px;
                                padding: 16px 14px;
                                color: white;
                                font-weight: 700;
                                font-size: 15px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 12px;
                                transition: all 0.2s;
                                box-shadow: 0 6px 15px #0066cc80;
                                border: 1px solid #ffffff80;
                                opacity: 0.6;
                                width: 100%;
                            " disabled>
                                <i class="fas fa-power-off"></i>
                                <span>BUKA ABSEN MASTER</span>
                                <span style="
                                    background: rgba(255,255,255,0.15);
                                    padding: 4px 10px;
                                    border-radius: 50px;
                                    font-size: 11px;
                                ">PERSISTEN</span>
                            </button>
                            
                            <button id="master-force-close-btn-v2" class="master-btn-v2" style="
                                background: linear-gradient(145deg, #cc3300, #ff5500);
                                border: none;
                                border-radius: 60px;
                                padding: 16px 14px;
                                color: white;
                                font-weight: 700;
                                font-size: 15px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 12px;
                                transition: all 0.2s;
                                box-shadow: 0 6px 15px #cc330080;
                                border: 1px solid #ffffff80;
                                opacity: 0.6;
                                width: 100%;
                            " disabled>
                                <i class="fas fa-power-off"></i>
                                <span>TUTUP & HAPUS SESI</span>
                                <span style="
                                    background: rgba(255,255,255,0.15);
                                    padding: 4px 10px;
                                    border-radius: 50px;
                                    font-size: 11px;
                                ">HAPUS</span>
                            </button>
                        </div>
                        
                        <div style="
                            margin-top: 20px;
                            padding: 12px;
                            background: #0a0c1a;
                            border-radius: 12px;
                            font-size: 12px;
                            color: #aaddff;
                            border: 1px dashed ${isForcedActive ? '#00ffaa' : '#ffaa00'}40;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        ">
                            <i class="fas fa-info-circle" style="color: ${isForcedActive ? '#00ffaa' : '#ffaa00'};"></i>
                            <span style="line-height: 1.5;">
                                ${isForcedActive 
                                    ? 'Sesi paksa AKTIF. Sistem otomatis NONAKTIF. Hanya admin bisa menutup.'
                                    : 'Sesi paksa TIDAK AKTIF. Sistem berjalan normal.'}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div style="
                    margin-top: 20px;
                    padding-top: 16px;
                    border-top: 1px solid ${isForcedActive ? '#00ffaa40' : '#ffaa0040'};
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: space-between;
                    align-items: center;
                    gap: 12px;
                    color: #aaddff;
                    font-size: 11px;
                ">
                    <span><i class="fas fa-calendar-alt"></i> ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                    <span style="color: ${isForcedActive ? '#00ffaa' : '#ffaa00'};">
                        <i class="fas fa-database"></i> 
                        ${isForcedActive ? 'FORCE ACTIVE' : 'STANDBY'}
                    </span>
                    ${isForcedActive && timeRemaining ? `
                    <span><i class="fas fa-hourglass-half"></i> ${timeRemaining}</span>
                    ` : ''}
                </div>
            </div>
        </div>
        
        <style>
            @media (min-width: 768px) {
                .admin-grid-v2 {
                    grid-template-columns: 1fr 1fr !important;
                }
                #super-admin-panel-v2 {
                    padding: 22px 25px !important;
                }
            }
            
            @keyframes scanLine {
                0% { left: -100%; }
                100% { left: 200%; }
            }
            
            .master-btn-v2:hover {
                transform: translateY(-3px);
                filter: brightness(1.2);
            }
            .master-btn-v2:active {
                transform: translateY(2px);
            }
            #master-matkul-select-v2 option {
                background: #0e1a2f;
                color: white;
                padding: 12px;
            }
        </style>
    `;

    wrapper.insertAdjacentHTML('afterbegin', panelHTML);
    attachMasterAdminEventsV2();
}

// ================================================ //
// === 6. EVENT LISTENER PANEL === //
// ================================================ //

function attachMasterAdminEventsV2() {
    const selectEl = document.getElementById('master-matkul-select-v2');
    const openBtn = document.getElementById('master-force-open-btn-v2');
    const closeBtn = document.getElementById('master-force-close-btn-v2');
    const infoDiv = document.getElementById('master-selected-info-v2');
    const detailP = document.getElementById('master-selected-detail-v2');

    if (!selectEl || !openBtn || !closeBtn) return;

    selectEl.addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        
        if (!selected.value) {
            infoDiv.style.display = 'none';
            openBtn.disabled = true;
            closeBtn.disabled = true;
            openBtn.style.opacity = '0.6';
            closeBtn.style.opacity = '0.6';
            return;
        }

        const matkul = selected.dataset.matkul;
        const dosenName = selected.dataset.dosenName || 'Unknown';
        const start = selected.dataset.start;
        const end = selected.dataset.end;
        const day = selected.dataset.day;
        const dayName = getHariIndonesia(parseInt(day));

        detailP.innerHTML = `
            <strong style="font-size: 15px;">${matkul}</strong><br>
            <span style="color: #ffaa00; font-size: 12px; margin-top: 5px; display: block;">
                ${dayName} â€¢ ${start} - ${end}<br>
                <i class="fas fa-user-tie"></i> ${dosenName.length > 35 ? dosenName.substring(0, 35) + '...' : dosenName}
            </span>
        `;
        infoDiv.style.display = 'block';
        
        openBtn.disabled = false;
        closeBtn.disabled = false;
        openBtn.style.opacity = '1';
        closeBtn.style.opacity = '1';

        const isForced = currentForcedSessionData !== null && 
                        currentForcedSessionData.matkulName === matkul;

        if (isForced) {
            openBtn.style.background = 'linear-gradient(145deg, #008844, #00aa66)';
            openBtn.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>SUDAH AKTIF (${new Date(currentForcedSessionData.sessionEndTime).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })})</span>
                <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 50px;">AKTIF</span>
            `;
        } else {
            openBtn.style.background = 'linear-gradient(145deg, #0066cc, #0099ff)';
            openBtn.innerHTML = `
                <i class="fas fa-power-off"></i>
                <span>BUKA ABSEN MASTER</span>
                <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 50px;">PERSISTEN</span>
            `;
        }

        openBtn.dataset.matkul = matkul;
        openBtn.dataset.dosenId = selected.dataset.dosenId;
        openBtn.dataset.dosenName = dosenName;
        openBtn.dataset.start = start;
        openBtn.dataset.end = end;
        openBtn.dataset.day = day;
        openBtn.dataset.optionValue = selected.value;

        closeBtn.dataset.matkul = matkul;
    });

    openBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        
        if (!CURRENT_USER || CURRENT_USER.id !== SUPER_ADMIN_NPM) {
            window.showNotification('Akses ditolak. Hanya Super Admin.', 4000);
            return;
        }

        const matkul = this.dataset.matkul;
        const dosenId = this.dataset.dosenId;
        const dosenName = this.dataset.dosenName;
        const startTimeStr = this.dataset.start;
        const endTimeStr = this.dataset.end;
        const optionValue = this.dataset.optionValue;
        const [dayIndex, matkulIndex] = optionValue.split('-').map(Number);

        if (!matkul) return;

        if (!confirm(`MASTER FORCE OPEN\n\nMata Kuliah: ${matkul}\nWaktu: ${startTimeStr} - ${endTimeStr}\n\nSISTEM OTOMATIS AKAN DINONAKTIFKAN\nSesi akan bertahan sampai jam selesai\n\nLanjutkan?`)) return;

        await forceOpenSessionMasterV2(matkul, dosenId, dosenName, dayIndex, matkulIndex, startTimeStr, endTimeStr);
    });

    closeBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        
        if (!CURRENT_USER || CURRENT_USER.id !== SUPER_ADMIN_NPM) return;

        const matkul = this.dataset.matkul;
        if (!matkul) return;

        if (!confirm(`MASTER FORCE CLOSE\n\nMata Kuliah: ${matkul}\n\nSESI PAKSA AKAN DIHAPUS\nSistem otomatis kembali AKTIF\n\nLanjutkan?`)) return;

        await forceCloseSessionMasterV2(matkul);
    });
}

// ================================================ //
// === 7. REFRESH UI === //
// ================================================ //

function refreshAbsenUIV2() {
    if (typeof window.renderMahasiswaList === 'function') {
        setTimeout(() => window.renderMahasiswaList(), 200);
    }
}

// ================================================ //
// === 8. HELPER === //
// ================================================ //

function getHariIndonesia(dayIndex) {
    const hari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    return hari[dayIndex] || 'Unknown';
}

// ================================================ //
// === 9. INISIALISASI SISTEM === //
// ================================================ //

function initMasterSystemV2() {
    console.log('MASTER FORCED SYSTEM V2 - INISIALISASI');
    
    // 1. CEK LOCK DARI LOCALSTORAGE
    const lockStatus = localStorage.getItem(FORCED_LOCK_KEY);
    if (lockStatus === 'true') {
        console.log('LOCK ditemukan, mengaktifkan mode terkunci...');
        systemLockActive = true;
    }
    
    // 2. INIT LISTENER
    initForcedSessionMasterV2();
    
    // 3. OVERRIDE RENDER MAHASISWA LIST
    const originalRender = window.renderMahasiswaList;
    window.renderMahasiswaList = async function() {
        if (typeof originalRender === 'function') {
            await originalRender.apply(this, arguments);
        }
        setTimeout(() => {
            if (CURRENT_USER?.id === SUPER_ADMIN_NPM) {
                renderSuperAdminPanelV2();
            }
        }, 250);
    };
    
    // 4. AUTO INJECT UNTUK ADMIN
    const checkTimer = setInterval(() => {
        if (CURRENT_USER?.id === SUPER_ADMIN_NPM) {
            const activeContent = document.querySelector('.content-section.active');
            if (activeContent?.id === 'mahasiswa-list-content') {
                renderSuperAdminPanelV2();
            }
        }
    }, 800);
    
    setTimeout(() => clearInterval(checkTimer), 30000);
    
    // 5. CLEANUP ON PAGE UNLOAD
    window.addEventListener('beforeunload', function() {
        // JANGAN HAPUS SESSION, BIAARKAN PERSISTEN
        console.log('Page unload - forced session tetap aktif di Firebase');
    });
    
    console.log('MASTER FORCED SYSTEM V2 SIAP');
}

// ================================================ //
// === 10. JALANKAN INISIALISASI === //
// ================================================ //

setTimeout(() => {
    if (typeof db !== 'undefined') {
        initMasterSystemV2();
    } else {
        console.warn('Firebase belum siap, coba lagi...');
        setTimeout(initMasterSystemV2, 2000);
    }
}, 1500);

// EKSPOS KE GLOBAL
window.MasterAdminV2 = {
    forceOpen: forceOpenSessionMasterV2,
    forceClose: forceCloseSessionMasterV2,
    isActive: () => currentForcedSessionData !== null,
    getCurrentSession: () => currentForcedSessionData,
    unlockSystem: enableAllAutoSystems
};
       const DOSEN_ACCOUNTS = [
    { 
        id: 'D001', 
        name: 'Dr. Fendi Hidayat, ST., M.Kom', 
        password: 'dosen123', 
        email: 'fendi@dosen.ac.id', 
        mata_kuliah: 'Konsep Basis Data', 
        role: 'Dosen' 
    },
    { 
        id: 'D002', 
        name: 'Dr. Ir. John Friadi, S.Kom., M.Si., M.TI', 
        password: 'dosen123', 
        email: 'john.friadi@dosen.ac.id', 
        mata_kuliah: 'Sistem Informasi Manajemen / Kewirausahaan', 
        role: 'Dosen' 
    },
    { 
        id: 'D003', 
        name: 'Dr. Nurhatisyah, S.T, SST, M.Kom', 
        password: 'dosen123', 
        email: 'nurhatisyah@dosen.ac.id', 
        mata_kuliah: 'Matematika Diskrit', 
        role: 'Dosen' 
    },
    { 
        id: 'D004', 
        name: 'Dr. Angelina E.R. S.Kom., M.MSI', 
        password: 'dosen123', 
        email: 'angelina@dosen.ac.id', 
        mata_kuliah: 'Konsep Basis Data', 
        role: 'Dosen' 
    },
    { 
        id: 'D005', 
        name: 'Nanny, M.Kom', 
        password: 'dosen123', 
        email: 'nanny@dosen.ac.id', 
        mata_kuliah: 'Statistika dan Probabilitas', 
        role: 'Dosen' 
    },
    { 
        id: 'D006', 
        name: 'Dodi Putra Yani, S.Kom, M.Si', 
        password: 'dosen123', 
        email: 'dodi.putra@dosen.ac.id', 
        mata_kuliah: 'Sistem Operasi', 
        role: 'Dosen' 
    }
];

        const ALLOWED_NPMS = [
            '15125001', '15125009', '15125014', '15125016', '15125020', '15125022',
            '15125025', '15125026', '15125027', '15125028', '15125031', '15125033',
            '15125035', '2021014', '15125038', '15125037', '15125029',
        ];
            // Set tanggal default ke hari ini
const today = new Date().toISOString().split('T')[0];
const dateInput = document.getElementById('ketua-filter-date');
const monthInput = document.getElementById('laporan-bulan');

if (dateInput) dateInput.value = today;
if (monthInput) monthInput.value = new Date().toISOString().slice(0, 7);

// Data tutorial
const TUTORIAL_STEPS = [
    {
        id: 1,
        title: "Selamat Datang di Sistem Informasi!",
        text: "Selamat datang di portal akademik Sistem Informasi Kelas Pagi Universitas Batam. Sistem ini dirancang untuk memudahkan aktivitas perkuliahan Anda.",
        image: "https://i.imgur.com/VoSghie.png"
    },
    {
        id: 2,
        title: "Cara Melakukan Absensi",
        text: "Absensi dilakukan otomatis sesuai jadwal. Cukup klik tombol 'Absen Kehadiran' pada menu Absen Mahasiswa saat sesi terbuka, lalu berikan tanda tangan digital Anda.",
        image: "https://i.imgur.com/VoSghie.png"
    },
    {
        id: 3,
        title: "Upload Tugas dengan Mudah",
        text: "Upload tugas Anda di menu 'Upload Tugas'. Pilih dosen pengampu, pilih file, dan klik upload. Anda bisa melihat nilai tugas di halaman yang sama.",
        image: "https://i.imgur.com/VoSghie.png"
    },
    {
        id: 4,
        title: "Komunikasi via Chat Kelas",
        text: "Gunakan Chat Kelas untuk berdiskusi dengan teman sekelas dan dosen. Anda bisa reply pesan dan melihat siapa yang sedang online.",
        image: "https://i.imgur.com/VoSghie.png"
    },
    {
        id: 5,
        title: "Panduan Lengkap Tersedia",
        text: "Selalu cek menu 'Panduan Website' untuk informasi terbaru dan panduan penggunaan semua fitur yang tersedia di sistem ini.",
        image: "https://i.imgur.com/VoSghie.png"
    }
];

// State tutorial
let currentTutorialStep = 1;
let isTutorialVisible = false;
let typingInterval = null;
let autoNextTimer = null;
const TUTORIAL_SHOWN_KEY = 'tutorial_shown';

// Waktu delay
const AUTO_NEXT_DELAY = 2000; // 2 detik setelah teks selesai
const REDIRECT_DELAY = 1000; // 1 detik delay sebelum redirect

// ======================================= //
// === FUNGSI UTAMA TUTORIAL === //
// ======================================= //

// Fungsi untuk memulai tutorial
window.startTutorial = function() {
    const tutorialElement = document.getElementById('onboarding-tutorial');
    
    // Cek apakah tutorial sudah pernah ditampilkan
    const tutorialShown = localStorage.getItem(TUTORIAL_SHOWN_KEY);
    if (tutorialShown === 'true') {
        return; // Jangan tampilkan lagi
    }
    
    // Tampilkan tutorial setelah 1 detik
    setTimeout(() => {
        tutorialElement.classList.add('show');
        isTutorialVisible = true;
        loadTutorialStep(1);
        
        // Simpan status bahwa tutorial sudah ditampilkan
        localStorage.setItem(TUTORIAL_SHOWN_KEY, 'true');
    }, 1000);
}

// Fungsi untuk memuat langkah tutorial
function loadTutorialStep(stepNumber) {
    const step = TUTORIAL_STEPS.find(s => s.id === stepNumber);
    if (!step) return;
    
    currentTutorialStep = stepNumber;
    
    // Update UI
    document.getElementById('tutorial-title').textContent = step.title;
    document.getElementById('tutorial-image').src = step.image;
    document.getElementById('current-step').textContent = stepNumber;
    
    // Reset teks
    const tutorialText = document.getElementById('tutorial-text');
    tutorialText.textContent = '';
    tutorialText.classList.remove('typing');
    
    // Update step indicator
    document.querySelectorAll('.step-dot').forEach((dot, index) => {
        if (index + 1 === stepNumber) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
    
    // Update tombol
    const prevBtn = document.getElementById('prev-tutorial-btn');
    const nextBtn = document.getElementById('next-tutorial-btn');
    
    if (prevBtn) {
        prevBtn.disabled = stepNumber === 1;
    }
    
    if (nextBtn) {
        if (stepNumber === TUTORIAL_STEPS.length) {
            nextBtn.innerHTML = 'Selesai <i class="fas fa-external-link-alt"></i>';
        } else {
            nextBtn.innerHTML = 'Selanjutnya <i class="fas fa-chevron-right"></i>';
        }
    }
    
    // Start typing animation dengan callback untuk auto-next
    startTypingAnimation(step.text, () => {
        // Setelah teks selesai diketik, atur timer untuk auto-next
        const autoNextIndicator = document.getElementById('auto-next-indicator');
        
        if (stepNumber < TUTORIAL_STEPS.length) {
            // Untuk step 1-4: auto-lanjut ke step berikutnya
            if (autoNextIndicator) {
                autoNextIndicator.innerHTML = '<i class="fas fa-clock"></i> Auto-lanjut...';
                autoNextIndicator.classList.add('show');
            }
            
            autoNextTimer = setTimeout(() => {
                if (autoNextIndicator) {
                    autoNextIndicator.classList.remove('show');
                }
                nextTutorialStep();
            }, AUTO_NEXT_DELAY);
        } else {
            // Step terakhir: auto-redirect ke Berita Kelas
            if (autoNextIndicator) {
                autoNextIndicator.innerHTML = '<i class="fas fa-external-link-alt"></i> Akan diarahkan ke Berita Kelas...';
                autoNextIndicator.classList.add('show');
                autoNextIndicator.classList.add('redirect');
            }
            
            // Auto-finish dan redirect setelah delay
            autoNextTimer = setTimeout(() => {
                finishTutorialAndRedirect();
            }, AUTO_NEXT_DELAY + 1000);
        }
    });
}

// Fungsi untuk efek mengetik teks
function startTypingAnimation(text, onComplete = null) {
    const tutorialText = document.getElementById('tutorial-text');
    let charIndex = 0;
    
    // Hapus interval sebelumnya jika ada
    if (typingInterval) {
        clearInterval(typingInterval);
    }
    
    // Hapus auto-next timer jika ada
    if (autoNextTimer) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
    }
    
    // Reset teks
    tutorialText.textContent = '';
    tutorialText.classList.add('typing');
    
    // Mulai efek mengetik
    typingInterval = setInterval(() => {
        if (charIndex < text.length) {
            tutorialText.textContent += text.charAt(charIndex);
            charIndex++;
        } else {
            // Selesai mengetik
            clearInterval(typingInterval);
            tutorialText.classList.remove('typing');
            
            // Panggil callback jika ada
            if (onComplete && typeof onComplete === 'function') {
                onComplete();
            }
        }
    }, 30);
}

// Fungsi untuk langkah berikutnya
function nextTutorialStep() {
    // Hapus timer dan indikator
    pauseAutoNext();
    
    if (currentTutorialStep < TUTORIAL_STEPS.length) {
        loadTutorialStep(currentTutorialStep + 1);
    } else {
        // Jika sudah step terakhir, finish dan redirect
        finishTutorialAndRedirect();
    }
}

// Fungsi untuk langkah sebelumnya
function prevTutorialStep() {
    // Hapus timer dan indikator
    pauseAutoNext();
    
    if (currentTutorialStep > 1) {
        loadTutorialStep(currentTutorialStep - 1);
    }
}

// Fungsi untuk menyelesaikan tutorial dan redirect ke Berita Kelas
function finishTutorialAndRedirect() {
    const tutorialElement = document.getElementById('onboarding-tutorial');
    tutorialElement.classList.remove('show');
    isTutorialVisible = false;
    
    // Hapus semua timer
    pauseAutoNext();
    if (typingInterval) {
        clearInterval(typingInterval);
        typingInterval = null;
    }
    
    // Tampilkan notifikasi
    window.showNotification('Tutorial telah selesai cek berita kelas yuk', 3000);
    
    // Delay sebentar sebelum redirect
    setTimeout(() => {
        // Redirect ke Berita Kelas (info-update-website)
        redirectToBeritaKelas();
    }, REDIRECT_DELAY);
}

// Fungsi untuk redirect ke Berita Kelas
function redirectToBeritaKelas() {
    console.log('Redirecting to Berita Kelas...');
    
    // Tutup sidebar jika terbuka (mobile)
    const sidebar = document.getElementById('sidebar');
    if (sidebar && window.innerWidth <= 768) {
        sidebar.classList.remove('open');
        const overlay = document.getElementById('overlay');
        if (overlay) {
            overlay.classList.remove('active');
        }
    }
    
    // Gunakan fungsi switchContent yang sudah ada di sistem
    if (typeof window.switchContent === 'function') {
        window.switchContent('info-update-website');
    } else {
        // Fallback jika fungsi switchContent tidak tersedia
        const allContents = document.querySelectorAll('.content-section');
        allContents.forEach(content => {
            content.classList.remove('active');
        });
        
        const targetContent = document.getElementById('info-update-website');
        if (targetContent) {
            targetContent.classList.add('active');
        }
    }
    
    // Update active menu di sidebar
    updateActiveMenu('info-update-website');
    
    // Update breadcrumb
    updateBreadcrumb('Berita Kelas');
    
    // Scroll ke atas
    window.scrollTo(0, 0);
    
    // Tampilkan notifikasi
    setTimeout(() => {
        window.showNotification('ðŸ“° Selamat datang di Berita Kelas!', 2000);
    }, 500);
}

// Fungsi untuk update active menu di sidebar
function updateActiveMenu(contentId) {
    // Hapus active class dari semua menu
    document.querySelectorAll('.menu-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Tambahkan active class ke menu yang sesuai
    const activeMenu = document.querySelector(`.menu-link[data-content-id="${contentId}"]`);
    if (activeMenu) {
        activeMenu.classList.add('active');
    }
}

// Fungsi untuk update breadcrumb
function updateBreadcrumb(pageName) {
    const breadcrumb = document.getElementById('breadcrumb');
    if (breadcrumb) {
        breadcrumb.innerHTML = `
            <a href="#" onclick="switchContent('mahasiswa-list-content')">Home</a> 
            <span>/</span>${pageName}
        `;
    }
}

// Fungsi untuk skip tutorial
function skipTutorial() {
    if (confirm('Apakah Anda yakin ingin melewati tutorial?')) {
        const tutorialElement = document.getElementById('onboarding-tutorial');
        tutorialElement.classList.remove('show');
        isTutorialVisible = false;
        
        pauseAutoNext();
        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        
        // Simpan status bahwa tutorial sudah dilewati
        localStorage.setItem(TUTORIAL_SHOWN_KEY, 'true');
        
        // Langsung redirect ke Berita Kelas
        redirectToBeritaKelas();
    }
}

// Fungsi untuk pause auto-next
function pauseAutoNext() {
    if (autoNextTimer) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
    }
    
    // Sembunyikan indikator
    const autoNextIndicator = document.getElementById('auto-next-indicator');
    if (autoNextIndicator) {
        autoNextIndicator.classList.remove('show');
        autoNextIndicator.classList.remove('redirect');
    }
}

// ======================================= //
// === SETUP EVENT LISTENERS === //
// ======================================= //

function setupTutorialEvents() {
    // Tombol next
    const nextBtn = document.getElementById('next-tutorial-btn');
    if (nextBtn) {
        nextBtn.addEventListener('click', function() {
            pauseAutoNext();
            nextTutorialStep();
        });
    }
    
    // Tombol prev
    const prevBtn = document.getElementById('prev-tutorial-btn');
    if (prevBtn) {
        prevBtn.addEventListener('click', function() {
            pauseAutoNext();
            prevTutorialStep();
        });
    }
    
    // Tombol skip
    const skipBtn = document.getElementById('skip-tutorial-btn');
    if (skipBtn) {
        skipBtn.addEventListener('click', function() {
            pauseAutoNext();
            skipTutorial();
        });
    }
    
    // Tombol tutorial di sidebar
    const showTutorialBtn = document.getElementById('show-tutorial-btn');
    if (showTutorialBtn) {
        showTutorialBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Close sidebar jika di mobile
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth <= 768) {
                sidebar.classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            }
            
            // Reset ke langkah pertama
            currentTutorialStep = 0;
            pauseAutoNext();
            nextTutorialStep();
            
            // Tampilkan modal tutorial
            const tutorialElement = document.getElementById('onboarding-tutorial');
            tutorialElement.classList.add('show');
            isTutorialVisible = true;
        });
    }
    
    // Hentikan auto-next jika user interaksi
    const tutorialContent = document.querySelector('.tutorial-content');
    if (tutorialContent) {
        tutorialContent.addEventListener('mouseenter', pauseAutoNext);
        tutorialContent.addEventListener('click', pauseAutoNext);
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (!isTutorialVisible) return;
        
        if (e.key === 'Escape') {
            pauseAutoNext();
            skipTutorial();
        } else if (e.key === 'ArrowRight') {
            pauseAutoNext();
            nextTutorialStep();
        } else if (e.key === 'ArrowLeft') {
            pauseAutoNext();
            prevTutorialStep();
        }
    });
}

// ======================================= //
// === INISIALISASI DAN RESET === //
// ======================================= //

// Inisialisasi tutorial system
function initTutorialSystem() {
    console.log('ðŸŽ“ Initializing tutorial system...');
    
    // Setup event listeners
    setupTutorialEvents();
    
    // Cek apakah sudah login, baru tampilkan tutorial
    if (CURRENT_USER && CURRENT_USER.loggedIn) {
        // Tunggu 1 detik untuk memastikan UI dashboard sudah load
        setTimeout(() => {
            startTutorial();
        }, 1000);
    }
}

// Reset tutorial (untuk testing)
window.resetTutorial = function() {
    localStorage.removeItem(TUTORIAL_SHOWN_KEY);
    window.showNotification('ðŸ”„ Tutorial direset. Akan muncul saat login berikutnya.', 3000);
    
    // Tampilkan tutorial lagi
    setTimeout(() => {
        startTutorial();
    }, 500);
}

// ======================================= //
// === FUNGSI DASHBOARD KETUA KELAS === //
// ======================================= //

// Cek apakah user adalah ketua kelas
function isKetuaKelas() {
    return CURRENT_USER.id === '15125033' && CURRENT_USER.role === 'Mahasiswa';
}

// Tampilkan/sembunyikan menu ketua kelas
function toggleKetuaKelasMenu() {
    const ketuaGroup = document.getElementById('ketua-kelas-group');
    if (ketuaGroup) {
        ketuaGroup.style.display = isKetuaKelas() ? 'block' : 'none';
    }
}

// Load data absensi untuk ketua kelas
async function loadAbsensiForKetua() {
    const dateInput = document.getElementById('ketua-filter-date').value;
    const matkulInput = document.getElementById('ketua-filter-matkul').value;
    
    if (!dateInput) {
        window.showNotification('âŒ Pilih tanggal terlebih dahulu', 3000);
        return;
    }
    
    // Format tanggal untuk Firebase
    const formattedDate = dateInput.split('-').reverse().join('-');
    const firebaseDate = formattedDate.replace(/\//g, '-');
    
    try {
        // Tampilkan loading
        document.getElementById('ketua-loading-state').style.display = 'block';
        document.getElementById('ketua-absensi-table-container').style.display = 'none';
        document.getElementById('ketua-empty-state').style.display = 'none';
        
        const absensiRef = ref(db, `absensi/${firebaseDate}`);
        const snapshot = await get(absensiRef);
        
        let absensiData = [];
        if (snapshot.exists()) {
            const data = snapshot.val();
            Object.keys(data).forEach(npm => {
                const item = data[npm];
                // Filter berdasarkan mata kuliah jika dipilih
                if (!matkulInput || item.matkul === matkulInput) {
                    absensiData.push({
                        npm: npm,
                        name: item.studentName,
                        matkul: item.matkul || 'Tidak Diketahui',
                        status: item.status,
                        time: item.time,
                        signature: item.signature,
                        key: npm
                    });
                }
            });
        }
        
        // Sembunyikan loading
        document.getElementById('ketua-loading-state').style.display = 'none';
        
        if (absensiData.length === 0) {
            document.getElementById('ketua-empty-state').style.display = 'block';
            return;
        }
        
        // Render tabel
        renderKetuaAbsensiTable(absensiData);
        
    } catch (error) {
        console.error('Error loading absensi:', error);
        window.showNotification('âŒ Gagal memuat data absensi', 4000);
        document.getElementById('ketua-loading-state').style.display = 'none';
    }
}

// Render tabel absensi untuk ketua kelas
// GANTI fungsi renderKetuaAbsensiTable yang sudah ada dengan ini:
function renderKetuaAbsensiTable(data) {
    const tbody = document.getElementById('ketua-absensi-table-body');
    const tableContainer = document.getElementById('ketua-absensi-table-container');
    const saveBtn = document.getElementById('btn-save-changes');
    
    tbody.innerHTML = '';
    
    data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.dataset.npm = item.npm;
        row.dataset.matkul = item.matkul;
        row.dataset.date = document.getElementById('ketua-filter-date').value;
        
        // Opsi status untuk dropdown
        const statusOptions = ['Hadir', 'Alpha', 'Izin', 'Sakit'];
        const statusSelect = `
            <select class="status-select" data-npm="${item.npm}" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-weight: 600; color: ${getStatusColor(item.status)};">
                ${statusOptions.map(opt => 
                    `<option value="${opt}" ${opt === item.status ? 'selected' : ''} style="color: ${getStatusColor(opt)};">${opt}</option>`
                ).join('')}
            </select>
        `;
        
        // Input keterangan
        const keteranganInput = `
            <input type="text" class="keterangan-input" data-npm="${item.npm}" 
                value="${item.keterangan || ''}" 
                placeholder="Keterangan (opsional)"
                style="padding: 5px; border-radius: 4px; border: 1px solid #ccc; width: 100%; min-width: 150px;">
        `;
        
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.npm}</td>
            <td>${item.name}</td>
            <td>${item.matkul}</td>
            <td>${statusSelect}</td>
            <td>${keteranganInput}</td>
            <td>${item.time || '-'}</td>
            <td>
                <button class="btn-action btn-secondary btn-view-signature" data-signature="${item.signature || ''}" title="Lihat Tanda Tangan">
                    <i class="fas fa-signature"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    tableContainer.style.display = 'block';
    saveBtn.style.display = 'block';
    
    // Tambahkan event listener untuk perubahan status (update warna)
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function() {
            this.style.color = getStatusColor(this.value);
            saveBtn.disabled = false;
        });
    });
    
    // Tambahkan event listener untuk perubahan keterangan
    document.querySelectorAll('.keterangan-input').forEach(input => {
        input.addEventListener('input', function() {
            saveBtn.disabled = false;
        });
    });
    
    // Event listener untuk lihat tanda tangan
    document.querySelectorAll('.btn-view-signature').forEach(btn => {
        btn.addEventListener('click', function() {
            const signature = this.dataset.signature;
            if (signature) {
                showSignatureModal(signature);
            } else {
                window.showNotification('âŒ Tidak ada tanda tangan', 3000);
            }
        });
    });
}

// Fungsi helper untuk warna status
function getStatusColor(status) {
    switch(status) {
        case 'Hadir': return '#28a745'; // Hijau
        case 'Alpha': return '#dc3545'; // Merah
        case 'Izin': return '#ffc107'; // Kuning
        case 'Sakit': return '#17a2b8'; // Biru
        default: return '#333';
    }
}

// Modal untuk melihat tanda tangan
function showSignatureModal(signatureBase64) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <h3>Tanda Tangan Mahasiswa</h3>
            <img src="${signatureBase64}" alt="Tanda Tangan" style="width: 100%; border: 1px solid #ccc; border-radius: 5px;">
            <button class="btn-action" onclick="this.closest('.modal').remove()" style="margin-top: 15px; width: 100%;">
                Tutup
            </button>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Tutup modal saat klik di luar
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.remove();
        }
    });
}

// GANTI fungsi saveAbsensiChanges yang sudah ada dengan ini:
async function saveAbsensiChanges() {
    const rows = document.querySelectorAll('#ketua-absensi-table-body tr');
    const dateInput = document.getElementById('ketua-filter-date').value;
    const formattedDate = dateInput.split('-').reverse().join('-');
    const firebaseDate = formattedDate.replace(/\//g, '-');
    
    let changes = [];
    
    // Kumpulkan perubahan
    rows.forEach(row => {
        const npm = row.dataset.npm;
        const matkul = row.dataset.matkul;
        const select = row.querySelector('.status-select');
        const keteranganInput = row.querySelector('.keterangan-input');
        const newStatus = select.value;
        const newKeterangan = keteranganInput.value.trim();
        
        changes.push({
            npm: npm,
            matkul: matkul,
            newStatus: newStatus,
            newKeterangan: newKeterangan,
            date: firebaseDate
        });
    });
    
    if (changes.length === 0) {
        window.showNotification('âš ï¸ Tidak ada data untuk disimpan', 3000);
        return;
    }
    
    try {
        // Update di Firebase
        for (const change of changes) {
            const absensiRef = ref(db, `absensi/${change.date}/${change.npm}`);
            
            // Ambil data existing untuk preserve field lainnya
            const snapshot = await get(absensiRef);
            const existingData = snapshot.exists() ? snapshot.val() : {};
            
            const updateData = {
                ...existingData,
                status: change.newStatus,
                keterangan: change.newKeterangan,
                editedBy: CURRENT_USER.id,
                editedAt: new Date().toISOString(),
                lastUpdatedBy: CURRENT_USER.name
            };
            
            await set(absensiRef, updateData);
        }
        
        window.showNotification(`âœ… ${changes.length} data absensi berhasil diperbarui`, 4000);
        document.getElementById('btn-save-changes').disabled = true;
        
        // Reload data
        setTimeout(() => loadAbsensiForKetua(), 1000);
        
    } catch (error) {
        console.error('Error saving changes:', error);
        window.showNotification('âŒ Gagal menyimpan perubahan', 4000);
    }
}
// Generate laporan kehadiran
async function generateLaporanKetua() {
    const bulanInput = document.getElementById('laporan-bulan').value;
    if (!bulanInput) return;
    
    const [tahun, bulan] = bulanInput.split('-');
    
    try {
        // Ambil semua data absensi untuk bulan tersebut
        const absensiRef = ref(db, 'absensi');
        const snapshot = await get(absensiRef);
        
        if (!snapshot.exists()) {
            window.showNotification('âŒ Tidak ada data absensi', 3000);
            return;
        }
        
        const allData = snapshot.val();
        const laporanData = {};
        
        // Proses data
        Object.keys(allData).forEach(tanggal => {
            const [day, month, year] = tanggal.split('-').map(Number);
            
            // Filter berdasarkan bulan dan tahun
            if (month === parseInt(bulan) && year === parseInt(tahun)) {
                Object.keys(allData[tanggal]).forEach(npm => {
                    const absen = allData[tanggal][npm];
                    
                    if (!laporanData[npm]) {
                        laporanData[npm] = {
                            nama: absen.studentName,
                            hadir: 0,
                            alpha: 0,
                            izin: 0,
                            sakit: 0,
                            matkul: {}
                        };
                    }
                    
                    // Hitung berdasarkan status
                    switch(absen.status) {
                        case 'Hadir': laporanData[npm].hadir++; break;
                        case 'Alpha': laporanData[npm].alpha++; break;
                        case 'Izin': laporanData[npm].izin++; break;
                        case 'Sakit': laporanData[npm].sakit++; break;
                    }
                    
                    // Hitung per mata kuliah
                    if (absen.matkul) {
                        if (!laporanData[npm].matkul[absen.matkul]) {
                            laporanData[npm].matkul[absen.matkul] = { hadir: 0, total: 0 };
                        }
                        laporanData[npm].matkul[absen.matkul].total++;
                        if (absen.status === 'Hadir') {
                            laporanData[npm].matkul[absen.matkul].hadir++;
                        }
                    }
                });
            }
        });
        
        // Render laporan
        renderLaporanKetua(laporanData);
        
    } catch (error) {
        console.error('Error generating report:', error);
        window.showNotification('âŒ Gagal membuat laporan', 4000);
    }
}

// Render laporan
function renderLaporanKetua(data) {
    const container = document.getElementById('laporan-container');
    const statistikEl = document.getElementById('statistik-kehadiran');
    const detailBody = document.getElementById('detail-laporan-body');
    
    container.style.display = 'block';
    
    // Hitung total
    let totalMahasiswa = Object.keys(data).length;
    let totalHadir = 0, totalAlpha = 0, totalIzin = 0, totalSakit = 0;
    
    Object.values(data).forEach(mhs => {
        totalHadir += mhs.hadir;
        totalAlpha += mhs.alpha;
        totalIzin += mhs.izin;
        totalSakit += mhs.sakit;
    });
    
    const totalSesi = totalHadir + totalAlpha + totalIzin + totalSakit;
    const persentaseHadir = totalSesi > 0 ? Math.round((totalHadir / totalSesi) * 100) : 0;
    
    // Render statistik
    statistikEl.innerHTML = `
        <div style="font-size: 14px;">
            <p><strong>Total Mahasiswa:</strong> ${totalMahasiswa}</p>
            <p><strong>Total Sesi:</strong> ${totalSesi}</p>
            <p><strong>Hadir:</strong> ${totalHadir} (${persentaseHadir}%)</p>
            <p><strong>Alpha:</strong> ${totalAlpha}</p>
            <p><strong>Izin:</strong> ${totalIzin}</p>
            <p><strong>Sakit:</strong> ${totalSakit}</p>
        </div>
    `;
    
    // Render detail per mahasiswa
    detailBody.innerHTML = '';
    Object.keys(data).forEach((npm, index) => {
        const mhs = data[npm];
        const totalMhs = mhs.hadir + mhs.alpha + mhs.izin + mhs.sakit;
        const persentaseMhs = totalMhs > 0 ? Math.round((mhs.hadir / totalMhs) * 100) : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${npm}</td>
            <td>${mhs.nama}</td>
            <td>${mhs.hadir}</td>
            <td>${mhs.alpha}</td>
            <td>${mhs.izin}</td>
            <td>${mhs.sakit}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>${persentaseMhs}%</span>
                    <div style="flex-grow: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${persentaseMhs}%; height: 100%; background: ${persentaseMhs >= 75 ? '#28a745' : persentaseMhs >= 50 ? '#ffc107' : '#dc3545'};"></div>
                    </div>
                </div>
            </td>
        `;
        detailBody.appendChild(row);
    });
    
    // Render chart (jika Chart.js tersedia)
    if (typeof Chart !== 'undefined') {
        renderKehadiranChart(data);
    }
}

// Render chart kehadiran
function renderKehadiranChart(data) {
    const ctx = document.getElementById('kehadiran-chart').getContext('2d');
    
    // Siapkan data untuk chart
    const labels = Object.keys(data).slice(0, 10); // Ambil 10 mahasiswa pertama
    const hadirData = labels.map(npm => data[npm].hadir);
    const alphaData = labels.map(npm => data[npm].alpha);
    const izinData = labels.map(npm => data[npm].izin);
    const sakitData = labels.map(npm => data[npm].sakit);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Hadir',
                    data: hadirData,
                    backgroundColor: '#28a745'
                },
                {
                    label: 'Alpha',
                    data: alphaData,
                    backgroundColor: '#dc3545'
                },
                {
                    label: 'Izin',
                    data: izinData,
                    backgroundColor: '#17a2b8'
                },
                {
                    label: 'Sakit',
                    data: sakitData,
                    backgroundColor: '#ffc107'
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            }
        }
    });
}

// Inisialisasi dashboard ketua kelas
function initKetuaKelasDashboard() {
    if (!isKetuaKelas()) return;
    
    console.log('ðŸŽ“ Initializing Ketua Kelas Dashboard for NPM 15125033');
    
    // Tampilkan menu
    toggleKetuaKelasMenu();
    
    // Setup event listeners
    document.getElementById('btn-load-absensi-ketua')?.addEventListener('click', loadAbsensiForKetua);
    document.getElementById('btn-save-changes')?.addEventListener('click', saveAbsensiChanges);
    document.getElementById('btn-generate-laporan')?.addEventListener('click', generateLaporanKetua);
    
    // Set tanggal default ke hari ini
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('ketua-filter-date').value = today;
}

// Panggil inisialisasi saat user login
document.addEventListener('DOMContentLoaded', function() {
    // Tunggu user login
    setTimeout(() => {
        if (CURRENT_USER && CURRENT_USER.loggedIn) {
            initKetuaKelasDashboard();
        }
    }, 1500);
});
// ======================================= //
// === INTEGRASI DENGAN SISTEM UTAMA === //
// ======================================= //

// Tunggu sampai sistem utama siap
document.addEventListener('DOMContentLoaded', function() {
    // Tunggu 2 detik untuk memastikan semua komponen load
    setTimeout(() => {
        // Cek apakah user sudah login
        const storedUser = localStorage.getItem(STORAGE_KEY);
        if (storedUser) {
            try {
                CURRENT_USER = JSON.parse(storedUser);
                CURRENT_USER.loggedIn = true;
                
                // Setup tutorial system setelah login
                setTimeout(() => {
                    initTutorialSystem();
                }, 800);
            } catch (e) {
                console.error('Error parsing stored user:', e);
            }
        }
    }, 2000);
});

// Pastikan fungsi switchContent tersedia (fallback)
if (typeof window.switchContent !== 'function') {
    window.switchContent = function(contentId) {
        // Sembunyikan semua konten
        const allContents = document.querySelectorAll('.content-section');
        allContents.forEach(content => {
            content.classList.remove('active');
        });
        
        // Tampilkan konten yang dipilih
        const targetContent = document.getElementById(contentId);
        if (targetContent) {
            targetContent.classList.add('active');
        }
        
        // Update breadcrumb
        updateBreadcrumb(getPageName(contentId));
        
        // Scroll ke atas
        window.scrollTo(0, 0);
    };
}

// Helper function untuk nama halaman
function getPageName(contentId) {
// Pastikan fungsi switchContent mendukung halaman ketua kelas
const pageNames = {
    'info-update-website': 'Berita Kelas',
    'user-content': 'User Profile',
    'module-content': 'Upload Tugas',
    'mahasiswa-list-content': 'Absen Mahasiswa',
    'chat-content': 'Chat Kelas',
    'panduan-content': 'Panduan Website',
    'jadwal-content': 'Jadwal Matakuliah',
    'absen-log-content': 'Riwayat Absensi',
    'pdf-absensi-content': 'Cetak Absen',
    'ketua-kelas-content': 'Dashboard Ketua Kelas',  // TAMBAHAN
    'ketua-kelas-laporan': 'Laporan Kehadiran'      // TAMBAHAN
};
    
    return pageNames[contentId] || 'Dashboard';
}

// ======================================= //
// === INISIALISASI TUTORIAL SAAT LOAD === //
// ======================================= //

// Panggil initTutorialSystem setelah user login berhasil
document.addEventListener('DOMContentLoaded', function() {
    // Tunggu semua element load
    setTimeout(() => {
        // Cek apakah user sudah login
        const storedUser = localStorage.getItem(STORAGE_KEY);
        if (storedUser) {
            try {
                CURRENT_USER = JSON.parse(storedUser);
                CURRENT_USER.loggedIn = true;
                
                // Setup tutorial system setelah login
                setTimeout(() => {
                    initTutorialSystem();
                }, 500);
            } catch (e) {
                console.error('Error parsing stored user:', e);
            }
        }
    }, 100);
});
document.addEventListener('DOMContentLoaded', function() {
    const AD_HIDE_KEY = 'ad_block_until'; // Key untuk menyimpan masa blokir 1 minggu
    const adModal = document.getElementById('ad-modal');
    const adOptions = document.getElementById('ad-options');

    function checkAndShowAd() {
        const blockUntil = localStorage.getItem(AD_HIDE_KEY);
        const now = new Date().getTime();

        // LOGIKA: Munculkan jika:
        // 1. User belum login (body memiliki class 'login-mode')
        // 2. Tidak ada jadwal blokir 1 minggu ATAU waktu blokir sudah habis
        const isLoggedOut = document.body.classList.contains('login-mode');
        
        if (isLoggedOut) {
            if (!blockUntil || now > parseInt(blockUntil)) {
                adModal.classList.add('show');
            }
        }
    }

    // Fungsi menampilkan menu pilihan saat klik icon silang
    window.showAdOptions = function() {
        adOptions.classList.add('show');
    };

    // Fungsi Eksekusi Pilihan
    window.closeAdAndSet = function(hideForWeek) {
        if (hideForWeek) {
            // Set waktu blokir: Sekarang + 7 hari
            const oneWeek = new Date().getTime() + (7 * 24 * 60 * 60 * 1000);
            localStorage.setItem(AD_HIDE_KEY, oneWeek.toString());
        } else {
            // "Tampilkan setiap masuk": Hapus blokir agar iklan muncul lagi saat relog/refresh
            localStorage.removeItem(AD_HIDE_KEY);
        }
        
        // Tutup semua UI iklan
        adModal.classList.remove('show');
        adOptions.classList.remove('show');
    };

    // Jalankan pengecekan otomatis saat web dibuka
    // Diberi delay 1 detik agar tidak mengganggu proses load data awal
    setTimeout(checkAndShowAd, 1000);
});
        // --- Variabel State Global ---
        // Diperbarui: Menambah key untuk "Remember Me"
        const REMEMBER_ME_KEY = 'rememberedUser';
        const STORAGE_KEY = 'last_logged_in_user';
        // PERUBAHAN: Key baru untuk state halaman
        const LAST_PAGE_KEY = 'last_active_page';
        
        // ===== PERUBAHAN BARU: Key Iklan HANYA SEKALI TAMPIL =====
        const AD_SHOWN_KEY = 'ad_shown_once';
        // ========================================================

        // PERUBAHAN LOGIKA ABSENSI: Variabel state baru
        const GLOBAL_SESSION_STATE_KEY = 'global_attendance_state';
        let CURRENT_SESSION_STATE = { status: 'closed' }; // Default state
        
        let CURRENT_USER = {
            id: null,
            name: 'Pengguna',
            role: 'Mahasiswa',
            email: 'user@example.com',
            avatar: null,
            loggedIn: false,
            activeSessionToken: null // <-- PENAMBAHAN BARU
        };
        let currentAbsensiTarget = null; // Untuk menyimpan data Mahasiswa yang akan diabsen
        
        // --- VARIABEL BARU UNTUK RESET PASSWORD ---
        let userToResetId = null; 

        // PERUBAHAN FOTO PROFIL: URL default diubah sesuai permintaan
        const DEFAULT_AVATAR_URL = 'https://i.imgur.com/BVVboCP.png';
        
        // NEW: STATE UNTUK FITUR REPLY CHAT
        let replyingTo = null; 

        // --- FUNGSI UTILITY (Notifikasi dan Avatar) ---

        const notifBubble = document.getElementById('notification-bubble');
        const notifText = document.getElementById('notification-text');

        // *showNotification dipindahkan ke window scope*
        window.showNotification = function(message, duration = 3000) {
            notifText.textContent = message;
            notifBubble.classList.remove('hide');
            notifBubble.classList.add('show');
            setTimeout(() => {
                notifBubble.classList.remove('show');
                notifBubble.classList.add('hide');
            }, duration);
        }

        // --- FUNGSI UTILITY FIREBASE ---
        
     async function initializeDosenAccounts() {
    try {
        console.log("Memulai inisialisasi semua akun dosen...");
        
        // Loop melalui setiap dosen yang ada di array DOSEN_ACCOUNTS
        for (const dosenData of DOSEN_ACCOUNTS) {
            const userRef = ref(db, `users/${dosenData.id}`);
            const snapshot = await get(userRef);

            // Jika dosen tersebut belum ada di database, maka buatkan datanya
            if (!snapshot.exists()) {
                // Menyiapkan data dosen dengan nilai default
                const newDosen = {
                    ...dosenData, // Mengambil semua data dari array (id, name, password, email, dll)
                    attendance_count: 0,
                    exp: 0,
                    avatar: DEFAULT_AVATAR_URL,
                    jurusan: 'Sistem Informasi', // Tambahan jika diperlukan
                    kelas: 'Pagi'               // Tambahan jika diperlukan
                };

                await set(userRef, newDosen);
                console.log(`Akun Dosen ${dosenData.name} (${dosenData.id}) berhasil dibuat.`);
            }
        }
        
        console.log("Proses inisialisasi selesai. Semua dosen sudah diperiksa/didaftarkan.");
    } catch (error) {
        console.error("Gagal inisialisasi akun Dosen:", error);
        if (window.showNotification) {
            window.showNotification("â— Koneksi Firebase Gagal saat mendaftarkan dosen.", 5000);
        }
    }
}
        // FUNGSI UTAMA UNTUK MENGUNGGAH FILE BINARY KE RTDB (Base64)
        async function saveTugasToDB(dosenId, dataTugas) {
            try {
                // Tugas akan disimpan di: /tugas/{Dosen_ID}/{Task_ID}
                const tugasRef = ref(db, `tugas/${dosenId}`);
                const newTaskRef = push(tugasRef);
                await set(newTaskRef, dataTugas);
                console.log(`Tugas berhasil disimpan untuk dosen ${dosenId}.`);
                return true;
            } catch (error) {
                console.error("Gagal menyimpan tugas ke database:", error);
                window.showNotification("âŒ Gagal menyimpan tugas! Terjadi masalah koneksi database.", 5000);
                return false;
            }
        }
        
        async function getTugasForDosen(dosenId) {
            try {
                const snapshot = await get(child(ref(db), `tugas/${dosenId}`));
                if (snapshot.exists()) {
                    // Kita perlu mengonversi objek menjadi array dan menyimpan key-nya
                    const tugasObj = snapshot.val();
                    return Object.keys(tugasObj).map(key => ({
                        ...tugasObj[key],
                        key: key // Menyimpan key RTDB
                    }));
                }
                return [];
            } catch (error) {
                console.error("Gagal mengambil tugas untuk dosen:", error);
                window.showNotification("âŒ Gagal memuat daftar tugas dari database.", 5000);
                return [];
            }
        }
        
        async function saveAbsensiToDB(npm, studentName, signatureBase64) {
             try {
                const today = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
                // Simpan absensi di path: /absensi/{tanggal}/{npm}
                const absensiRef = ref(db, `absensi/${today.replace(/\//g, '-')}/${npm}`);
                
                const absensiData = {
                    studentName: studentName,
                    time: new Date().toLocaleTimeString('id-ID'),
                    signature: signatureBase64,
                    status: 'Hadir',
                    // PERUBAHAN LOGIKA ABSENSI: Ambil matkul dari state global
                    matkul: CURRENT_SESSION_STATE.matkulName || 'Tidak Diketahui'
                };

                await set(absensiRef, absensiData);
                console.log(`Absensi berhasil disimpan untuk NPM ${npm} pada tanggal ${today}.`);
                
                // Tambahkan EXP 10 saat berhasil absen (Mahasiswa)
                if (CURRENT_USER.role === 'Mahasiswa') {
                    await updateUserExp(npm, 10);
                }
                
                return true;
            } catch (error) {
                console.error("Gagal menyimpan absensi:", error);
                window.showNotification("âŒ Gagal menyimpan absensi! Terjadi masalah koneksi database.", 5000);
                return false;
            }
        }
        
        // FUNGSI BARU: Hitung Level dari EXP
        function getLevelFromExp(exp) {
            // Level 1: 0 - 99 EXP
            // Level 2: 100 - 249 EXP
            // Level 3: 250 - 499 EXP
            if (exp >= 250) return { level: 3, nextExp: 500 };
            if (exp >= 100) return { level: 2, nextExp: 250 };
            return { level: 1, nextExp: 100 };
        }
        
        // FUNGSI BARU: Update EXP pengguna
        async function updateUserExp(userId, expGain) {
            try {
                const userRef = ref(db, `users/${userId}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const currentExp = snapshot.val().exp || 0;
                    const newExp = currentExp + expGain;
                    
                    await update(userRef, { exp: newExp });
                    console.log(`EXP updated for ${userId}: +${expGain} EXP.`);
                    
                    // Jika user yang login sedang diupdate, perbarui local state (opsional)
                    if (CURRENT_USER.id === userId) {
                         const updatedUser = { ...CURRENT_USER, exp: newExp };
                         saveUserState(updatedUser);
                    }
                }
            } catch (error) {
                console.error("Gagal update EXP:", error);
            }
        }

        async function checkTodayAbsensi(npm) {
             try {
                const today = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
                const snapshot = await get(child(ref(db), `absensi/${today.replace(/\//g, '-')}/${npm}`));
                return snapshot.exists();
            } catch (error) {
                return false; 
            }
        }
        
        // --- PERUBAHAN LOGIKA ABSENSI: FUNGSI BARU UNTUK KONTROL SESI ---

        // Helper untuk parse jam "09:00 - 10:30" menjadi timestamp hari ini
        function parseJamToTimestamp(jamString) {
            const [startStr, endStr] = jamString.split(' - ');
            const [startHours, startMinutes] = startStr.split(':').map(Number);
            const [endHours, endMinutes] = endStr.split(':').map(Number);
            
            const today = new Date();
            
            const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), startHours, startMinutes, 0, 0);
            const endTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHours, endMinutes, 0, 0);
            
            return { startTime: startTime.getTime(), endTime: endTime.getTime() };
        }

   // ======================================= //
// === FUNGSI UNTUK UPLOAD FOTO PROFIL === //
// ======================================= //

// --- VARIABEL UNTUK UPLOAD FOTO ---
let selectedUploadMethod = null;
let selectedFile = null;

// --- VARIABEL UNTUK PREVIEW FOTO ---
let originalImage = null;
let previewImage = null;
let previewCanvas = null;
let previewCtx = null;
let currentZoom = 1.0;
let currentPositionX = 0;
let currentPositionY = 0;
let currentRotation = 0;
let isPreviewMode = false;

// --- FUNGSI UNTUK UPLOAD FOTO ---

// Fungsi untuk membuka modal upload
window.openUploadModal = function() {
    const modal = document.getElementById('upload-photo-modal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);
    resetUploadModal();
}

// Fungsi untuk menutup modal upload
window.closeUploadModal = function() {
    const modal = document.getElementById('upload-photo-modal');
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
    resetUploadModal();
}

// Fungsi untuk membuka modal preview
window.openPreviewModal = function(imageSrc, isBase64 = true) {
    const modal = document.getElementById('photo-preview-modal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);
    
    isPreviewMode = true;
    
    // Load gambar
    const img = new Image();
    img.onload = function() {
        originalImage = img;
        resetPreview(); // Reset ke posisi awal
        renderPreview();
    };
    
    if (isBase64) {
        img.src = imageSrc;
    } else {
        img.crossOrigin = 'anonymous';
        img.src = imageSrc;
    }
}

// Fungsi untuk menutup modal preview
window.closePreviewModal = function() {
    const modal = document.getElementById('photo-preview-modal');
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.style.display = 'none';
        resetPreview();
        isPreviewMode = false;
    }, 300);
}

// Reset modal ke keadaan awal
function resetUploadModal() {
    selectedUploadMethod = null;
    selectedFile = null;
    
    // Sembunyikan semua section
    document.getElementById('file-upload-section').classList.remove('active');
    document.getElementById('url-upload-section').classList.remove('active');
    
    // Reset input
    const fileInput = document.getElementById('photo-file-input');
    const urlInput = document.getElementById('photo-url-input');
    
    if (fileInput) fileInput.value = '';
    if (urlInput) urlInput.value = '';
    
    // Reset preview
    const filePreviewImg = document.getElementById('file-preview-image');
    const filePreviewText = document.getElementById('file-preview-text');
    const urlPreviewImg = document.getElementById('url-preview-image');
    const urlPreviewText = document.getElementById('url-preview-text');
    
    if (filePreviewImg) {
        filePreviewImg.src = '';
        filePreviewImg.style.display = 'none';
    }
    if (filePreviewText) {
        filePreviewText.textContent = '';
        filePreviewText.style.display = 'none';
    }
    if (urlPreviewImg) {
        urlPreviewImg.src = '';
        urlPreviewImg.style.display = 'none';
    }
    if (urlPreviewText) {
        urlPreviewText.textContent = '';
        urlPreviewText.style.display = 'none';
    }
    
    // Nonaktifkan tombol
    const uploadBtn = document.getElementById('upload-file-btn');
    const saveBtn = document.getElementById('save-url-btn');
    
    if (uploadBtn) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload Gambar';
    }
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Gunakan Gambar Ini';
    }
    
    // Sembunyikan status
    const statusElement = document.getElementById('upload-status');
    if (statusElement) {
        statusElement.style.display = 'none';
        statusElement.textContent = '';
        statusElement.className = 'alert-info';
    }
}

// Pilih metode upload
window.selectUploadOption = function(method) {
    selectedUploadMethod = method;
    
    // Reset dulu
    resetUploadModal();
    
    if (method === 'file') {
        const fileSection = document.getElementById('file-upload-section');
        if (fileSection) {
            fileSection.classList.add('active');
        }
    } else if (method === 'url') {
        const urlSection = document.getElementById('url-upload-section');
        if (urlSection) {
            urlSection.classList.add('active');
        }
    }
}

// --- FUNGSI UNTUK UPLOAD FILE ---

// Setup event listeners untuk upload file
function setupFileUploadListeners() {
    const fileInput = document.getElementById('photo-file-input');
    const uploadBtn = document.getElementById('upload-file-btn');
    
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }
    
    if (uploadBtn) {
        uploadBtn.addEventListener('click', handleFileUpload);
    }
}

// Handle file selection
function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validasi file
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    const maxSize = 2 * 1024 * 1024; // 2MB
    
    // Check file type
    const fileType = file.type.toLowerCase();
    const isValidType = validTypes.some(type => fileType.includes(type));
    
    if (!isValidType) {
        window.showNotification('âŒ Format file tidak didukung. Gunakan JPG, PNG, atau GIF.', 4000);
        this.value = '';
        return;
    }
    
    // Check file size
    if (file.size > maxSize) {
        window.showNotification('âŒ Ukuran file terlalu besar. Maksimal 2MB.', 4000);
        this.value = '';
        return;
    }
    
    selectedFile = file;
    
    // Tampilkan preview
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImg = document.getElementById('file-preview-image');
        const previewText = document.getElementById('file-preview-text');
        
        if (previewImg) {
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
        }
        if (previewText) {
            previewText.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            previewText.style.color = '#666';
            previewText.style.display = 'block';
        }
    };
    
    reader.readAsDataURL(file);
    
    // Aktifkan tombol upload
    const uploadBtn = document.getElementById('upload-file-btn');
    if (uploadBtn) {
        uploadBtn.disabled = false;
    }
}

// Upload dari file - LANGSUNG KE PREVIEW
async function handleFileUpload() {
    if (!selectedFile || !CURRENT_USER.id) return;
    
    try {
        // Baca file sebagai Base64
        const base64String = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(selectedFile);
        });
        
        // Langsung buka preview modal
        closeUploadModal();
        setTimeout(() => {
            openPreviewModal(base64String, true);
        }, 300);
        
    } catch (error) {
        console.error("Upload error:", error);
        window.showNotification('âŒ Gagal memuat gambar', 3000);
    }
}

// --- FUNGSI UNTUK UPLOAD VIA URL ---

// Setup event listeners untuk URL upload
function setupUrlUploadListeners() {
    const urlInput = document.getElementById('photo-url-input');
    const saveBtn = document.getElementById('save-url-btn');
    
    if (urlInput) {
        urlInput.addEventListener('input', handleUrlInput);
    }
    
    if (saveBtn) {
        saveBtn.addEventListener('click', handleUrlSave);
    }
}

// Handle URL input
function handleUrlInput() {
    const url = this.value.trim();
    const previewImg = document.getElementById('url-preview-image');
    const previewText = document.getElementById('url-preview-text');
    const saveBtn = document.getElementById('save-url-btn');
    
    if (!url) {
        if (previewImg) {
            previewImg.src = '';
            previewImg.style.display = 'none';
        }
        if (previewText) {
            previewText.textContent = '';
            previewText.style.display = 'none';
        }
        if (saveBtn) saveBtn.disabled = true;
        return;
    }
    
    // Validasi URL
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        if (previewText) {
            previewText.textContent = 'URL harus dimulai dengan http:// atau https://';
            previewText.style.color = '#dc3545';
            previewText.style.display = 'block';
        }
        if (saveBtn) saveBtn.disabled = true;
        return;
    }
    
    // Load preview
    const testImg = new Image();
    testImg.crossOrigin = 'anonymous';
    
    testImg.onload = function() {
        if (previewImg) {
            previewImg.src = url;
            previewImg.style.display = 'block';
        }
        if (previewText) {
            previewText.textContent = 'Gambar valid âœ“';
            previewText.style.color = '#28a745';
            previewText.style.display = 'block';
        }
        if (saveBtn) saveBtn.disabled = false;
    };
    
    testImg.onerror = function() {
        if (previewImg) {
            previewImg.src = '';
            previewImg.style.display = 'none';
        }
        if (previewText) {
            previewText.textContent = 'âŒ Tidak dapat memuat gambar';
            previewText.style.color = '#dc3545';
            previewText.style.display = 'block';
        }
        if (saveBtn) saveBtn.disabled = true;
    };
    
    testImg.src = url;
}

// Upload dari URL - LANGSUNG KE PREVIEW
async function handleUrlSave() {
    const url = document.getElementById('photo-url-input').value.trim();
    if (!url || !CURRENT_USER.id) return;
    
    const saveBtn = this;
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
    
    try {
        // Fetch gambar dari URL
        const response = await fetch(url, { mode: 'cors' });
        
        if (!response.ok) {
            throw new Error('Gagal mengambil gambar');
        }
        
        const blob = await response.blob();
        
        // Konversi ke Base64
        const base64String = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(blob);
        });
        
        // Langsung buka preview modal
        closeUploadModal();
        setTimeout(() => {
            openPreviewModal(base64String, true);
        }, 300);
        
    } catch (error) {
        console.error("URL upload error:", error);
        window.showNotification('âŒ Gagal memuat gambar dari URL', 3000);
        saveBtn.innerHTML = '<i class="fas fa-times"></i> Gagal';
        saveBtn.disabled = false;
    }
}

// ======================================= //
// === FUNGSI PREVIEW & EDIT FOTO === //
// ======================================= //

// Inisialisasi preview
function initPreviewSystem() {
    previewCanvas = document.getElementById('photo-preview-canvas');
    if (!previewCanvas) return;
    
    previewCanvas.width = 300;
    previewCanvas.height = 300;
    previewCtx = previewCanvas.getContext('2d');
    
    // Setup event listeners untuk kontrol
    setupPreviewControls();
}

// Setup kontrol preview
function setupPreviewControls() {
    // Tombol zoom
    document.getElementById('zoom-in-btn')?.addEventListener('click', () => adjustZoom(0.1));
    document.getElementById('zoom-out-btn')?.addEventListener('click', () => adjustZoom(-0.1));
    
    // Slider posisi
    document.getElementById('position-x-slider')?.addEventListener('input', (e) => {
        currentPositionX = parseInt(e.target.value);
        renderPreview();
    });
    
    document.getElementById('position-y-slider')?.addEventListener('input', (e) => {
        currentPositionY = parseInt(e.target.value);
        renderPreview();
    });
    
    // Slider rotasi
    document.getElementById('rotate-slider')?.addEventListener('input', (e) => {
        currentRotation = parseInt(e.target.value);
        renderPreview();
    });
    
    // Tombol reset
    document.getElementById('reset-all-btn')?.addEventListener('click', resetPreview);
    
    // Tombol hapus foto
    document.getElementById('delete-photo-btn')?.addEventListener('click', deleteCurrentPhoto);
    
    // Tombol simpan foto
    document.getElementById('save-photo-btn')?.addEventListener('click', savePreviewPhoto);
}

// Adjust zoom
function adjustZoom(delta) {
    currentZoom = Math.max(0.1, Math.min(3.0, currentZoom + delta));
    document.getElementById('zoom-level-text').textContent = `${Math.round(currentZoom * 100)}%`;
    renderPreview();
}

// Reset semua pengaturan
function resetPreview() {
    currentZoom = 1.0;
    currentPositionX = 0;
    currentPositionY = 0;
    currentRotation = 0;
    
    // Update UI
    document.getElementById('zoom-level-text').textContent = '100%';
    document.getElementById('position-x-slider').value = 0;
    document.getElementById('position-y-slider').value = 0;
    document.getElementById('rotate-slider').value = 0;
    
    if (originalImage) {
        renderPreview();
    }
}

// Render preview dengan transformasi
function renderPreview() {
    if (!previewCanvas || !previewCtx || !originalImage) return;
    
    // Clear canvas
    previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
    
    // Hitung ukuran gambar setelah zoom
    const scaledWidth = originalImage.width * currentZoom;
    const scaledHeight = originalImage.height * currentZoom;
    
    // Hitung posisi untuk menjaga gambar di tengah
    const centerX = previewCanvas.width / 2;
    const centerY = previewCanvas.height / 2;
    
    // Simpan state canvas
    previewCtx.save();
    
    // Pindahkan ke tengah canvas
    previewCtx.translate(centerX, centerY);
    
    // Rotasi
    previewCtx.rotate((currentRotation * Math.PI) / 180);
    
    // Gambar gambar
    previewCtx.drawImage(
        originalImage,
        -scaledWidth / 2 + currentPositionX,
        -scaledHeight / 2 + currentPositionY,
        scaledWidth,
        scaledHeight
    );
    
    // Restore state canvas
    previewCtx.restore();
}

// Fungsi hapus foto
async function deleteCurrentPhoto() {
    if (!CURRENT_USER.id) return;
    
    if (!confirm('Apakah Anda yakin ingin menghapus foto profil?')) {
        return;
    }
    
    try {
        // Update ke database dengan avatar default
        const userRef = ref(db, `users/${CURRENT_USER.id}`);
        await update(userRef, {
            avatar: DEFAULT_AVATAR_URL,
            avatarUpdated: new Date().toISOString(),
            avatarSource: 'deleted'
        });
        
        window.showNotification('âœ… Foto profil berhasil dihapus!', 3000);
        closePreviewModal();
        
        // Reload setelah 1.5 detik
        setTimeout(() => {
            location.reload();
        }, 1500);
        
    } catch (error) {
        console.error("Error deleting photo:", error);
        window.showNotification('âŒ Gagal menghapus foto profil', 3000);
    }
}

// Fungsi simpan foto setelah edit
async function savePreviewPhoto() {
    if (!previewCanvas || !CURRENT_USER.id) return;
    
    const saveBtn = document.getElementById('save-photo-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
    
    const statusElement = document.getElementById('preview-status');
    if (statusElement) {
        statusElement.style.display = 'block';
        statusElement.textContent = 'Menyimpan foto...';
        statusElement.className = 'alert-info';
    }
    
    try {
        // 1. Konversi canvas ke Base64
        const base64String = previewCanvas.toDataURL('image/png');
        
        // 2. Simpan ke database
        const userRef = ref(db, `users/${CURRENT_USER.id}`);
        await update(userRef, {
            avatar: base64String,
            avatarUpdated: new Date().toISOString(),
            avatarSource: 'edited'
        });
        
        // Tampilkan pesan sukses
        if (statusElement) {
            statusElement.textContent = 'âœ… Foto berhasil disimpan!';
            statusElement.className = 'alert-success';
        }
        
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Berhasil!';
        
        // TUTUP MODAL DAN RELOAD SETELAH 2 DETIK
        setTimeout(() => {
            closePreviewModal();
            
            // Tampilkan notifikasi
            window.showNotification('âœ… Foto profil berhasil disimpan!', 1000);
            
            // Reload website setelah 1.5 detik
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        }, 2000);
        
    } catch (error) {
        console.error("Error saving preview photo:", error);
        
        if (statusElement) {
            statusElement.textContent = 'âŒ Gagal menyimpan foto';
            statusElement.className = 'alert-warning';
        }
        
        saveBtn.innerHTML = '<i class="fas fa-times"></i> Gagal';
        saveBtn.disabled = false;
    }
}

// --- INISIALISASI SAAT PAGE LOAD ---
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ”„ Initializing photo upload system...');
    
    // Cek status upload sebelumnya
    const lastUploadStatus = localStorage.getItem('last_upload_status');
    if (lastUploadStatus) {
        if (lastUploadStatus === 'success') {
            // Tampilkan notifikasi sukses dari upload sebelumnya
            setTimeout(() => {
                if (window.showNotification) {
                    window.showNotification('âœ… Foto profil berhasil diupdate!', 3000);
                }
            }, 1000);
        }
        // Hapus status setelah ditampilkan
        localStorage.removeItem('last_upload_status');
    }
    
    // Tunggu untuk pastikan semua elemen sudah load
    setTimeout(() => {
        setupFileUploadListeners();
        setupUrlUploadListeners();
        
        // Setup tombol close modal
        const closeBtn = document.querySelector('#upload-photo-modal .ad-close-btn');
        if (closeBtn) {
            closeBtn.onclick = closeUploadModal;
        }
        
        // Setup overlay click untuk modal upload
        const modal = document.getElementById('upload-photo-modal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUploadModal();
                }
            });
        }
        
        // Setup tombol update photo di profile page
        const updatePhotoBtn = document.getElementById('btn-update-photo-url');
        if (updatePhotoBtn) {
            updatePhotoBtn.onclick = function(e) {
                e.preventDefault();
                openUploadModal();
            };
        }
        
        // Setup tombol hapus foto di profile page
        const deletePhotoBtn = document.getElementById('btn-delete-photo');
        if (deletePhotoBtn) {
            deletePhotoBtn.onclick = function(e) {
                e.preventDefault();
                deleteCurrentPhoto();
            };
        }
        
        // Setup klik pada gambar profil utama
        const profileImg = document.getElementById('profile-pic-img');
        if (profileImg) {
            profileImg.onclick = function(e) {
                e.preventDefault();
                openUploadModal();
            };
            profileImg.style.cursor = 'pointer';
            profileImg.title = "Klik untuk ganti foto profil";
        }
        
        // Setup klik pada gambar profil navbar
        const navbarProfileImg = document.querySelector('.navbar-right .user-info img');
        if (navbarProfileImg) {
            navbarProfileImg.onclick = function(e) {
                e.preventDefault();
                openUploadModal();
            };
            navbarProfileImg.style.cursor = 'pointer';
            navbarProfileImg.title = "Klik untuk ganti foto profil";
        }
        
        // Inisialisasi preview system
        initPreviewSystem();
        
        // Setup overlay click untuk modal preview
        const previewModal = document.getElementById('photo-preview-modal');
        if (previewModal) {
            previewModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closePreviewModal();
                }
            });
        }
        
        console.log('âœ… Photo upload system initialized');
        
    }, 1000);
});

// Tambahkan CSS untuk styling
if (!document.querySelector('#upload-photo-styles')) {
    const style = document.createElement('style');
    style.id = 'upload-photo-styles';
    style.textContent = `
        #file-upload-section,
        #url-upload-section {
            display: none;
            margin-top: 20px;
        }
        
        #file-upload-section.active,
        #url-upload-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .file-preview,
        .url-preview {
            margin: 15px 0;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #dee2e6;
        }
        
        .file-preview img,
        .url-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 6px;
            border: 2px solid #ddd;
            display: none;
        }
        
        #file-preview-text,
        #url-preview-text {
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #upload-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            animation: fadeIn 0.3s ease;
        }
        
        /* CSS untuk Preview Modal */
        #photo-preview-modal .modal-content {
            max-width: 500px;
            padding: 25px;
        }
        
        .preview-main-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        #photo-preview-canvas {
            width: 100%;
            max-width: 300px;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
            object-fit: contain;
        }
        
        .preview-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .zoom-controls button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: var(--sidebar-bg);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .zoom-controls button:hover {
            background-color: var(--sidebar-hover);
        }
        
        .zoom-controls span {
            font-weight: 600;
            color: #333;
            min-width: 60px;
            text-align: center;
        }
        
        .position-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .position-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .position-slider label {
            font-size: 14px;
            color: #333;
            min-width: 80px;
            font-weight: 500;
        }
        
        .position-slider input[type="range"] {
            flex-grow: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        
        .position-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--sidebar-bg);
            cursor: pointer;
        }
        
        .reset-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Tombol Hapus Foto */
        #delete-photo-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        #delete-photo-btn:hover {
            background-color: #c82333;
        }
        
        #delete-photo-btn i {
            font-size: 14px;
        }
        
        .preview-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            width: 100%;
        }
        
        #cancel-preview-btn {
            background-color: #6c757d;
            color: white;
        }
        
        #save-photo-btn {
            background-color: var(--button-primary);
            color: white;
        }
        
        .preview-crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px dashed var(--sidebar-bg);
            pointer-events: none;
            display: none;
        }
        
        .preview-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            max-height: 300px;
            overflow: hidden;
            border-radius: 10px;
        }
    `;
    document.head.appendChild(style);
}
        
        // 4. Fungsi Dosen untuk menutup sesi manual (Jika diperlukan)
        window.handleManualCloseAbsen = async function() {
            if (CURRENT_USER.role !== 'Dosen' || CURRENT_USER.id !== CURRENT_SESSION_STATE.dosenId) {
                window.showNotification("âŒ Anda tidak berhak menutup sesi ini.", 4000);
                return;
            }
            
            try {
                // Menutup sesi saat ini
                const sessionRef = ref(db, GLOBAL_SESSION_STATE_KEY);
                // Kita set ke 'closed' dan cari jam matkul berikutnya
                const expectedState = getCurrentExpectedState(); // Cek lagi
                let newState = { status: 'closed' };
                
                // Cari matkul berikutnya (yang start timenya di masa depan)
                const dayIndex = new Date().getDay();
                const todaySchedule = PARSED_SCHEDULE[dayIndex];
                if (todaySchedule) {
                    for (const course of todaySchedule) {
                        if (course.startTime > Date.now()) {
                            newState.nextSessionTime = course.startTime;
                            break;
                        }
                    }
                }

                await set(sessionRef, newState);
                window.showNotification(`âœ… Sesi ${CURRENT_SESSION_STATE.matkulName} ditutup manual.`, 3000);
                // Listener onValue akan refresh UI
            } catch (error) {
                console.error("Gagal menutup sesi:", error);
                window.showNotification("âŒ Gagal menutup sesi. Koneksi error.", 5000);
            }
        }

        // --- FUNGSI INTI LOGIC AUTHENTICATION ---

        async function registerMahasiswa(npm, name, password) {
            const userRef = ref(db, `users/${npm}`); 
            
            // --- VALIDASI BARU: Cek NPM di daftar yang diizinkan ---
            if (!ALLOWED_NPMS.includes(npm)) {
                window.showNotification("âŒ Pendaftaran gagal! NPM tidak valid atau tidak terdaftar di daftar NPM yang diizinkan.", 5000);
                return false;
            }

            try {
                const snapshot = await get(userRef);

                if (snapshot.exists()) {
                    window.showNotification("âŒ Pendaftaran gagal! NPM sudah terdaftar di database.", 4000);
                    return false;
                }

                const userData = {
                    id: npm, 
                    npm: npm,
                    name: name,
                    password: password, 
                    role: 'Mahasiswa',
                    email: `${npm.toLowerCase()}@mahasiswa.ac.id`,
                    // PERUBAHAN FOTO PROFIL: Set avatar default baru
                    avatar: DEFAULT_AVATAR_URL, 
                    // EXP BARU
                    exp: 0,
                    // SET DEFAULT JURUSAN/KELAS
                    jurusan: 'Sistem Informasi',
                    kelas: 'Pagi',
                    tugas_count: 0 // Inisialisasi hitungan tugas
                };
            
                await set(userRef, userData);
                window.showNotification("âœ… Pendaftaran berhasil! Silakan masuk.", 4000);
                return true;

            } catch (error) {
                 console.error("Gagal menyimpan data Mahasiswa:", error);
                 window.showNotification("âŒ Pendaftaran gagal! Terjadi masalah koneksi database.", 5000);
                 return false;
            }
        }

        async function loginMahasiswa(npm, password) {
            try {
                const userRef = ref(db, `users/${npm}`); 
                const snapshot = await get(userRef);

                if (!snapshot.exists()) {
                    window.showNotification("âŒ Login gagal. NPM tidak terdaftar.", 4000);
                    return null;
                }

                const userData = snapshot.val();
                if (userData.role !== 'Mahasiswa') {
                     window.showNotification("âŒ Login gagal. ID ini bukan untuk Mahasiswa.", 4000);
                     return null;
                }
                if (userData.password === password) {
                    return userData; 
                } else {
                    window.showNotification("âŒ Login gagal. Password salah.", 4000);
                    return null;
                }
            } catch (error) {
                console.error("Gagal mengambil data Mahasiswa:", error);
                window.showNotification("âŒ Login gagal! Terjadi masalah koneksi database.", 5000);
                return null;
            }
        }
        
        async function loginDosen(id, password) {
    try {
        console.log(`Mencoba login dosen dengan ID: ${id}`);
        
        const userRef = ref(db, `users/${id}`); 
        const snapshot = await get(userRef);

        if (!snapshot.exists()) {
            console.log(`Dosen dengan ID ${id} tidak ditemukan di database`);
            window.showNotification("âŒ Login Dosen gagal. NIDN/ID tidak ditemukan.", 4000);
            return null;
        }

        const userData = snapshot.val();
        console.log("Data dosen ditemukan:", userData);
        
        if (userData.role !== 'Dosen') {
            console.log(`ID ${id} bukan role Dosen, role: ${userData.role}`);
            window.showNotification("âŒ Login gagal. ID ini bukan untuk Dosen.", 4000);
            return null;
        }
        
        if (userData.password === password) {
            console.log("Password cocok, login berhasil");
            
            // Tambahkan properti yang diperlukan jika belum ada
            userData.id = id;
            userData.npm = id; // Untuk kompatibilitas
            userData.email = userData.email || `${id.toLowerCase()}@dosen.ac.id`;
            userData.avatar = userData.avatar || DEFAULT_AVATAR_URL;
            userData.exp = userData.exp || 0;
            userData.jurusan = userData.jurusan || 'Sistem Informasi';
            userData.kelas = userData.kelas || 'Pagi';
            userData.mata_kuliah = userData.mata_kuliah || 'Umum';
            
            return userData; 
        } else {
            console.log("Password salah");
            window.showNotification("âŒ Login Dosen gagal. Password salah.", 4000);
            return null;
        }
    } catch (error) {
        console.error("Gagal mengambil data Dosen:", error);
        window.showNotification("âŒ Login gagal! Terjadi masalah koneksi database.", 5000);
        return null;
    }
}
        /**
 * Menampilkan menu konteks saat chat di-klik (VERSI TENGAH)
 */
// Fungsi yang sudah benar untuk showChatContextMenu
window.showChatContextMenu = function(event, messageId, senderId, senderName, text) {
    // 1. Simpan data ke menu untuk diakses nanti
    const chatContextMenu = document.getElementById('chat-context-menu');
    chatContextMenu.dataset.messageId = messageId;
    chatContextMenu.dataset.senderId = senderId;
    chatContextMenu.dataset.senderName = senderName;
    chatContextMenu.dataset.text = text;

    // 2. Tampilkan/Sembunyikan "Hapus untuk semua"
    const deleteEveryoneOption = document.getElementById('ctx-delete-all');
    if (senderId === CURRENT_USER.id) {
        deleteEveryoneOption.style.display = 'flex';
    } else {
        deleteEveryoneOption.style.display = 'none';
    }

    // 3. Atur Posisi Menu ke tengah
    chatContextMenu.style.display = 'block';
    
    // 4. TAMPILKAN OVERLAY
    const overlay = document.getElementById('overlay');
    overlay.style.zIndex = 1099;
    overlay.classList.add('active');

    // 5. Tambahkan listener untuk menutup menu
    setTimeout(() => {
        document.removeEventListener('click', window.hideChatContextMenu);
        overlay.addEventListener('click', window.hideChatContextMenu, { once: true });
    }, 0);
}

/**
 * Menyembunyikan menu konteks (VERSI TENGAH)
 */
window.hideChatContextMenu = function() {
    if (chatContextMenu) {
        chatContextMenu.style.display = 'none';
        // Hapus data
        delete chatContextMenu.dataset.messageId;
        delete chatContextMenu.dataset.senderId;
        delete chatContextMenu.dataset.senderName;
        delete chatContextMenu.dataset.text;
    }
    
    // SEMBUNYIKAN OVERLAY
    const overlay = document.getElementById('overlay');
    overlay.classList.remove('active');
    overlay.style.zIndex = 920; // Kembalikan z-index default (untuk sidebar)
    
    // Hapus listener dari overlay
    overlay.removeEventListener('click', window.hideChatContextMenu);
    // Hapus listener dari document (jaga-jaga)
    document.removeEventListener('click', window.hideChatContextMenu);
}


        // --- FUNGSI RENDER DASHBOARD (ROLE-BASED) ---

        // FUNGSI BARU: Simpan Nilai Tugas
        window.rateTugas = async function(dosenId, tugasKey, fileName, currentNilai) {
             const newNilai = prompt(`Masukkan Nilai Tugas (${fileName}):`, currentNilai || '');

             if (newNilai === null) return; // Dibatalkan
             const nilai = parseFloat(newNilai.trim());

             if (isNaN(nilai) || nilai < 0 || nilai > 100) {
                 window.showNotification("âŒ Nilai harus angka antara 0 hingga 100.", 4000);
                 return;
             }

             try {
                 const tugasRef = ref(db, `tugas/${dosenId}/${tugasKey}`);
                 await update(tugasRef, { 
                     nilai: nilai,
                     status: 'Dinilai'
                 });
                 
                 // Beri EXP 25 saat tugas dinilai
                 const tugasSnapshot = await get(tugasRef);
                 const npmTugas = tugasSnapshot.val().npm;
                 await updateUserExp(npmTugas, 25);
                 
                 window.showNotification(`âœ… Tugas ${fileName} berhasil dinilai: ${nilai}`, 3000);
                 window.renderDosenTugas(); // Muat ulang tabel tugas
             } catch (error) {
                 console.error("Gagal menyimpan nilai tugas:", error);
                 window.showNotification("âŒ Gagal menyimpan nilai di database.", 5000);
             }
        }


// *Dipindahkan ke window scope*
window.renderDosenTugas = async function() {
    const moduleCard = document.getElementById('module-card');
    const mataKuliah = CURRENT_USER.mata_kuliah || 'Tidak Diketahui';
    const tugasList = await getTugasForDosen(CURRENT_USER.id);
    
    // Simpan data ke window agar bisa difilter saat mengetik di kolom pencarian
    window.ALL_TUGAS_DOSEN = tugasList;

    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <h3 style="margin: 0;">Daftar Tugas Mahasiswa</h3>
                <p style="color: #666; font-size: 13px; background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107; margin-top: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> Sebelum anda menghapus log tugas harap beritahukan kepada mahasiswa terlebih dahulu
                </p>
                <p style="margin: 5px 0;">Mata Kuliah Anda: <strong>${mataKuliah}</strong></p>
            </div>
            ${tugasList.length > 0 ? `
                <button class="btn-action btn-delete" onclick="window.hapusSemuaTugasDosen()" style="background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-trash-alt"></i> Hapus Semua Daftar Tugas
                </button>
            ` : ''}
        </div>
        
        <div style="margin-top: 25px; margin-bottom: 15px; position: relative; max-width: 400px;">
            <i class="fas fa-search" style="position: absolute; left: 12px; top: 12px; color: #aaa;"></i>
            <input type="text" id="search-tugas-dosen" placeholder="Cari Nama, NPM, atau Nama File..." 
                style="width: 100%; padding: 10px 10px 10px 35px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        </div>

        <div id="container-tabel-dosen">
            ${renderTabelDosenContent(tugasList)}
        </div>
    `;
    moduleCard.innerHTML = html;

    // Listener untuk Live Search (Pencarian Otomatis)
    const searchInput = document.getElementById('search-tugas-dosen');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const keyword = e.target.value.toLowerCase();
            
            // Filter data berdasarkan Nama Mahasiswa, NPM, atau Nama File
            const filteredData = window.ALL_TUGAS_DOSEN.filter(t => 
                (t.studentName && t.studentName.toLowerCase().includes(keyword)) || 
                (t.npm && t.npm.toLowerCase().includes(keyword)) || 
                (t.fileName && t.fileName.toLowerCase().includes(keyword))
            );
            
            // Update isi tabel saja tanpa merender ulang seluruh halaman
            document.getElementById('container-tabel-dosen').innerHTML = renderTabelDosenContent(filteredData);
        });
    }
}

// FUNGSI HELPER: Memisahkan isi tabel agar bisa dipanggil ulang oleh fitur search
function renderTabelDosenContent(data) {
    if (data.length === 0) {
        return `
            <div class="alert-warning" style="margin-top: 20px;">
                Data tidak ditemukan atau belum ada tugas yang diunggah.
            </div>
        `;
    }

    return `
        <div class="table-responsive" style="margin-top: 10px;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>NPM</th>
                        <th>Nama Mahasiswa</th>
                        <th>Tugas</th>
                        <th>Nilai</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map((tugas, index) => {
                        const nilaiDisplay = tugas.nilai !== undefined && tugas.nilai !== null ? tugas.nilai : '-';
                        const nilaiBtnText = tugas.nilai !== undefined && tugas.nilai !== null ? 'Edit Nilai' : 'Beri Nilai';
                        const nilaiColor = tugas.nilai ? (tugas.nilai >= 70 ? 'green' : 'red') : '#333';
                        
                        return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${tugas.npm}</td>
                            <td><strong>${tugas.studentName || 'Tanpa Nama'}</strong></td>
                            <td>
                                <a href="#" onclick="event.preventDefault(); window.downloadTugas('${tugas.fileBase64 || ''}', '${tugas.fileName}', '${tugas.fileType || 'application/octet-stream'}')" style="color: var(--button-secondary); text-decoration: underline;">
                                    ${tugas.fileName}
                                </a>
                                <i class="fas fa-download" style="margin-left: 5px; color: var(--button-secondary);"></i>
                            </td>
                            <td><span style="font-weight: bold; color: ${nilaiColor}">${nilaiDisplay}</span></td>
                            <td>${tugas.status}</td>
                            <td class="table-actions">
                                <button class="btn-action btn-secondary" onclick="window.rateTugas('${tugas.dosenId}', '${tugas.key}', '${tugas.fileName}', ${tugas.nilai || null})">
                                    <i class="fas fa-edit"></i> ${nilaiBtnText}
                                </button>
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        </div>
    `;
}
window.hapusSemuaTugasDosen = async function() {
    // 1. Konfirmasi pertama
    if (!confirm("Apakah Anda yakin ingin MENGHAPUS SEMUA daftar tugas yang masuk? Tindakan ini tidak dapat dibatalkan.")) {
        return;
    }

    // 2. Konfirmasi kedua untuk keamanan data
    const inputKonfirmasi = prompt("Ketik 'HAPUS' untuk mengonfirmasi pembersihan daftar tugas:");
    
    if (inputKonfirmasi === "HAPUS") {
        try {
            // Referensi path tugas berdasarkan ID Dosen di Firebase
            // Pastikan Anda sudah mengimpor 'ref' dan 'remove' dari firebase/database
            const { ref, remove } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const tugasRef = ref(db, `tugas/${CURRENT_USER.id}`);
            
            await remove(tugasRef);
            
            alert("Berhasil! Daftar tugas telah dibersihkan.");
            
            // Refresh tampilan
            window.renderDosenTugas();
            
        } catch (error) {
            console.error("Gagal menghapus tugas:", error);
            alert("Terjadi kesalahan saat mencoba menghapus data.");
        }
    } else {
        alert("Konfirmasi gagal. Data tidak dihapus.");
    }
}
        
        // FUNGSI BARU: Download file Base64
        window.downloadTugas = function(base64Data, fileName, fileType) {
            if (!base64Data) {
                window.showNotification(`âŒ File untuk ${fileName} tidak ditemukan atau kosong.`, 4000);
                return;
            }

            try {
                 // Konversi Base64 menjadi Blob
                const byteCharacters = atob(base64Data.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: fileType });

                // Buat URL untuk Blob dan simulasikan klik link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                window.showNotification(`âœ… File ${fileName} berhasil diunduh.`, 3000);

            } catch (error) {
                console.error("Download Error:", error);
                window.showNotification(`âŒ Gagal mengunduh file ${fileName}. Coba lagi.`, 5000);
            }
           
        }

     
window.renderMahasiswaTugas = async function() {
    const moduleCard = document.getElementById('module-card');
    
    let dosenList = [];
    let tugasHistory = [];

    try {
        const usersSnapshot = await get(child(ref(db), `users/`));
        if (usersSnapshot.exists()) {
            Object.values(usersSnapshot.val()).forEach(user => {
                if (user.role === 'Dosen') {
                    dosenList.push(user);
                }
            });
        }
        
        const tugasRootRef = ref(db, 'tugas');
        const tugasSnapshot = await get(tugasRootRef);
        if (tugasSnapshot.exists()) {
            const allDosenTugas = tugasSnapshot.val();
            for (const dosenId in allDosenTugas) {
                for (const taskId in allDosenTugas[dosenId]) {
                    const tugas = allDosenTugas[dosenId][taskId];
                    if (tugas.npm === CURRENT_USER.id) {
                        const dosenInfo = dosenList.find(d => d.id === dosenId);
                        tugas.dosenName = dosenInfo ? dosenInfo.name : 'Dosen Tidak Dikenal';
                        tugasHistory.push(tugas);
                    }
                }
            }
        }
        // Urutkan dari yang terbaru
        tugasHistory.sort((a, b) => new Date(b.dateSubmitted) - new Date(a.dateSubmitted));
        
        // Simpan data ke window agar bisa diakses oleh fungsi search dan PDF
        window.CURRENT_TUGAS_HISTORY = tugasHistory;

    } catch (error) {
        console.error("Gagal memuat data:", error);
        window.showNotification("âŒ Gagal memuat riwayat tugas.", 5000);
    }
    
    const dosenOptions = dosenList.map(dosen => 
        `<option value="${dosen.id}" data-matkul="${dosen.mata_kuliah}">${dosen.name} (${dosen.mata_kuliah})</option>`
    ).join('');
    
    const isDosenAvailable = dosenList.length > 0;

    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <h3 style="margin:0;">Upload Tugas Mahasiswa</h3>
            ${tugasHistory.length > 0 ? `
                <button onclick="window.downloadLaporanPDF()" class="btn-action" style="background-color: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px;">
                    <i class="fas fa-file-pdf"></i> Download Hasil Tugas (PDF)
                </button>
            ` : ''}
        </div>

        <p style="color: #666; font-size: 13px; background: #fff3cd; padding: 12px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 30px;">
            <i class="fas fa-exclamation-triangle"></i> Jangan lupa untuk mengunduh hasil tugas Anda dalam format PDF sebelum dosen menghapus log tugas anda.
        </p>

        <div class="select-group">
            <label for="pilih-dosen"><i class="fas fa-chalkboard-teacher"></i> Pilih Dosen Pengampu:</label>
            <select id="pilih-dosen" ${!isDosenAvailable ? 'disabled' : ''}>
                <option value="" disabled selected>${isDosenAvailable ? 'Pilih Dosen...' : 'Tidak ada dosen tersedia'}</option>
                ${dosenOptions}
            </select>
        </div>

        <div class="action-bar" style="flex-direction: column;">
             <div class="input-group" style="width: 100%; border-radius: 5px; background-color: #f8f9fa; border: 1px solid #ddd; padding: 10px;">
                <i class="icon fas fa-folder-open" style="color: #6c757d;"></i>
                <input type="file" id="file-tugas" style="color: #333; margin-left: 10px;" ${!isDosenAvailable ? 'disabled' : ''}>
            </div>
            <button class="btn-action btn-primary" id="btn-submit-tugas" style="width: 100%; margin-top: 10px;" ${!isDosenAvailable ? 'disabled' : ''}>
                <i class="fas fa-cloud-upload-alt"></i> Upload File Tugas
            </button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h4 style="font-size: 16px; margin: 0; color: #555;"><i class="fas fa-star"></i> Log Nilai Tugas Anda:</h4>
            <div style="position: relative; width: 250px;">
                <i class="fas fa-search" style="position: absolute; left: 10px; top: 10px; color: #aaa;"></i>
                <input type="text" id="search-tugas-input" placeholder="Cari nama file..." 
                    style="width: 100%; padding: 7px 10px 7px 30px; border-radius: 20px; border: 1px solid #ddd; font-size: 13px; outline: none;">
            </div>
        </div>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Dosen (Mata Kuliah)</th>
                        <th>Tanggal</th>
                        <th>Status</th>
                        <th>Nilai</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="riwayat-nilai-table-body">
                    ${renderTugasRows(tugasHistory)}
                </tbody>
            </table>
        </div>
    `;
    moduleCard.innerHTML = html;

    // Listener untuk Upload
    const btnSubmitTugas = document.getElementById('btn-submit-tugas');
    if (btnSubmitTugas && isDosenAvailable) {
        btnSubmitTugas.addEventListener('click', handleTugasSubmission);
    }

    // Listener untuk Pencarian (Live Search)
    const searchInput = document.getElementById('search-tugas-input');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const keyword = e.target.value.toLowerCase();
            const filteredData = window.CURRENT_TUGAS_HISTORY.filter(t => 
                t.fileName.toLowerCase().includes(keyword)
            );
            document.getElementById('riwayat-nilai-table-body').innerHTML = renderTugasRows(filteredData);
        });
    }
}

// FUNGSI HELPER DIPERBARUI: Ditambah tombol "Lihat File"
function renderTugasRows(data) {
    if (data.length === 0) {
        return `<tr><td colspan="6" style="text-align: center; color: #888;">Tugas tidak ditemukan.</td></tr>`;
    }
    return data.map(tugas => {
        const nilaiColor = tugas.nilai ? (tugas.nilai >= 70 ? 'green' : 'red') : '#333';
        return `
            <tr>
                <td style="font-weight: 500;">${tugas.fileName}</td>
                <td>${tugas.dosenName} (${tugas.mata_kuliah || 'Matakuliah'})</td>
                <td>${tugas.dateSubmitted}</td>
                <td><span class="badge">${tugas.status}</span></td>
                <td><span style="font-weight: bold; color: ${nilaiColor};">${tugas.nilai || '-'}</span></td>
                <td>
                    <button class="btn-action btn-secondary" style="padding: 4px 8px; font-size: 11px;" 
                        onclick="window.downloadTugas('${tugas.fileBase64 || ''}', '${tugas.fileName}', '${tugas.fileType || 'application/octet-stream'}')">
                        <i class="fas fa-download"></i> Lihat File
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}
window.downloadLaporanPDF = function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const data = window.CURRENT_TUGAS_HISTORY || [];

    // Header
    doc.setFontSize(18);
    doc.text("LAPORAN HASIL TUGAS MAHASISWA", 14, 20);
    
    doc.setFontSize(11);
  // Ganti bagian ini di fungsi downloadLaporanPDF
doc.text(`Nama Mahasiswa : ${CURRENT_USER.nama || CURRENT_USER.name || CURRENT_USER.Nama || 'Mahasiswa'}`, 14, 30);
    
    doc.text(`NPM            : ${CURRENT_USER.id}`, 14, 36);
    doc.text(`Tanggal Cetak  : ${new Date().toLocaleString('id-ID')}`, 14, 42);

    // Header Tabel
    const tableColumn = ["No", "Mata Kuliah", "Tugas", "Tanggal", "Nilai", "Status"];
    const tableRows = [];

    data.forEach((t, index) => {
        const rowData = [
            index + 1,
            t.mata_kuliah || "Matakuliah",
            t.fileName,
            t.dateSubmitted,
            t.nilai || "-",
            t.status
        ];
        tableRows.push(rowData);
    });

    // Membuat Tabel
    doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 50,
        theme: 'striped',
        headStyles: { fillColor: [41, 128, 185] }, // Warna Biru
        styles: { fontSize: 9 }
    });

    // Simpan File
    doc.save(`Laporan_Tugas_${CURRENT_USER.id}.pdf`);
    window.showNotification("âœ… Laporan PDF berhasil dibuat!");
};
        // --- RENDER CONTROL DOSEN UNTUK ABSENSI (DIRUBAH TOTAL) ---
        function renderDosenControlPanel() {
            const wrapper = document.getElementById('mahasiswa-content-wrapper');
            let controlHTML = '';
            
            // Logika berdasarkan CURRENT_SESSION_STATE
            switch(CURRENT_SESSION_STATE.status) {
                case 'open':
                    const endTime = new Date(CURRENT_SESSION_STATE.sessionEndTime).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    controlHTML = `
                        <div class="alert-success">
                            <i class="fas fa-lock-open"></i> Absensi <strong>${CURRENT_SESSION_STATE.matkulName}</strong> sedang **TERBUKA**.
                            <br>
                            <small>(Ditutup otomatis pukul ${endTime} WIB)</small>
                        </div>
                    `;
                    // Hanya Dosen yang bertanggung jawab yang bisa menutup manual
                    if (CURRENT_USER.role === 'Dosen' && CURRENT_USER.id === CURRENT_SESSION_STATE.dosenId) {
                        controlHTML += `
                            <div class="action-bar" style="justify-content: center; margin-top: 10px;">
                                <button class="btn-action btn-delete" onclick="window.handleManualCloseAbsen()">
                                    <i class="fas fa-times-circle"></i> Tutup Sesi Manual
                                </button>
                            </div>
                        `;
                    }
                    break;
                
                case 'before_class':
                    const startTime = new Date(CURRENT_SESSION_STATE.nextSessionTime).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    controlHTML = `
                        <div class="alert-info">
                            <i class="fas fa-clock"></i> Kelas belum dimulai.
                            <br>Sesi absensi berikutnya akan dibuka otomatis pada pukul <strong>${startTime} WIB</strong>.
                            <div id="countdown-timer">--:--:--</div>
                        </div>
                    `;
                    startCountdown(CURRENT_SESSION_STATE.nextSessionTime);
                    break;
                    
                case 'ended_for_day':
                    controlHTML = `
                        <div class="alert-warning">
                            <i class="fas fa-calendar-check"></i> <strong>Kelas hari ini telah berakhir.</strong>
                            <br>Sesi absensi akan dibuka kembali besok pagi.
                            <div id="countdown-timer">--:--:--</div>
                        </div>
                    `;
                    // Hitung mundur ke jam 9 pagi besok
                    const besok = new Date();
                    besok.setDate(besok.getDate() + 1);
                    besok.setHours(9, 0, 0, 0);
                    startCountdown(besok.getTime());
                    break;
                    
                case 'closed':
                default:
                    let message = "Sesi absensi ditutup.";
                    if (CURRENT_SESSION_STATE.nextSessionTime) {
                        const nextStartTime = new Date(CURRENT_SESSION_STATE.nextSessionTime).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                        message = `Menunggu mata kuliah berikutnya (pukul ${nextStartTime} WIB).`;
                    }
                    controlHTML = `
                        <div class="alert-info">
                            <i class="fas fa-door-closed"></i> ${message}
                            ${CURRENT_SESSION_STATE.nextSessionTime ? '<div id="countdown-timer">--:--:--</div>' : ''}
                        </div>
                    `;
                    if (CURRENT_SESSION_STATE.nextSessionTime) {
                         startCountdown(CURRENT_SESSION_STATE.nextSessionTime);
                    }
                    break;
            }

            // PERUBAHAN: Tambah TH Avatar
            const mahasiswaTableHTML = `
                <div class="table-responsive" style="margin-top: 20px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Avatar</th>
                                <th>NPM</th>
                                <th>Nama Mahasiswa</th>
                                <th>Status Akun</th>
                                <th>Absen Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody id="mahasiswa-table-body">
                            <!-- Data Mahasiswa akan diisi di sini -->
                        </tbody>
                    </table>
                    <p id="empty-mahasiswa-msg" style="text-align: center; margin-top: 20px; color: #6c757d; display: none;">
                        Tidak ada data mahasiswa yang terdaftar di database.
                    </p>
                </div>
            `;
            
            wrapper.innerHTML = controlHTML + mahasiswaTableHTML;
            window.renderMahasiswaListTable(); // Tetap isi tabel
        }
        
        // *Dipindahkan ke window scope*
        // PERUBAHAN: Tambah TD Avatar, dan event listener
        window.renderMahasiswaListTable = async function() {
            const tableBody = document.getElementById('mahasiswa-table-body');
            const emptyMsg = document.getElementById('empty-mahasiswa-msg');
            
            if (!tableBody || !emptyMsg) return; // Kontainer tidak ada, batalkan render

            tableBody.innerHTML = '';
            emptyMsg.style.display = 'none';

            // PERUBAHAN LOGIKA ABSENSI: Cek state global
            const isAbsenOpen = CURRENT_SESSION_STATE && CURRENT_SESSION_STATE.status === 'open';

            try {
                const snapshot = await get(child(ref(db), `users/`));
                
                if (snapshot.exists()) {
                    const allUsers = snapshot.val();
                    let index = 0;
                    
                    const today = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '-');
                    const absensiSnapshot = await get(child(ref(db), `absensi/${today}`));
                    const todayAbsensi = absensiSnapshot.exists() ? absensiSnapshot.val() : {};

                    Object.keys(allUsers).forEach((id) => {
                        const mhs = allUsers[id];
                        if (mhs.role === 'Mahasiswa') { 
                            index++;
                            const isAbsenDone = todayAbsensi[mhs.npm] !== undefined;
                            
                            // Logika Tombol Absen
                            let buttonHTML = '';
                            if (isAbsenOpen) {
                                if (isAbsenDone) {
                                    buttonHTML = `
                                        <button class="btn-action btn-primary" style="background-color: #6c757d;" disabled>
                                            <i class="fas fa-check-circle"></i> Absen Selesai
                                        </button>`;
                                } else {
                                    buttonHTML = `
                                        <button class="btn-action btn-primary" 
                                            data-npm="${mhs.npm}" 
                                            data-name="${mhs.name}"
                                            onclick="window.showAbsensiModal(this)">
                                            <i class="fas fa-signature"></i> Absen Kehadiran
                                        </button>`;
                                }
                            } else {
                                buttonHTML = `
                                    <button class="btn-action btn-primary" style="background-color: #6c757d;" disabled>
                                        <i class="fas fa-lock"></i> Kelas Ditutup
                                    </button>`;
                            }
                            
                            const row = document.createElement('tr');
                            // Tambahkan data-id untuk klik
                            row.setAttribute('data-id', mhs.id); 
                            row.innerHTML = `
                                <td>${index}</td>
                                <td onclick="window.showPublicProfile('${mhs.id}')">
                                    <img src="${mhs.avatar || DEFAULT_AVATAR_URL}" alt="avatar" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd;">
                                </td>
                                <td onclick="window.showPublicProfile('${mhs.id}')">${mhs.npm}</td>
                                <td onclick="window.showPublicProfile('${mhs.id}')">${mhs.name}</td>
                                <td><span style="color: green; font-weight: bold;">Aktif</span></td>
                                <td class="table-actions">
                                    ${buttonHTML}
                                </td>
                            `;
                            tableBody.appendChild(row);
                        }
                    });
                    emptyMsg.style.display = index === 0 ? 'block' : 'none';
                } else {
                    emptyMsg.style.display = 'block';
                }
            } catch (error) {
                console.error("Gagal memuat daftar mahasiswa:", error);
                window.showNotification("âŒ Gagal memuat data mahasiswa dari database.", 5000);
                emptyMsg.textContent = "Error: Gagal memuat data. Cek koneksi atau aturan database.";
                emptyMsg.style.display = 'block';
            }
        }
        
        // FUNGSI BARU: Menampilkan Public Profile Modal
        window.showPublicProfile = async function(userId) {
            const modal = document.getElementById('public-profile-modal');
            
            // 1. Ambil data pengguna
            const userRef = ref(db, `users/${userId}`);
            const userSnapshot = await get(userRef);
            if (!userSnapshot.exists()) {
                window.showNotification("âŒ Profil pengguna tidak ditemukan.", 4000);
                return;
            }
            const userData = userSnapshot.val();
            
            // 2. Hitung jumlah tugas (untuk Mahasiswa)
            let totalTasks = 0;
            if (userData.role === 'Mahasiswa') {
                const tugasRootRef = ref(db, 'tugas');
                const tugasSnapshot = await get(tugasRootRef);
                if (tugasSnapshot.exists()) {
                    const allDosenTugas = tugasSnapshot.val();
                    for (const dosenId in allDosenTugas) {
                        for (const taskId in allDosenTugas[dosenId]) {
                            const tugas = allDosenTugas[dosenId][taskId];
                            if (tugas.npm === userId) {
                                totalTasks++;
                            }
                        }
                    }
                }
            } else {
                 totalTasks = userData.attendance_count || 0; // Dosen: Kehadiran Mengajar
            }
            
            // 3. Hitung Level EXP
            const exp = userData.exp || 0;
            const { level, nextExp } = getLevelFromExp(exp);
            const expPercentage = (exp / nextExp) * 100;

            // 4. Update UI Modal
            document.getElementById('public-profile-pic-img').src = userData.avatar || DEFAULT_AVATAR_URL;
            document.getElementById('public-profile-name').textContent = userData.name;
            
            let roleText = '';
            if (userData.role === 'Mahasiswa') {
                roleText = `${userData.role} / ${userData.jurusan} (${userData.kelas})`;
                document.getElementById('public-profile-tasks').textContent = totalTasks;
                document.querySelector('#public-profile-info strong i.fa-tasks').style.display = 'inline-block';
            } else {
                roleText = `${userData.role} / ${userData.mata_kuliah}`;
                document.getElementById('public-profile-tasks').textContent = totalTasks;
                 document.querySelector('#public-profile-info strong i.fa-tasks').style.display = 'none'; // Sembunyikan untuk Dosen
            }
            
            document.getElementById('public-profile-role').textContent = roleText;
            document.getElementById('public-profile-id').textContent = userId;
            
            // Update EXP
            document.getElementById('public-profile-level').textContent = level;
            document.getElementById('public-profile-exp').textContent = exp;
            document.getElementById('public-profile-exp-bar').style.width = `${Math.min(expPercentage, 100)}%`;
            
            // 5. Tampilkan Modal
            modal.style.display = 'flex';
        }
        
        // *Dipindahkan ke window scope*
        // PERUBAHAN LOGIKA ABSENSI: Fungsi ini sekarang hanya memanggil renderDosenControlPanel atau renderMahasiswaControlPanel
        window.renderMahasiswaList = async function() {
            // Hentikan timer countdown lama jika ada
            if (countdownTimerInterval) {
                clearInterval(countdownTimerInterval);
                countdownTimerInterval = null;
            }
            
            // Mahasiswa dan Dosen melihat panel yang sama
            // Panel Dosen akan memiliki tombol ekstra jika ID-nya cocok
            renderDosenControlPanel();
        }
        

     // GANTI fungsi renderAbsenLog yang sudah ada dengan ini:
window.renderAbsenLog = async function() {
    const container = document.getElementById('absen-log-container');
    if (!container) return;
    
    container.innerHTML = `<div class="alert-info">Memuat data log absensi...</div>`;
    
    const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    let allStudentsList = [];
    let allAbsensiData = {};

    // 1. Ambil data
    try {
        // Ambil daftar mahasiswa
        const usersSnapshot = await get(child(ref(db), `users/`));
        if (usersSnapshot.exists()) {
            Object.values(usersSnapshot.val()).forEach(user => {
                if (user.role === 'Mahasiswa') {
                    allStudentsList.push(user);
                }
            });
        }
        
        if (allStudentsList.length === 0) {
            container.innerHTML = `<div class="alert-warning">Tidak ada data mahasiswa yang terdaftar di sistem.</div>`;
            return;
        }
        
        // Urutkan mahasiswa berdasarkan NPM
        allStudentsList.sort((a, b) => (a.npm || '').localeCompare(b.npm || ''));

        // Ambil semua data absensi
        const absensiSnapshot = await get(child(ref(db), `absensi/`));
        if (absensiSnapshot.exists()) {
            allAbsensiData = absensiSnapshot.val();
        } else {
            container.innerHTML = `<div class="alert-info">Belum ada riwayat absensi yang tersimpan</div>`;
            return;
        }
        
    } catch (error) {
        console.error("Gagal memuat data untuk log:", error);
        container.innerHTML = `<div class="alert-warning">Gagal memuat data dari database. Cek koneksi Anda.</div>`;
        return;
    }
    
    // 2. Render HTML
    let html = "";
    
    // Urutkan tanggal (DD-MM-YYYY)
    const sortedDates = Object.keys(allAbsensiData).sort((a, b) => {
        const [dayA, monthA, yearA] = a.split('-').map(Number);
        const [dayB, monthB, yearB] = b.split('-').map(Number);
        const dateA = new Date(yearA, monthA - 1, dayA);
        const dateB = new Date(yearB, monthB - 1, dayB);
        return dateA - dateB;
    });

    for (const dateKey of sortedDates) {
        const [day, month, year] = dateKey.split('-').map(Number);
        const dateObj = new Date(year, month - 1, day);
        const dayIndex = dateObj.getDay();
        const dayName = days[dayIndex];
        
        const dailySchedule = JADWAL_MATKUL_FINAL[dayIndex];
        const dailyAbsensi = allAbsensiData[dateKey]; // Isinya { NPM: { ...absensiData } }
        
        if (!dailySchedule || dailySchedule.length === 0) {
            continue; // Lewati hari libur
        }
        
        html += `<h4>${dateKey} (${dayName})</h4>`;
        
        for (const course of dailySchedule) {
            // Hanya proses matkul yang ada di jadwal (bukan Hima, dll)
            if (!course.jam.includes('-')) continue; 
            
            html += `
                <h5>${course.matkul} (${course.jam})</h5>
                <div class="table-responsive" style="margin-bottom: 20px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NPM</th>
                                <th>Nama Mahasiswa</th>
                                <th>Status</th>
                                <th>Keterangan</th>
                                <th>Waktu Absen</th>
                                <th>Diubah Oleh</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let no = 1;
            for (const student of allStudentsList) {
                const attendanceRecord = dailyAbsensi[student.npm];
                const isRecorded = attendanceRecord && attendanceRecord.matkul === course.matkul;
                
                let statusHtml = '';
                let keterangan = '-';
                let waktu = '-';
                let diubahOleh = '-';
                
                if (isRecorded) {
                    const status = attendanceRecord.status || 'Hadir';
                    const statusColor = getStatusColor(status);
                    statusHtml = `<span style="color: ${statusColor}; font-weight: 600; padding: 4px 8px; border-radius: 4px; background-color: ${statusColor}20;">${status}</span>`;
                    keterangan = attendanceRecord.keterangan || '-';
                    waktu = attendanceRecord.time || 'N/A';
                    diubahOleh = attendanceRecord.lastUpdatedBy || attendanceRecord.editedBy || 'Sistem';
                } else {
                    statusHtml = `<span style="color: #dc3545; font-weight: 600;">Tanpa Ket</span>`;
                }
                
                html += `
                    <tr>
                        <td>${no++}</td>
                        <td>${student.npm}</td>
                        <td>${student.name}</td>
                        <td>${statusHtml}</td>
                        <td>${keterangan}</td>
                        <td>${waktu}</td>
                        <td><small>${diubahOleh}</small></td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }
    }
    
    container.innerHTML = html;
} // ===== FUNGSI BARU: FITUR TANDA TANGAN DOSEN & PDF =====

// Variabel untuk tanda tangan dosen
let dosenCanvas, dosenCtx, isDosenDrawing = false;
let currentSignatureDate = null;
let currentSignatureMatkul = null;

// Inisialisasi Canvas Tanda Tangan Dosen
function initDosenSignatureCanvas() {
    dosenCanvas = document.getElementById('dosen-signature-canvas');
    if (!dosenCanvas) return;
    
    dosenCtx = dosenCanvas.getContext('2d');
    dosenCtx.lineWidth = 2;
    dosenCtx.lineCap = 'round';
    dosenCtx.strokeStyle = '#000000';
    
    // Bersihkan canvas
    dosenCtx.clearRect(0, 0, dosenCanvas.width, dosenCanvas.height);
    dosenCtx.fillStyle = '#ffffff';
    dosenCtx.fillRect(0, 0, dosenCanvas.width, dosenCanvas.height);
    
    // Tambahkan border
    dosenCtx.strokeStyle = '#cccccc';
    dosenCtx.strokeRect(0, 0, dosenCanvas.width, dosenCanvas.height);
    
    // Tambahkan teks petunjuk
    dosenCtx.fillStyle = '#888888';
    dosenCtx.font = '14px Arial';
    dosenCtx.textAlign = 'center';
    dosenCtx.fillText('Gambar tanda tangan Anda di area ini', dosenCanvas.width/2, dosenCanvas.height/2);
    
    // Setup event listeners
    setupDosenCanvasEvents();
}

// Setup event untuk canvas dosen
function setupDosenCanvasEvents() {
    if (!dosenCanvas) return;
    
    // Hapus event listeners lama
    dosenCanvas.onmousedown = null;
    dosenCanvas.onmousemove = null;
    dosenCanvas.onmouseup = null;
    dosenCanvas.onmouseout = null;
    
    // Mouse events
    dosenCanvas.onmousedown = (e) => { 
        isDosenDrawing = true; 
        drawDosen(e, 'mouse'); 
        // Hapus petunjuk jika mulai menggambar
        dosenCtx.clearRect(0, 0, dosenCanvas.width, dosenCanvas.height);
        dosenCtx.fillStyle = '#ffffff';
        dosenCtx.fillRect(0, 0, dosenCanvas.width, dosenCanvas.height);
    };
    dosenCanvas.onmousemove = (e) => { if (isDosenDrawing) drawDosen(e, 'mouse'); };
    dosenCanvas.onmouseup = () => { isDosenDrawing = false; dosenCtx.beginPath(); };
    dosenCanvas.onmouseout = () => { isDosenDrawing = false; dosenCtx.beginPath(); };
    
    // Touch events
    dosenCanvas.addEventListener('touchstart', (e) => { 
        e.preventDefault();
        isDosenDrawing = true; 
        drawDosen(e, 'touch'); 
        // Hapus petunjuk
        dosenCtx.clearRect(0, 0, dosenCanvas.width, dosenCanvas.height);
        dosenCtx.fillStyle = '#ffffff';
        dosenCtx.fillRect(0, 0, dosenCanvas.width, dosenCanvas.height);
    }, { passive: false });
    
    dosenCanvas.addEventListener('touchmove', (e) => { 
        e.preventDefault();
        if (isDosenDrawing) drawDosen(e, 'touch'); 
    }, { passive: false });
    
    dosenCanvas.addEventListener('touchend', () => { 
        isDosenDrawing = false; 
        dosenCtx.beginPath(); 
    });
}

// Fungsi menggambar untuk dosen
function drawDosen(e, type) {
    if (!isDosenDrawing || !dosenCanvas) return;
    
    e.preventDefault();
    
    const rect = dosenCanvas.getBoundingClientRect();
    let clientX, clientY;

    if (type === 'mouse') {
        clientX = e.clientX;
        clientY = e.clientY;
    } else if (type === 'touch' && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
    } else {
        return;
    }
    
    // Skala koordinat
    const scaleX = dosenCanvas.width / rect.width;
    const scaleY = dosenCanvas.height / rect.height;
    const x = (clientX - rect.left) * scaleX;
    const y = (clientY - rect.top) * scaleY;
    
    dosenCtx.strokeStyle = '#000000';
    dosenCtx.lineTo(x, y);
    dosenCtx.stroke();
    dosenCtx.beginPath();
    dosenCtx.moveTo(x, y);
}

// Fungsi untuk memuat mata kuliah berdasarkan tanggal
async function loadMatkulForDate(selectedDate) {
    const selectMatkul = document.getElementById('pdf-select-matkul');
    if (!selectMatkul) return;
    
    selectMatkul.innerHTML = '<option value="">Mengambil data mata kuliah...</option>';
    
    try {
        // Parse tanggal untuk mendapatkan hari
        const dateObj = new Date(selectedDate);
        const dayIndex = dateObj.getDay(); // 0=Minggu, 1=Senin, dll
        
        // Dapatkan jadwal untuk hari tersebut
        const scheduleForDay = JADWAL_MATKUL_FINAL[dayIndex] || [];
        
        // Filter hanya mata kuliah dengan jam yang valid
        const validMatkul = scheduleForDay.filter(course => course.jam.includes('-'));
        
        if (validMatkul.length === 0) {
            selectMatkul.innerHTML = '<option value="">Tidak ada jadwal kuliah di tanggal ini</option>';
            return;
        }
        
        // Isi dropdown
        selectMatkul.innerHTML = '<option value="">Pilih Mata Kuliah</option>';
        validMatkul.forEach(course => {
            const option = document.createElement('option');
            option.value = course.matkul;
            option.textContent = `${course.matkul} (${course.jam}) - ${course.dosenName}`;
            option.dataset.dosenId = course.dosenId;
            option.dataset.dosenName = course.dosenName;
            selectMatkul.appendChild(option);
        });
        
    } catch (error) {
        console.error("Error loading matkul:", error);
        selectMatkul.innerHTML = '<option value="">Error memuat data</option>';
    }
}

// Fungsi untuk memuat data absensi
async function loadAbsensiData() {
    const selectedDate = document.getElementById('pdf-select-date').value;
    const selectedMatkul = document.getElementById('pdf-select-matkul').value;
    
    if (!selectedDate || !selectedMatkul) {
        window.showNotification("â— Harap pilih tanggal dan mata kuliah terlebih dahulu", 3000);
        return;
    }
    
    // Format tanggal ke DD-MM-YYYY
    const dateObj = new Date(selectedDate);
    const formattedDate = `${String(dateObj.getDate()).padStart(2, '0')}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${dateObj.getFullYear()}`;
    
    // Simpan untuk tanda tangan
    currentSignatureDate = formattedDate;
    currentSignatureMatkul = selectedMatkul;
    
    // Tampilkan loading
    document.getElementById('pdf-loading-state').style.display = 'block';
    document.getElementById('pdf-empty-state').style.display = 'none';
    document.getElementById('pdf-preview-absensi').style.display = 'none';
    
    try {
        // 1. Ambil semua mahasiswa
        const usersSnapshot = await get(child(ref(db), 'users/'));
        const allStudents = [];
        
        if (usersSnapshot.exists()) {
            Object.values(usersSnapshot.val()).forEach(user => {
                if (user.role === 'Mahasiswa') {
                    allStudents.push({
                        npm: user.npm || user.id,
                        name: user.name
                    });
                }
            });
        }
        
        // Urutkan berdasarkan NPM
        allStudents.sort((a, b) => (a.npm || '').localeCompare(b.npm || ''));
        
        // 2. Ambil data absensi untuk tanggal tersebut
        const absensiRef = ref(db, `absensi/${formattedDate}`);
        const absensiSnapshot = await get(absensiRef);
        const absensiData = absensiSnapshot.exists() ? absensiSnapshot.val() : {};
        
        // 3. Filter hanya untuk mata kuliah yang dipilih
        const filteredAbsensi = {};
        for (const npm in absensiData) {
            if (absensiData[npm].matkul === selectedMatkul) {
                filteredAbsensi[npm] = absensiData[npm];
            }
        }
        
// 4. Render tabel preview
const tableBody = document.getElementById('pdf-preview-table-body');
tableBody.innerHTML = '';

let totalHadir = 0;
let totalAlpha = 0;
let totalIzin = 0;
let totalSakit = 0;
let totalTidakHadir = 0;

allStudents.forEach((student, index) => {
    const absensiRecord = filteredAbsensi[student.npm];
    const status = absensiRecord ? (absensiRecord.status || 'Hadir') : 'Tanpa Ket';
    const keterangan = absensiRecord ? (absensiRecord.keterangan || '-') : '-';
    
    let statusColor = '#dc3545'; // Default merah untuk tidak hadir
    if (status === 'Hadir') statusColor = '#28a745';
    else if (status === 'Alpha') statusColor = '#dc3545';
    else if (status === 'Izin') statusColor = '#ffc107';
    else if (status === 'Sakit') statusColor = '#17a2b8';
    
    // Update counter
    if (status === 'Hadir') totalHadir++;
    else if (status === 'Alpha') totalAlpha++;
    else if (status === 'Izin') totalIzin++;
    else if (status === 'Sakit') totalSakit++;
    else totalTidakHadir++;

    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${index + 1}</td>
        <td>${student.npm}</td>
        <td>${student.name}</td>
        <td>
            <span style="color: ${statusColor}; font-weight: bold; padding: 4px 8px; border-radius: 4px; background-color: ${statusColor}20;">
                ${status}
            </span>
        </td>
        <td>${keterangan}</td>
        <td>${absensiRecord ? (absensiRecord.time || 'N/A') : '-'}</td>
    `;
    tableBody.appendChild(row);
});

// Update summary dengan detail per status
document.getElementById('total-mahasiswa').textContent = allStudents.length;
document.getElementById('total-hadir').innerHTML = `<span style="color: #28a745;">H: ${totalHadir}</span>`;
document.getElementById('total-tidak-hadir').innerHTML = `
    <span style="color: #dc3545;">A: ${totalAlpha}</span> | 
    <span style="color: #ffc107;">I: ${totalIzin}</span> | 
    <span style="color: #17a2b8;">S: ${totalSakit}</span>
`;
        // Update summary
        document.getElementById('total-mahasiswa').textContent = allStudents.length;
        document.getElementById('total-hadir').textContent = totalHadir;
        document.getElementById('total-tidak-hadir').textContent = totalTidakHadir;
        
        // Tampilkan tabel
        document.getElementById('pdf-preview-table').style.display = 'table';
        
        // 5. Cek apakah sudah ada tanda tangan dosen
        await checkExistingDosenSignature(formattedDate, selectedMatkul);
        
        // Sembunyikan loading, tampilkan data
        document.getElementById('pdf-loading-state').style.display = 'none';
        document.getElementById('pdf-preview-absensi').style.display = 'block';
        
        // Tampilkan/ sembunyikan section tanda tangan berdasarkan role
        const isDosen = CURRENT_USER.role === 'Dosen';
        document.getElementById('dosen-signature-section').style.display = isDosen ? 'block' : 'none';
        
        window.showNotification(`âœ… Data absensi berhasil dimuat: ${totalHadir} hadir dari ${allStudents.length} mahasiswa`, 3000);
        
    } catch (error) {
        console.error("Error loading absensi data:", error);
        document.getElementById('pdf-loading-state').style.display = 'none';
        document.getElementById('pdf-empty-state').style.display = 'block';
        window.showNotification("âŒ Gagal memuat data absensi", 3000);
    }
}

// Cek apakah sudah ada tanda tangan dosen
async function checkExistingDosenSignature(date, matkul) {
    if (CURRENT_USER.role !== 'Dosen') return;
    
    try {
        const signatureRef = ref(db, `dosen_signatures/${date}/${matkul}`);
        const snapshot = await get(signatureRef);
        
        if (snapshot.exists()) {
            const signatureData = snapshot.val();
            // Tampilkan preview tanda tangan
            document.getElementById('dosen-signature-image').src = signatureData.signature;
            document.getElementById('dosen-signature-preview').style.display = 'block';
            
            // Update status
            showPdfStatus('Tanda tangan dosen sudah tersimpan untuk laporan ini', 'success');
        } else {
            document.getElementById('dosen-signature-preview').style.display = 'none';
            // Reset canvas
            if (dosenCanvas) {
                initDosenSignatureCanvas();
            }
        }
    } catch (error) {
        console.error("Error checking dosen signature:", error);
    }
}

// Simpan tanda tangan dosen
async function saveDosenSignature() {
    if (!dosenCanvas || !currentSignatureDate || !currentSignatureMatkul) {
        window.showNotification("â— Harap muat data absensi terlebih dahulu", 3000);
        return;
    }
    
    if (CURRENT_USER.role !== 'Dosen') {
        window.showNotification("âŒ Hanya dosen yang dapat menandatangani laporan", 3000);
        return;
    }
    
    // Periksa apakah canvas kosong
    const blankCanvas = document.createElement('canvas');
    blankCanvas.width = dosenCanvas.width;
    blankCanvas.height = dosenCanvas.height;
    const blankCtx = blankCanvas.getContext('2d');
    blankCtx.fillStyle = '#ffffff';
    blankCtx.fillRect(0, 0, blankCanvas.width, blankCanvas.height);
    
    if (dosenCanvas.toDataURL() === blankCanvas.toDataURL()) {
        window.showNotification("â— Tanda tangan tidak boleh kosong", 3000);
        return;
    }
    
    const signatureData = dosenCanvas.toDataURL('image/png');
    
    try {
        const signatureRef = ref(db, `dosen_signatures/${currentSignatureDate}/${currentSignatureMatkul}`);
        
        const signatureInfo = {
            signature: signatureData,
            dosenId: CURRENT_USER.id,
            dosenName: CURRENT_USER.name,
            timestamp: new Date().toISOString(),
            date: currentSignatureDate,
            matkul: currentSignatureMatkul
        };
        
        await set(signatureRef, signatureInfo);
        
        // Tampilkan preview
        document.getElementById('dosen-signature-image').src = signatureData;
        document.getElementById('dosen-signature-preview').style.display = 'block';
        
        window.showNotification("âœ… Tanda tangan dosen berhasil disimpan", 3000);
        showPdfStatus('Tanda tangan berhasil disimpan dan siap untuk PDF', 'success');
        
    } catch (error) {
        console.error("Error saving dosen signature:", error);
        window.showNotification("âŒ Gagal menyimpan tanda tangan", 3000);
        showPdfStatus('Gagal menyimpan tanda tangan', 'error');
    }
}

// GANTI fungsi generateAbsensiPDF yang sudah ada dengan ini:
async function generateAbsensiPDF() {
    if (!currentSignatureDate || !currentSignatureMatkul) {
        window.showNotification("â— Harap muat data absensi terlebih dahulu", 3000);
        return;
    }
    
    const selectedDate = currentSignatureDate;
    const selectedMatkul = currentSignatureMatkul;
    
    // Dapatkan info dosen dari dropdown
    const selectMatkul = document.getElementById('pdf-select-matkul');
    const selectedOption = selectMatkul.options[selectMatkul.selectedIndex];
    const dosenName = selectedOption.dataset.dosenName || 'Dosen Pengampu';
    
    // Tampilkan loading
    showPdfStatus('Membuat PDF...', 'info');
    
    try {
        // 1. Ambil data mahasiswa
        const usersSnapshot = await get(child(ref(db), 'users/'));
        const allStudents = [];
        
        if (usersSnapshot.exists()) {
            Object.values(usersSnapshot.val()).forEach(user => {
                if (user.role === 'Mahasiswa') {
                    allStudents.push({
                        npm: user.npm || user.id,
                        name: user.name
                    });
                }
            });
        }
        
        // 2. Ambil data absensi
        const absensiRef = ref(db, `absensi/${selectedDate}`);
        const absensiSnapshot = await get(absensiRef);
        const absensiData = absensiSnapshot.exists() ? absensiSnapshot.val() : {};
        
        // Filter untuk mata kuliah yang dipilih
        const filteredAbsensi = {};
        let totalHadir = 0, totalAlpha = 0, totalIzin = 0, totalSakit = 0;
        
        for (const npm in absensiData) {
            if (absensiData[npm].matkul === selectedMatkul) {
                filteredAbsensi[npm] = absensiData[npm];
                const status = absensiData[npm].status || 'Hadir';
                if (status === 'Hadir') totalHadir++;
                else if (status === 'Alpha') totalAlpha++;
                else if (status === 'Izin') totalIzin++;
                else if (status === 'Sakit') totalSakit++;
            }
        }
        
        // 3. Ambil tanda tangan dosen
        let dosenSignature = null;
        try {
            const signatureRef = ref(db, `dosen_signatures/${selectedDate}/${selectedMatkul}`);
            const signatureSnapshot = await get(signatureRef);
            if (signatureSnapshot.exists()) {
                dosenSignature = signatureSnapshot.val().signature;
            }
        } catch (sigError) {
            console.log("Tanda tangan dosen tidak ditemukan");
        }
        
        // 4. Buat PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Judul
        doc.setFontSize(18);
        doc.setTextColor(40, 40, 40);
        doc.text('LAPORAN ABSENSI SISTEM INFORMASI', 105, 20, { align: 'center' });
        
        // Informasi
        doc.setFontSize(11);
        doc.setTextColor(80, 80, 80);
        doc.text(`Mata Kuliah: ${selectedMatkul}`, 20, 35);
        doc.text(`Tanggal: ${selectedDate}`, 20, 42);
        doc.text(`Dosen: ${dosenName}`, 20, 49);
        
        // Ringkasan Status dengan warna
        doc.setFontSize(10);
        doc.setTextColor(40, 40, 40);
        doc.text(`Ringkasan Kehadiran:`, 20, 58);
        
        // Box ringkasan
        doc.setFillColor(40, 167, 69); // Hijau untuk Hadir
        doc.rect(20, 62, 5, 5, 'F');
        doc.setTextColor(40, 167, 69);
        doc.text(`Hadir: ${totalHadir}`, 27, 66);
        
        doc.setFillColor(220, 53, 69); // Merah untuk Alpha
        doc.rect(60, 62, 5, 5, 'F');
        doc.setTextColor(220, 53, 69);
        doc.text(`Alpha: ${totalAlpha}`, 67, 66);
        
        doc.setFillColor(255, 193, 7); // Kuning untuk Izin
        doc.rect(100, 62, 5, 5, 'F');
        doc.setTextColor(255, 193, 7);
        doc.text(`Izin: ${totalIzin}`, 107, 66);
        
        doc.setFillColor(23, 162, 184); // Biru untuk Sakit
        doc.rect(140, 62, 5, 5, 'F');
        doc.setTextColor(23, 162, 184);
        doc.text(`Sakit: ${totalSakit}`, 147, 66);
        
        // Total
        doc.setTextColor(80, 80, 80);
        doc.text(`Total: ${allStudents.length} mahasiswa`, 20, 74);
        
        // Tabel Absensi dengan kolom Status dan Keterangan
        const tableData = [];
        
        // Header tabel
        tableData.push(['No', 'NPM', 'Nama Mahasiswa', 'Status', 'Keterangan', 'Waktu']);
        
        // Data mahasiswa
        allStudents.forEach((student, index) => {
            const absensiRecord = filteredAbsensi[student.npm];
            const status = absensiRecord ? (absensiRecord.status || 'Hadir') : 'Tanpa Ket';
            const keterangan = absensiRecord ? (absensiRecord.keterangan || '-') : '-';
            const waktu = absensiRecord ? (absensiRecord.time || 'N/A') : '-';
            
            tableData.push([
                (index + 1).toString(),
                student.npm,
                student.name,
                status,
                keterangan,
                waktu
            ]);
        });
        
        // Buat tabel dengan styling
        doc.autoTable({
            head: [tableData[0]],
            body: tableData.slice(1),
            startY: 80,
            headStyles: {
                fillColor: [95, 75, 139], // Warna sidebar (ungu)
                textColor: 255,
                fontStyle: 'bold',
                fontSize: 10
            },
            bodyStyles: {
                fontSize: 9,
                cellPadding: 2
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240]
            },
            columnStyles: {
                0: { cellWidth: 10, halign: 'center' }, // No
                1: { cellWidth: 25 }, // NPM
                2: { cellWidth: 50 }, // Nama
                3: { cellWidth: 20, halign: 'center', fontStyle: 'bold' }, // Status
                4: { cellWidth: 45 }, // Keterangan
                5: { cellWidth: 25, halign: 'center' } // Waktu
            },
            // Styling khusus untuk kolom status
            didParseCell: function(data) {
                if (data.column.index === 3 && data.section === 'body') {
                    const status = data.cell.raw;
                    if (status === 'Hadir') {
                        data.cell.styles.textColor = [40, 167, 69]; // Hijau
                    } else if (status === 'Alpha') {
                        data.cell.styles.textColor = [220, 53, 69]; // Merah
                    } else if (status === 'Izin') {
                        data.cell.styles.textColor = [255, 193, 7]; // Kuning/orange
                    } else if (status === 'Sakit') {
                        data.cell.styles.textColor = [23, 162, 184]; // Biru
                    }
                }
            },
            margin: { top: 80 }
        });
        
        // Tanda tangan dosen
        const finalY = doc.lastAutoTable.finalY + 15;
        
        // Garis pemisah
        doc.setDrawColor(200, 200, 200);
        doc.line(20, finalY - 5, 190, finalY - 5);
        
        doc.setFontSize(11);
        doc.setTextColor(40, 40, 40);
        doc.text('Tanda Tangan Dosen Pengampu:', 20, finalY + 5);
        
        if (dosenSignature) {
            try {
                // Tambahkan tanda tangan
                doc.addImage(dosenSignature, 'PNG', 20, finalY + 10, 50, 25);
                
                // Garis untuk tanda tangan
                doc.setDrawColor(0, 0, 0);
                doc.line(20, finalY + 38, 70, finalY + 38);
                
                // Nama dosen di bawah tanda tangan
                doc.setFontSize(10);
                doc.text(`(${dosenName})`, 45, finalY + 43, { align: 'center' });
            } catch (imgError) {
                console.log("Gagal menambahkan gambar tanda tangan ke PDF");
                doc.text('Tanda tangan tidak tersedia', 20, finalY + 20);
            }
        } else {
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text('*Tanda tangan dosen belum tersedia*', 20, finalY + 20);
            
            // Garis kosong untuk tanda tangan manual
            doc.setDrawColor(0, 0, 0);
            doc.line(20, finalY + 38, 70, finalY + 38);
            doc.text('(_______________________)', 45, finalY + 43, { align: 'center' });
        }
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Dibuat pada: ${new Date().toLocaleString('id-ID')}`, 105, 280, { align: 'center' });
        doc.text('Sistem Informasi Universitas Batam - Kelas Pagi', 105, 285, { align: 'center' });
        doc.text('Sistem Absensi Digital - SIPEN', 105, 290, { align: 'center' });
        
        // 5. Download PDF
        const fileName = `Absensi_${selectedMatkul.replace(/\s+/g, '_')}_${selectedDate}.pdf`;
        doc.save(fileName);
        
        showPdfStatus('PDF berhasil diunduh!', 'success');
        window.showNotification(`âœ… PDF berhasil diunduh: ${fileName}`, 4000);
        
    } catch (error) {
        console.error("Error generating PDF:", error);
        showPdfStatus('Gagal membuat PDF', 'error');
        window.showNotification("âŒ Gagal membuat PDF", 3000);
    }
}

// Fungsi untuk menampilkan status
function showPdfStatus(message, type = 'info') {
    const statusElement = document.getElementById('pdf-status-message');
    if (!statusElement) return;
    
    statusElement.textContent = message;
    statusElement.className = 'pdf-status ' + type;
    statusElement.style.display = 'block';
    
    // Auto hide setelah 5 detik
    setTimeout(() => {
        statusElement.style.display = 'none';
    }, 5000);
}

// Render halaman PDF
window.renderPdfAbsensiPage = function() {
    // Inisialisasi canvas
    initDosenSignatureCanvas();
    
    // Set tanggal default ke hari ini
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('pdf-select-date').value = today;
    
    // Load matkul untuk hari ini
    loadMatkulForDate(today);
    
    // Reset state
    currentSignatureDate = null;
    currentSignatureMatkul = null;
    document.getElementById('pdf-preview-absensi').style.display = 'none';
    document.getElementById('pdf-empty-state').style.display = 'block';
    document.getElementById('pdf-loading-state').style.display = 'none';
};

// ===== AKHIR FUNGSI FITUR PDF =====

        async function handleTugasSubmission(e) {
            e.preventDefault();
            
            const selectDosen = document.getElementById('pilih-dosen');
            const fileInput = document.getElementById('file-tugas');
            
            const selectedDosen = selectDosen ? selectDosen.value : null;
            const dosenOption = selectDosen.options[selectDosen.selectedIndex];
            const dosenName = dosenOption.textContent;
            const dosenMatkul = dosenOption.getAttribute('data-matkul');
            const file = fileInput.files[0];
            const fileName = file ? file.name : null;

            if (!selectedDosen) {
                window.showNotification("â— Harap pilih Dosen Pengampu terlebih dahulu.", 4000);
                return;
            }
            
            if (!fileName) {
                window.showNotification("â— Harap pilih file untuk diunggah.", 4000);
                return;
            }
            
            // --- Konversi File ke Base64 (Untuk Penyimpanan RTDB) ---
            
            const reader = new FileReader();
            reader.onload = async function (e) {
                const fileBase64 = e.target.result; // Data Base64
                const fileExtension = fileName.split('.').pop().toLowerCase();
                const fileType = file.type || `application/${fileExtension}`;

                const newTugasData = {
                    npm: CURRENT_USER.id,
                    studentName: CURRENT_USER.name,
                    fileName: fileName,
                    fileBase64: fileBase64, // Menyimpan data file mentah (Base64)
                    fileType: fileType,
                    dosenId: selectedDosen,
                    mata_kuliah: dosenMatkul,
                    dateSubmitted: new Date().toLocaleDateString('id-ID'),
                    status: 'Baru'
                };

                const success = await saveTugasToDB(selectedDosen, newTugasData);
                
                // Beri EXP 5 saat berhasil upload (Mahasiswa)
                if (success && CURRENT_USER.role === 'Mahasiswa') {
                    await updateUserExp(CURRENT_USER.id, 5);
                }
                
                if (success) {
                     window.showNotification(`âœ… File ${fileName} berhasil diunggah untuk ${dosenName.split('(')[0].trim()}.`, 5000);
                    
                    // Muat ulang konten tugas untuk refresh tabel nilai
                    await window.renderMahasiswaTugas();
                }
            };
            reader.onerror = (error) => {
                 window.showNotification("âŒ Error membaca file.", 5000);
                 console.error("Error reading file:", error);
            };
            
            // Mulai membaca file sebagai Base64
            reader.readAsDataURL(file);
        }
        
        // --- LOGIKA CHAT REALTIME (MODIFIKASI) ---
        
        // NEW: Fungsi untuk mengatur state replyingTo dan UI preview
        function setReplyingTo(messageId, senderName, text) {
            replyingTo = {
                messageId: messageId,
                senderName: senderName,
                text: text
            };
            
            document.getElementById('reply-sender-name').textContent = senderName;
            document.getElementById('reply-quoted-text').textContent = text;
            document.getElementById('reply-preview').classList.add('active');
            document.getElementById('chat-input').focus();
        }

        // NEW: Fungsi untuk membatalkan reply
        function cancelReply() {
            replyingTo = null;
            document.getElementById('reply-preview').classList.remove('active');
        }

        // NEW: Fungsi untuk menangani klik/swipe pada bubble
        window.handleReplyClick = function(messageId, senderName, text) {
            setReplyingTo(messageId, senderName, text);
        }

       function setupChat() {
    const typingIndicator = document.getElementById('typing-indicator');
    const typingRef = ref(db, 'typing/global');
    const myTypingRef = ref(db, `typing/global/${CURRENT_USER.id}`);
    let stopTypingTimer = null;
    
    const stopTyping = () => {
        if (stopTypingTimer) {
            clearTimeout(stopTypingTimer);
            stopTypingTimer = null;
        }
        remove(myTypingRef);
    };
    
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    
    const chatRef = ref(db, 'chat/global');
    
    // Listener untuk tombol cancel reply
    if (cancelReplyBtn) {
        cancelReplyBtn.onclick = cancelReply;
    }

    // Listener untuk pesan baru
    onValue(chatRef, (snapshot) => {
        if (!chatMessages) return;
        
        chatMessages.innerHTML = '';
        if (snapshot.exists()) {
            const messages = snapshot.val();
            const messagesArray = Object.keys(messages).map(key => ({
                ...messages[key],
                messageId: key
            }));
            
            messagesArray.forEach(msg => {
                if (!msg || !msg.senderId) return;
                
                const messageElement = document.createElement('div');
                const isSelf = msg.senderId === CURRENT_USER.id;
                
                messageElement.className = `chat-message ${isSelf ? 'self' : 'other'}`;
                
                const senderName = isSelf ? 'Anda' : (msg.senderName || 'Anonim');
                const senderClass = isSelf ? 'font-weight: 700;' : `color: #5f4b8b; font-weight: 600;`;
                
                let quotedReplyHTML = '';
                if (msg.replyData) {
                    const quotedSender = msg.replyData.senderName || 'Anonim';
                    const quotedText = msg.replyData.text || 'Pesan terhapus/kosong';
                    quotedReplyHTML = `
                        <div class="chat-quoted-reply">
                            <div class="quoted-sender">${quotedSender}</div>
                            <div class="quoted-text">${quotedText}</div>
                        </div>
                    `;
                }
                
                messageElement.setAttribute('data-message-id', msg.messageId);
                messageElement.setAttribute('data-sender-name', msg.senderName || 'Anonim');
                messageElement.setAttribute('data-text', msg.text || '');
                
                // Event listener untuk klik pesan (untuk context menu)
                messageElement.addEventListener('click', function(e) {
                    e.stopPropagation();
                    window.showChatContextMenu(
                        e, 
                        msg.messageId, 
                        msg.senderId, 
                        msg.senderName || 'Anonim', 
                        (msg.text || '').replace(/'/g, "\\'")
                    );
                });
                
                messageElement.innerHTML = `
                    <div class="chat-bubble-content">
                        <div class="chat-sender" style="${senderClass}">${senderName}</div>
                        <div class="chat-bubble">
                            ${quotedReplyHTML}
                            ${msg.text || ''}
                        </div>
                        <div class="chat-timestamp">${msg.timestamp || '00:00'}</div>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
            });

            // Scroll ke bawah
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });

    // Handler untuk mengirim pesan
    if (sendChatBtn) {
        sendChatBtn.onclick = async function() {
            const text = chatInput.value.trim();
            if (text === "") return;
            
            stopTyping();

            const newMessage = {
                senderId: CURRENT_USER.id,
                senderName: CURRENT_USER.name,
                text: text,
                timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
            };
            
            if (replyingTo) {
                newMessage.replyData = {
                    messageId: replyingTo.messageId,
                    senderName: replyingTo.senderName,
                    text: replyingTo.text
                };
                cancelReply();
            }

            try {
                await push(chatRef, newMessage);
                chatInput.value = '';
                await updateUserExp(CURRENT_USER.id, 1);
            } catch (error) {
                console.error("Gagal mengirim pesan:", error);
                window.showNotification("âŒ Gagal mengirim pesan. Koneksi chat error.", 3000);
            }
        };
    }
    
    // Mengirim pesan dengan tombol Enter
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (sendChatBtn) sendChatBtn.click();
            }
        });
        
        // Typing indicator
        chatInput.addEventListener('input', () => {
            if (stopTypingTimer) {
                clearTimeout(stopTypingTimer);
            }
            
            // Set status typing
            set(myTypingRef, {
                name: CURRENT_USER.name,
                timestamp: Date.now()
            });

            stopTypingTimer = setTimeout(stopTyping, 2000);
        });
    }
    
    // Listener untuk melihat siapa yang sedang mengetik
    onValue(typingRef, (snapshot) => {
        if (!typingIndicator) return;
        
        const typingData = snapshot.val();
        const now = Date.now();
        const typingUsers = [];

        if (typingData) {
            for (const userId in typingData) {
                const user = typingData[userId];
                if (userId !== CURRENT_USER.id && (now - user.timestamp) < 3000) {
                    typingUsers.push(user.name);
                }
            }
        }

        // Update UI Indikator
        if (typingUsers.length === 0) {
            typingIndicator.textContent = '';
            typingIndicator.classList.remove('active');
        } else if (typingUsers.length === 1) {
            typingIndicator.textContent = `${typingUsers[0]} sedang mengetik...`;
            typingIndicator.classList.add('active');
        } else {
            typingIndicator.textContent = 'Beberapa orang sedang mengetik...';
            typingIndicator.classList.add('active');
        }
    });
} // <- Tutup fungsi setupChat dengan benar
// Fungsi untuk memastikan chat bekerja
function initChatSystem() {
    try {
        setupChat();
        console.log("âœ… Sistem chat berhasil diinisialisasi");
    } catch (error) {
        console.error("âŒ Error inisialisasi chat:", error);
        window.showNotification("âš ï¸ Chat sementara tidak tersedia, coba refresh halaman", 5000);
    }
}

// Panggil initChatSystem setelah login berhasil
// ... di dalam fungsi handleSuccessfulLogin:
// initChatSystem();

        // --- FUNGSI BARU: LOGIKA MENU KONTEKS CHAT ---
            
// Variabel global untuk menu
const chatContextMenu = document.getElementById('chat-context-menu');

/**
 * Menampilkan menu konteks saat chat di-klik
 */
window.showChatContextMenu = function(event, messageId, senderId, senderName, text) {
    // 1. Simpan data ke menu untuk diakses nanti
    chatContextMenu.dataset.messageId = messageId;
    chatContextMenu.dataset.senderId = senderId;
    chatContextMenu.dataset.senderName = senderName;
    chatContextMenu.dataset.text = text;

    // 2. Tampilkan/Sembunyikan "Hapus untuk semua"
    const deleteEveryoneOption = document.getElementById('ctx-delete-all');
    if (senderId === CURRENT_USER.id) {
        deleteEveryoneOption.style.display = 'flex';
    } else {
        deleteEveryoneOption.style.display = 'none';
    }

    // 3. Atur Posisi Menu
    // Dapatkan dimensi viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    // Dapatkan ukuran menu
    const menuWidth = chatContextMenu.offsetWidth;
    const menuHeight = chatContextMenu.offsetHeight;
    
    let top = event.clientY;
    let left = event.clientX;

    // Cek agar tidak keluar viewport (kanan)
    if ((left + menuWidth) > viewportWidth) {
        left = viewportWidth - menuWidth - 10; // 10px padding
    }
    
    // Cek agar tidak keluar viewport (bawah)
    if ((top + menuHeight) > viewportHeight) {
        top = viewportHeight - menuHeight - 10; // 10px padding
    }

    chatContextMenu.style.top = `${top}px`;
    chatContextMenu.style.left = `${left}px`;
    chatContextMenu.style.display = 'block';

    // 4. Tambahkan listener untuk menutup menu
    // Gunakan timeout 0 agar listener ini tidak langsung ter-trigger oleh klik yang sama
    setTimeout(() => {
        document.addEventListener('click', window.hideChatContextMenu, { once: true });
    }, 0);
}

/**
 * Menyembunyikan menu konteks
 */
window.hideChatContextMenu = function() {
    if (chatContextMenu) {
        chatContextMenu.style.display = 'none';
        // Hapus data
        delete chatContextMenu.dataset.messageId;
        delete chatContextMenu.dataset.senderId;
        delete chatContextMenu.dataset.senderName;
        delete chatContextMenu.dataset.text;
    }
    // Hapus listener (meskipun {once: true} sudah ada, ini untuk keamanan)
    document.removeEventListener('click', window.hideChatContextMenu);
}

/**
 * Menangani aksi dari menu konteks
 */
async function handleChatMenuAction(action) {
    const { messageId, senderId, senderName, text } = chatContextMenu.dataset;

    if (!messageId) return; // Tidak ada data

    switch (action) {
        case 'reply':
            // Panggil fungsi reply yang sudah ada
            window.handleReplyClick(messageId, senderName, text);
            break;
        
        case 'delete_self':
            // Hapus hanya di sisi klien
            const messageElement = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.style.display = 'none';
            }
            window.showNotification("Pesan dihapus untuk Anda.", 2000);
            break;
        
        case 'delete_all':
            // Hanya bisa jika sender adalah user saat ini
            if (senderId === CURRENT_USER.id) {
                if (confirm("Apakah Anda yakin ingin menghapus pesan ini untuk semua orang?")) {
                    try {
                        const msgRef = ref(db, `chat/global/${messageId}`);
                        await remove(msgRef);
                        window.showNotification("Pesan dihapus untuk semua orang.", 3000);
                        // onValue akan otomatis mengurus UI update
                    } catch (error) {
                        console.error("Gagal menghapus pesan:", error);
                        window.showNotification("âŒ Gagal menghapus pesan. Cek koneksi.", 4000);
                    }
                }
            }
            break;
    }
    
    // Sembunyikan menu setelah aksi
    window.hideChatContextMenu();
}

// --- AKHIR FUNGSI BARU ---


        // --- LOGIKA TANDA TANGAN (SIGNATURE) ---
        
        // Global Canvas Context
        let canvas, ctx, isDrawing = false;
        
        function setupSignatureCanvas() {
            canvas = document.getElementById('signature-canvas');
            ctx = canvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';
            
            function resizeCanvas() {
                const container = canvas.closest('.modal-content');
                // Beri padding 50px (25 kiri, 25 kanan)
                const newWidth = container.clientWidth - 50;
                // Pastikan lebar canvas tidak nol atau negatif
                const canvasWidth = Math.max(newWidth > 350 ? 350 : newWidth, 150); // Min width 150
                canvas.width = canvasWidth; 
                canvas.height = 150;
                
                // Set style width untuk tampilan responsif
                canvas.style.width = `100%`; // Gunakan 100% dari parent
                canvas.style.maxWidth = `350px`; // Batasi max width
            }


            resizeCanvas();

            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        window.showAbsensiModal = function(button) {
            // PERUBAHAN LOGIKA ABSENSI: Cek state global
            const isAbsenOpen = CURRENT_SESSION_STATE && CURRENT_SESSION_STATE.status === 'open';

            if (!isAbsenOpen) {
                 window.showNotification("âŒ Absensi DITUTUP.", 4000);
                 return;
            }
            
            // Verifikasi bahwa Mahasiswa yang login adalah Mahasiswa yang bersangkutan
            const npmTarget = button.getAttribute('data-npm');
            if (CURRENT_USER.role === 'Mahasiswa' && CURRENT_USER.id !== npmTarget) {
                 window.showNotification("âŒ Anda hanya dapat mengisi absen untuk diri sendiri.", 4000);
                 return;
            }
            
            // Verifikasi bahwa tombol ini dinonaktifkan (Absen Selesai)
            if (button.disabled) {
                window.showNotification("âœ… Absensi untuk hari ini sudah Anda isi.", 4000);
                return;
            }

            currentAbsensiTarget = {
                npm: npmTarget,
                name: button.getAttribute('data-name')
            };
            
            document.getElementById('absensi-target-name').textContent = `Mahasiswa: ${currentAbsensiTarget.name} (${currentAbsensiTarget.npm})`;
            document.getElementById('signature-modal').style.display = 'flex';
            setupSignatureCanvas(); 
            addSignatureListeners();
        }
        
        function addSignatureListeners() {
            const canvas = document.getElementById('signature-canvas');
            // Hapus listener lama jika ada (untuk mencegah duplikasi)
            canvas.removeEventListener('touchstart', handleTouchStart);
            canvas.removeEventListener('touchmove', handleTouchMove);
            canvas.removeEventListener('touchend', handleTouchEnd);
            canvas.onmousedown = null;
            canvas.onmousemove = null;
            canvas.onmouseup = null;
            canvas.onmouseout = null;

            // Tambahkan listener baru
            canvas.onmousedown = (e) => { isDrawing = true; draw(e, 'mouse'); };
            canvas.onmousemove = (e) => { if (isDrawing) draw(e, 'mouse'); };
            canvas.onmouseup = () => { isDrawing = false; ctx.beginPath(); };
            canvas.onmouseout = () => { isDrawing = false; ctx.beginPath(); };

            // Touch events (for mobile)
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
        }
        
        // Touch Handlers terpisah
        function handleTouchStart(e) { isDrawing = true; draw(e, 'touch'); }
        function handleTouchMove(e) { if (isDrawing) draw(e, 'touch'); }
        function handleTouchEnd() { isDrawing = false; ctx.beginPath(); }


        function draw(e, type) {
            if (!isDrawing) return;
            
            e.preventDefault();
            
            const canvas = document.getElementById('signature-canvas');
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;

            if (type === 'mouse') {
                clientX = e.clientX;
                clientY = e.clientY;
            } else if (type === 'touch' && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                return;
            }
            
            // Skala koordinat mouse/touch ke koordinat canvas
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        
        document.getElementById('clear-signature-btn').addEventListener('click', () => {
            const canvas = document.getElementById('signature-canvas');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
        });

        document.getElementById('save-signature-btn').addEventListener('click', async () => {
            const canvas = document.getElementById('signature-canvas');
            const signatureData = canvas.toDataURL('image/png');
            
            const blankCanvas = document.createElement('canvas');
            blankCanvas.width = canvas.width;
            blankCanvas.height = canvas.height;
            
            if (signatureData === blankCanvas.toDataURL('image/png')) {
                window.showNotification("â— Tanda tangan tidak boleh kosong.", 3000);
                return;
            }

            const success = await saveAbsensiToDB(currentAbsensiTarget.npm, currentAbsensiTarget.name, signatureData);
            
            if (success) {
                document.getElementById('signature-modal').style.display = 'none';
                window.showNotification(`âœ… Kehadiran ${currentAbsensiTarget.name} berhasil direkam!`, 4000);
                
                // PERUBAHAN LOGIKA ABSENSI: UI akan di-refresh oleh listener onValue
                // Kita tidak perlu memanggil renderMahasiswaList() secara manual
                // Cukup data absensi yang baru disimpan akan membuat tabel
                // me-render ulang status tombol pada refresh berikutnya.
                // Untuk instant update, kita panggil manual:
                window.renderMahasiswaList();
            }
        });
        
        // --- LOGIKA ANTI-RELOG (State Persistence) ---

        function saveUserState(user) {
            // PENAMBAHAN BARU: Pastikan token sesi tersimpan
            CURRENT_USER.activeSessionToken = user.activeSessionToken;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
        }

        function clearUserState() {
            localStorage.removeItem(STORAGE_KEY);
        }

        function loadUserState() {
            const savedUser = localStorage.getItem(STORAGE_KEY);
            if (savedUser) {
                const user = JSON.parse(savedUser);
                // PERUBAHAN: Gunakan avatar tersimpan atau default
                user.avatar = user.avatar || DEFAULT_AVATAR_URL;
                user.loggedIn = true;
                // PENAMBAHAN BARU: Muat token sesi
                user.activeSessionToken = user.activeSessionToken || null;
                return user;
            }
            return null;
        }

        // --- Logout Handler ---
        function handleLogout() {
            // PENAMBAHAN BARU: Set loggedIn = false SEBELUM membersihkan state
            // Ini penting agar listener sesi tidak ter-trigger
            CURRENT_USER.loggedIn = false; 
            
            clearUserState();
            // PERUBAHAN: Hapus halaman terakhir yang disimpan
            localStorage.removeItem(LAST_PAGE_KEY);
            // JANGAN hapus 'rememberMe' saat logout
            
            // PERUBAHAN LOGIKA ABSENSI: Hentikan semua timer
            if (countdownTimerInterval) {
                clearInterval(countdownTimerInterval);
            }
            // (Listener onValue dan interval checkSession akan berhenti saat reload)
            
            location.reload(); 
        }

        // --- FUNGSI BARU UNTUK UPDATE FOTO MENGGUNAKAN URL ---
        async function handleProfilePictureUrlUpdate(url) {
            if (!CURRENT_USER.id) {
                window.showNotification("âŒ Anda harus login untuk mengubah foto profil.", 4000);
                return false;
            }
            if (!url || url.trim() === "") {
                window.showNotification("â— URL gambar tidak boleh kosong.", 4000);
                return false;
            }

            // Validasi URL sederhana (harus HTTP/HTTPS)
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                 window.showNotification("âŒ URL tidak valid. Harus dimulai dengan http:// atau https://", 5000);
                 return false;
            }

            try {
                // Simpan URL baru ke Realtime Database
                const userRef = ref(db, `users/${CURRENT_USER.id}`);
                await update(userRef, { avatar: url });
                
                // Perbarui state lokal dan UI
                CURRENT_USER.avatar = url;
                saveUserState(CURRENT_USER);
                
                // Update UI di halaman profil dan navbar
                document.getElementById('profile-pic-img').src = url;
                document.querySelector('.navbar-right .user-info img').src = url;

                window.showNotification("âœ… Foto profil berhasil diperbarui!", 3000);
                return true;

            } catch (error) {
                console.error("Gagal update URL foto profil:", error);
                window.showNotification("âŒ Gagal menyimpan URL foto ke database.", 5000);
                return false;
            }
        }
        
        // --- PENAMBAHAN BARU: FUNGSI LISTENER UNTUK SINGLE DEVICE ---
        function listenForSessionChanges(userId) {
            // Ambil token dari state global yang sudah di-load
            const localToken = CURRENT_USER.activeSessionToken;
            
            if (!localToken) {
                console.warn("Tidak ada token sesi lokal, listener tidak dapat dimulai.");
                return; 
            }
            
            const sessionRef = ref(db, `users/${userId}/activeSessionToken`);
            
            onValue(sessionRef, (snapshot) => {
                const dbToken = snapshot.val();
                
                // Cek jika dbToken ada dan tidak sama dengan token lokal
                // Kita juga cek CURRENT_USER.loggedIn untuk menghindari trigger saat logout manual
                if (CURRENT_USER.loggedIn && dbToken && dbToken !== localToken) {
                    console.log("Sesi baru terdeteksi di perangkat lain. Memulai logout...");
                    
                    // Notifikasi bahwa sesi telah diambil alih
                    window.showNotification("âš ï¸ Sesi Anda telah berakhir. Akun ini telah login di perangkat lain.", 5000);
                    
                    // Tambahkan sedikit delay agar notifikasi terlihat sebelum reload
                    setTimeout(() => {
                        handleLogout(); // Panggil fungsi logout yang sudah ada
                    }, 3000);
                }
            });
        }


        // --- FUNGSI UTAMA APP LOGIC ---

        document.addEventListener('DOMContentLoaded', async function() {
            // ===== EVENT LISTENERS UNTUK FITUR PDF =====

// Event listener untuk perubahan tanggal
document.getElementById('pdf-select-date').addEventListener('change', function() {
    loadMatkulForDate(this.value);
});

// Event listener untuk tombol muat data
document.getElementById('btn-load-absensi-data').addEventListener('click', loadAbsensiData);

// Event listener untuk tombol hapus tanda tangan
document.getElementById('btn-clear-dosen-signature').addEventListener('click', function() {
    if (dosenCanvas) {
        initDosenSignatureCanvas();
    }
});

// Event listener untuk tombol simpan tanda tangan
document.getElementById('btn-save-dosen-signature').addEventListener('click', saveDosenSignature);

// Event listener untuk tombol generate PDF
document.getElementById('btn-generate-pdf').addEventListener('click', generateAbsensiPDF);

// Event listener untuk menu PDF
const pdfMenuLink = document.querySelector('[data-content-id="pdf-absensi-content"]');
if (pdfMenuLink) {
    pdfMenuLink.addEventListener('click', function(e) {
        e.preventDefault();
        const contentId = this.getAttribute('data-content-id');
        loadContent(contentId, this);
        window.renderPdfAbsensiPage();
    });
}   
            const loginForm = document.getElementById('form-login');
            const registerForm = document.getElementById('form-register');
            const switchLink = document.getElementById('switch-link');
            const hamburgerMenuWrapper = document.getElementById('hamburger-menu');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            // PENAMBAHAN BARU: Ambil elemen link foto profil navbar
            const navbarUserInfoLink = document.getElementById('navbar-user-info-link');
            
            // PERUBAHAN LOGIKA ABSENSI: Parse jadwal hari ini saat DOM dimuat
            parseFullSchedule();
            
            
            // --- LOGIKA HAMBURGER MENU (MOBILE) ---
            if (hamburgerMenuWrapper) {
                hamburgerMenuWrapper.addEventListener('click', function() {
                    sidebar.classList.toggle('open');
                    overlay.classList.toggle('active');
                });
            }
            if (overlay) {
                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('active');
                });
            }
            
            // --- PENAMBAHAN BARU: CLICK FOTO PROFIL NAVIGASI KE USER PROFILE ---
            if (navbarUserInfoLink) {
                navbarUserInfoLink.addEventListener('click', function(e) {
                     e.preventDefault();
                     // Cari link di sidebar yang menunjuk ke User Profile (user-content)
                     const userProfileLink = document.querySelector(`.menu-link[data-content-id="user-content"]`);
                     if (userProfileLink) {
                         loadContent('user-content', userProfileLink);
                     }
                });
            }


            // --- FUNGSI NAVIGASI GLOBAL (Diperlukan oleh Antirelog) ---
           async function switchToDashboard(userData) {
    console.log("=== SWITCH TO DASHBOARD ===");
    console.log("User data diterima:", userData);
    
    try {
        // Inisialisasi akun Dosen (hanya Fendi) jika belum ada
        await initializeDosenAccounts();
        
        // VALIDASI: Pastikan userData valid
        if (!userData || !userData.id) {
            console.error("Data user tidak valid:", userData);
            window.showNotification("âŒ Data pengguna tidak valid", 4000);
            return;
        }
        
        // SET CURRENT_USER dengan SEMUA properti yang diperlukan
        CURRENT_USER = {
            id: userData.id || userData.npm || userData.userId,
            name: userData.name || 'Pengguna',
            role: userData.role || 'Mahasiswa',
            email: userData.email || `${(userData.id || userData.npm).toLowerCase()}@${userData.role ? userData.role.toLowerCase() : 'mahasiswa'}.ac.id`,
            jurusan: userData.jurusan || (userData.role === 'Dosen' ? 'Sistem Informasi' : 'Sistem Informasi'),
            kelas: userData.kelas || 'Pagi',
            mata_kuliah: userData.mata_kuliah || (userData.role === 'Dosen' ? 'Konsep Basis Data' : 'Umum'),
            exp: userData.exp || 0,
            avatar: userData.avatar || DEFAULT_AVATAR_URL,
            loggedIn: true,
            activeSessionToken: userData.activeSessionToken || null,
            npm: userData.npm || userData.id  // Untuk kompatibilitas
        };
        
        console.log("CURRENT_USER setelah di-set:", CURRENT_USER);
        
        // UPDATE UI PROFILE
        const profileName = document.getElementById('profile-name');
        const profileRole = document.getElementById('profile-role');
        const profileId = document.getElementById('profile-id');
        const profileEmail = document.getElementById('profile-email');
        const idLabel = document.getElementById('id-label');
        
        if (profileName) profileName.textContent = CURRENT_USER.name;
        
        if (CURRENT_USER.role === 'Mahasiswa') {
            if (profileRole) profileRole.textContent = `${CURRENT_USER.jurusan} / Kelas ${CURRENT_USER.kelas}`;
        } else {
            if (profileRole) profileRole.textContent = `${CURRENT_USER.role} / ${CURRENT_USER.mata_kuliah}`;
        }
        
        if (profileId) profileId.textContent = CURRENT_USER.id;
        if (profileEmail) profileEmail.textContent = CURRENT_USER.email;
        
        if (idLabel) {
            idLabel.innerHTML = CURRENT_USER.role === 'Mahasiswa' 
                ? '<i class="fas fa-id-card"></i> Nomor NPM' 
                : '<i class="fas fa-id-badge"></i> Nomor NIDN';
        }
        
        // UPDATE AVATAR
        const profilePicImg = document.getElementById('profile-pic-img');
        const navbarAvatar = document.querySelector('.navbar-right .user-info img');
        
        if (profilePicImg) {
            profilePicImg.src = CURRENT_USER.avatar;
            profilePicImg.onerror = function() {
                this.src = DEFAULT_AVATAR_URL;
            };
        }
        
        if (navbarAvatar) {
            navbarAvatar.src = CURRENT_USER.avatar;
            navbarAvatar.onerror = function() {
                this.src = DEFAULT_AVATAR_URL;
            };
        }
        
        // SWITCH MODE
        document.body.classList.remove('login-mode');
        document.body.classList.add('dashboard-mode');
        
        const dashboardWrapper = document.getElementById('dashboard-wrapper');
        if (dashboardWrapper) {
            dashboardWrapper.style.display = 'flex';
            console.log("Dashboard wrapper ditampilkan");
        }
        
        // SIMPAN STATE KE LOCALSTORAGE
        saveUserState(CURRENT_USER);
        
        // LOAD CONTENT PERTAMA
        const defaultLink = document.querySelector('[data-content-id="mahasiswa-list-content"]');
        const lastPageId = localStorage.getItem(LAST_PAGE_KEY) || 'mahasiswa-list-content';
        const link = document.querySelector(`.menu-link[data-content-id="${lastPageId}"]`);
        
        console.log(`Memuat halaman: ${lastPageId}`);
        await loadContent(lastPageId, link || defaultLink);
        
        // SETUP LISTENER SESI (Single Device)
        listenForSessionChanges(CURRENT_USER.id);
        
        // SETUP CHAT
        setupChat();
        
        // SETUP ABSENSI OTOMATIS
        const sessionRef = ref(db, GLOBAL_SESSION_STATE_KEY);
        onValue(sessionRef, (snapshot) => {
            CURRENT_SESSION_STATE = snapshot.exists() ? snapshot.val() : { status: 'closed' };
            console.log("State Absensi Firebase berubah:", CURRENT_SESSION_STATE);
            
            const activeLink = document.querySelector('.sidebar-menu .menu-link.active');
            if (activeLink && activeLink.getAttribute('data-content-id') === 'mahasiswa-list-content') {
                window.renderMahasiswaList();
            }
        });

        console.log("=== SWITCH TO DASHBOARD SELESAI ===");
        
    } catch (error) {
        console.error("ERROR di switchToDashboard:", error);
        window.showNotification("âŒ Error masuk ke dashboard: " + error.message, 5000);
        
        // Fallback: Tampilkan dashboard mode meski ada error
        document.body.classList.remove('login-mode');
        document.body.classList.add('dashboard-mode');
        document.getElementById('dashboard-wrapper').style.display = 'flex';
    }
}

async function loadContent(contentId, linkElement) {
    console.log(`=== LOAD CONTENT: ${contentId} ===`);
    console.log(`Role pengguna: ${CURRENT_USER.role}`);
    
    try {
        // HIDE ALL SECTIONS
        const contentSections = document.querySelectorAll('.content-section');
        contentSections.forEach(section => { 
            section.classList.remove('active'); 
        });
        
        // SHOW TARGET SECTION
        const targetContent = document.getElementById(contentId);
        if (targetContent) { 
            targetContent.classList.add('active'); 
            console.log(`Section ${contentId} diaktifkan`);
        } else {
            console.error(`Section dengan ID ${contentId} tidak ditemukan!`);
        }
        
        // UPDATE SIDEBAR ACTIVE LINK
        const sidebarLinks = document.querySelectorAll('.sidebar-menu .menu-link');
        sidebarLinks.forEach(link => { 
            link.classList.remove('active'); 
        });
        
        if (linkElement) {
            linkElement.classList.add('active');
            console.log(`Menu ${linkElement.textContent.trim()} diaktifkan`);
        }
        
        // UPDATE BREADCRUMB
        const breadcrumb = document.getElementById('breadcrumb');
        let breadcrumbText = linkElement ? linkElement.textContent.trim() : 'Home';
        
        // HANDLE CONTENT BERDASARKAN ID
        switch(contentId) {
            case 'mahasiswa-list-content':
                breadcrumbText = 'Absen Mahasiswa';
                await window.renderMahasiswaList();
                break;
                
            case 'module-content':
                if (CURRENT_USER.role === 'Mahasiswa') {
                    breadcrumbText = 'Upload Tugas';
                    await window.renderMahasiswaTugas();
                } else if (CURRENT_USER.role === 'Dosen') {
                    breadcrumbText = 'Daftar Tugas Masuk';
                    await window.renderDosenTugas();
                }
                break;
                
            case 'chat-content':
                breadcrumbText = 'Chat Kelas';
                // Chat sudah di-setup di switchToDashboard
                break;
                
            case 'panduan-content':
                breadcrumbText = 'Panduan Website';
                break;
                
            case 'jadwal-content':
                breadcrumbText = 'Jadwal Mata Kuliah';
                if (typeof renderJadwalMatkul === 'function') {
                    renderJadwalMatkul();
                }
                break;
                
            case 'absen-log-content':
                breadcrumbText = 'Riwayat Absensi';
                if (typeof window.renderAbsenLog === 'function') {
                    await window.renderAbsenLog();
                }
                break;
                
            case 'pdf-absensi-content':
                breadcrumbText = 'TTD & Laporan PDF';
                if (typeof window.renderPdfAbsensiPage === 'function') {
                    window.renderPdfAbsensiPage();
                }
                break;
                
            case 'info-update-website':
                breadcrumbText = 'Berita Kelas';
                break;
                
            case 'user-content':
                breadcrumbText = 'User Profile';
                await loadUserProfileData();
                break;
                
            default:
                console.log(`Content ${contentId} tidak memiliki handler khusus`);
        }
        
        // UPDATE BREADCRUMB
        if (breadcrumb) {
            breadcrumb.innerHTML = `<a href="#">Home</a> <span>/</span> ${breadcrumbText}`;
        }
        
        // SAVE LAST PAGE
        localStorage.setItem(LAST_PAGE_KEY, contentId);
        
        // CLOSE SIDEBAR ON MOBILE
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            if (sidebar) sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('active');
        }
        
        console.log(`=== LOAD CONTENT ${contentId} SELESAI ===`);
        
    } catch (error) {
        console.error(`ERROR di loadContent untuk ${contentId}:`, error);
        window.showNotification(`âŒ Gagal memuat halaman ${contentId}`, 3000);
    }
}

// FUNGSI BARU: Load data profile user
async function loadUserProfileData() {
    console.log("Loading user profile data...");
    
    try {
        const userRef = ref(db, `users/${CURRENT_USER.id}`);
        const userSnapshot = await get(userRef);
        
        if (!userSnapshot.exists()) {
            console.error("User data tidak ditemukan di Firebase");
            window.showNotification("âŒ Data profil tidak ditemukan", 3000);
            return;
        }
        
        const userData = userSnapshot.val();
        console.log("User data dari Firebase:", userData);
        
        // UPDATE CURRENT_USER dengan data terbaru dari Firebase
        if (userData.avatar && userData.avatar !== CURRENT_USER.avatar) {
            CURRENT_USER.avatar = userData.avatar;
            const profilePicImg = document.getElementById('profile-pic-img');
            const navbarAvatar = document.querySelector('.navbar-right .user-info img');
            
            if (profilePicImg) profilePicImg.src = CURRENT_USER.avatar;
            if (navbarAvatar) navbarAvatar.src = CURRENT_USER.avatar;
        }
        
        if (userData.email && userData.email !== CURRENT_USER.email) {
            CURRENT_USER.email = userData.email;
            const profileEmail = document.getElementById('profile-email');
            if (profileEmail) profileEmail.textContent = CURRENT_USER.email;
        }
        
        if (userData.exp !== undefined) {
            CURRENT_USER.exp = userData.exp;
        }
        
        if (userData.activeSessionToken) {
            CURRENT_USER.activeSessionToken = userData.activeSessionToken;
        }
        
        // UPDATE STATISTIK
        const statElement = document.querySelector('#role-dependent-stat');
        const tasksElement = document.getElementById('profile-tasks');
        
        if (CURRENT_USER.role === 'Dosen') {
            if (tasksElement) tasksElement.textContent = userData.attendance_count || 0;
            if (statElement) statElement.innerHTML = '<i class="fas fa-chalkboard-teacher"></i> Jumlah Kehadiran Mengajar';
        } else {
            // Untuk Mahasiswa, hitung jumlah tugas
            let totalTugas = 0;
            const tugasRootRef = ref(db, 'tugas');
            const tugasSnapshot = await get(tugasRootRef);
            if (tugasSnapshot.exists()) {
                const allDosenTugas = tugasSnapshot.val();
                for (const dosenId in allDosenTugas) {
                    for (const taskId in allDosenTugas[dosenId]) {
                        const tugas = allDosenTugas[dosenId][taskId];
                        if (tugas.npm === CURRENT_USER.id) {
                            totalTugas++;
                        }
                    }
                }
            }
            if (tasksElement) tasksElement.textContent = totalTugas;
            if (statElement) statElement.innerHTML = '<i class="fas fa-clipboard-list"></i> Jumlah Tugas Di-upload';
        }
        
        // UPDATE EXP BAR
        const { level, nextExp } = getLevelFromExp(CURRENT_USER.exp);
        const expPercentage = (CURRENT_USER.exp / nextExp) * 100;
        
        const profileLevel = document.getElementById('profile-level');
        const profileExp = document.getElementById('profile-exp');
        const profileExpBar = document.getElementById('profile-exp-bar');
        
        if (profileLevel) profileLevel.textContent = level;
        if (profileExp) profileExp.textContent = CURRENT_USER.exp;
        if (profileExpBar) profileExpBar.style.width = `${Math.min(expPercentage, 100)}%`;
        
        console.log("User profile data loaded successfully");
        
    } catch (error) {
        console.error("Error loading user profile:", error);
        window.showNotification("âŒ Gagal memuat data profil", 3000);
    }
}
            // --- END FUNGSI NAVIGASI GLOBAL ---


            // --- Cek Sesi Login yang Tersimpan (Anti-Relog) ---
            const loggedInUser = loadUserState();
            if (loggedInUser && loggedInUser.loggedIn) {
                // PENAMBAHAN BARU: Validasi token sesi saat auto-login
                try {
                    const sessionRef = ref(db, `users/${loggedInUser.id}/activeSessionToken`);
                    const snapshot = await get(sessionRef);
                    const dbToken = snapshot.val();
                    
                    // Jika token di DB tidak sama dengan token di localStorage, jangan auto-login
                    if (dbToken !== loggedInUser.activeSessionToken) {
                        console.log("Token lokal tidak valid. Memaksa login ulang.");
                        clearUserState(); // Hapus state yang tidak valid
                        window.showNotification("âš ï¸ Sesi Anda telah berakhir. Akun ini telah login di perangkat lain.", 4000);
                        // Biarkan halaman tetap di mode login
                        await initializeDosenAccounts();
                    } else {
                        // Token valid, lanjutkan auto-login
                        console.log("Token lokal valid. Melanjutkan sesi...");
                        await switchToDashboard(loggedInUser);
                    }
                } catch (error) {
                    console.error("Gagal validasi token sesi:", error);
                    // Gagal terhubung, jangan auto-login
                    clearUserState();
                    await initializeDosenAccounts();
                }
            } else {
                 // --- Inisialisasi Firebase Dosen jika tidak ada auto-login ---
                await initializeDosenAccounts();
            }
            

            document.getElementById('logout-button-desktop').addEventListener('click', handleLogout);
            document.getElementById('logout-sidebar-button').addEventListener('click', handleLogout);

            const sidebarLinks = document.querySelectorAll('.sidebar-menu .menu-link');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const contentId = this.getAttribute('data-content-id');
                    loadContent(contentId, this);
                });
            });

            // --- LOGIKA ACCORDION (BARU) ---
            const pageContent = document.querySelector('.page-content');
            pageContent.addEventListener('click', function(e) {
                const header = e.target.closest('.accordion-header');
                
                if (header) {
                    const content = header.nextElementSibling;
                    
                    header.classList.toggle('active');
                    
                    if (content.classList.contains('open')) {
                        content.classList.remove('open');
                        content.style.maxHeight = null;
                        content.style.paddingTop = '0';
                        content.style.paddingBottom = '0';
                    } else {
                        content.classList.add('open');
                        content.style.paddingTop = '15px';
                        content.style.paddingBottom = '15px';
                        content.style.maxHeight = content.scrollHeight + 30 + 'px'; 
                    }
                }
            });
            
            // --- LOGIKA BARU: KLIK GAMBAR MINTA URL (Profile Sendiri) ---
             document.getElementById('profile-pic-img').addEventListener('click', async () => {
                // Hanya izinkan klik jika di mode dashboard
                if (document.body.classList.contains('dashboard-mode')) {
                     const currentUrl = CURRENT_USER.avatar !== DEFAULT_AVATAR_URL ? CURRENT_USER.avatar : '';
                     const newUrl = prompt(`Masukkan URL Gambar Baru:`, currentUrl);
                    
                     if (newUrl) {
                         await handleProfilePictureUrlUpdate(newUrl);
                     }
                }
            });


            // --- (TIDAK BERUBAH) Listener untuk edit email ---
            const btnEditEmail = document.getElementById('btn-edit-email'); // Ganti id
            if(btnEditEmail) {
                 btnEditEmail.addEventListener('click', async function() {
                    const newEmail = prompt(`Masukkan Email Baru untuk ${CURRENT_USER.name}:`, CURRENT_USER.email);
                    
                    if (newEmail && newEmail.trim() !== "" && newEmail.includes('@')) {
                        CURRENT_USER.email = newEmail.trim();
                        document.getElementById('profile-email').textContent = CURRENT_USER.email;
                        
                        try {
                            await update(ref(db, `users/${CURRENT_USER.id}`), { email: CURRENT_USER.email });
                            saveUserState(CURRENT_USER); 
                            window.showNotification("âœ… Email berhasil diperbarui!", 3000);
                        } catch (error) {
                             console.error("Gagal update email:", error);
                             window.showNotification("âŒ Gagal memperbarui email di database.", 5000);
                        }
                    } else if (newEmail !== null && newEmail.trim() !== "") {
                        window.showNotification("âŒ Format email tidak valid.", 4000);
                    }
                });
            }
            

            // PERUBAHAN: Set default ke mode Login
            let isLoginMode = true; 
                
            function toggleFormMode() {
                isLoginMode = !isLoginMode;

                const loginWrapper = document.getElementById('login-form-wrapper');
                const registerWrapper = document.getElementById('register-form-wrapper');
                const loginForm = document.getElementById('form-login');
                const registerForm = document.getElementById('form-register');
                // --- KODE BARU UNTUK SOUND EFFECT LOGIN ---

            // 1. Ambil elemen audio yang sudah kamu buat di HTML
            const clickSound = document.getElementById('click-sound-effect');
            
            // 2. Buat fungsi untuk memainkan suara (dengan rewind)
            function playClickSound() {
                // Cek apakah kita di mode login DAN file audionya ada
                if (document.body.classList.contains('login-mode') && clickSound) {
                    clickSound.currentTime = 0; // Ulangi dari awal jika diklik cepat
                    clickSound.play().catch(error => {
                        // Ini normal jika user belum berinteraksi (kebijakan browser)
                        console.log("Menunggu interaksi user untuk memutar suara.");
                    });
                }
            }

            // 3. Ambil container login utama
            const loginContainer = document.getElementById('auth-container');
            
            if (loginContainer) {
                // 4. Pasang listener untuk SEMUA klik di dalam area login
                loginContainer.addEventListener('click', function(event) {
                    // Mainkan suara jika yang diklik adalah tombol, link, atau label
                    if (event.target.closest('button, a, label, .role-toggle-button')) {
                        playClickSound();
                    }
                });

                // 5. Pasang listener untuk 'focus' (saat user klik atau TAB ke kolom)
                // Kita gunakan 'focusin' karena event 'focus' tidak 'bubble'
                loginContainer.addEventListener('focusin', function(event) {
                    // Mainkan suara jika fokus masuk ke <input>
                    if (event.target.tagName === 'INPUT') {
                        playClickSound();
                    }
                });
            }
            
            // --- AKHIR KODE BARU ---
                loginForm.reset();
                registerForm.reset();

                if (isLoginMode) {
                    registerWrapper.classList.add('hidden');
                    loginWrapper.classList.remove('hidden');
                    document.getElementById('form-title').textContent = 'Sign In';
                    document.getElementById('form-subtitle').textContent = 'Masuk sebagai Mahasiswa atau Dosen';
                    switchLink.textContent = 'Daftar Sekarang';
                    switchLink.previousSibling.textContent = 'Belum punya akun? ';
                    toggleRole(CURRENT_USER.role, true); 
                } else {
                    loginWrapper.classList.add('hidden');
                    registerWrapper.classList.remove('hidden');
                    document.getElementById('form-title').textContent = 'Daftar Akun Mahasiswa';
                    document.getElementById('form-subtitle').textContent = 'Buat akun dengan NPM yang sudah terdaftar di kelas';
                    switchLink.textContent = 'Masuk Sekarang';
                    switchLink.previousSibling.textContent = 'Sudah punya akun? ';
                    toggleRole('Mahasiswa', false);
                }
                document.querySelectorAll('.input-group input').forEach(input => {
                    input.closest('.input-group').classList.remove('focus');
                });
            }
            // DEBUG: Cek apakah data dosen ada di Firebase
async function debugLoginDosen() {
    console.log("=== DEBUG LOGIN DOSEN ===");
    
    // Cek data dosen di Firebase
    const dosenRef = ref(db, 'users/D001');
    try {
        const snapshot = await get(dosenRef);
        
        if (snapshot.exists()) {
            const dosenData = snapshot.val();
            console.log("âœ… Data Dosen D001:", dosenData);
            
            // Cek apakah password ada
            console.log("Password tersedia:", dosenData.password ? "YA" : "TIDAK");
            console.log("Password value:", dosenData.password);
            
            // Coba login manual
            console.log("Mencoba login dengan password 'dosen123'...");
            console.log("Password match?", dosenData.password === 'dosen123');
            
        } else {
            console.log("âŒ Data Dosen D001 TIDAK DITEMUKAN");
        }
    } catch (error) {
        console.error("Error:", error);
    }
}

// Jalankan debug
debugLoginDosen();
            function toggleRole(role, enableToggle = true) {
                CURRENT_USER.role = role;
                const loginIdInput = document.getElementById('login-id-input');
                const btnMahasiswa = document.getElementById('btn-mahasiswa');
                const btnDosen = document.getElementById('btn-dosen');
                const roleToggleContainer = document.getElementById('role-toggle');

                if (btnMahasiswa) btnMahasiswa.classList.remove('active');
                if (btnDosen) btnDosen.classList.remove('active');

                if (role === 'Mahasiswa') {
                    if (btnMahasiswa) btnMahasiswa.classList.add('active');
                    if (loginIdInput) loginIdInput.placeholder = "NPM (Nomor Pokok Mhs)";
                } else {
                    if (btnDosen) btnDosen.classList.add('active');
                    if (loginIdInput) loginIdInput.placeholder = "NIDN / ID Dosen";
                }
                
                if (roleToggleContainer) {
                    roleToggleContainer.style.display = enableToggle ? 'flex' : 'none';
                }
            }
            
            document.getElementById('form-register').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('register-name-input').value.trim();
                const npm = document.getElementById('register-id-input').value.trim();
                const password = document.getElementById('register-password-input').value;
                
                if (npm.length < 5 || password.length < 6) {
                    window.showNotification("â— NPM harus valid dan Password minimal 6 karakter.", 4000);
                    return;
                }
                
                const success = await registerMahasiswa(npm, name, password);
                if (success) {
                    toggleFormMode(); 
                }
            });


try {

    const clickSoundUrl = "https://actions.google.com/sounds/v1/ui/button_press.ogg";
    const clickSound = new Audio(clickSoundUrl);
    clickSound.preload = "auto";
    clickSound.volume = 0.5; // Volume 50%
    document.body.appendChild(clickSound);

    // 2. Fungsi untuk mainkan suara klik
    function playClickSound() {
        if (document.body.classList.contains('login-mode') && clickSound) {
            clickSound.currentTime = 0;
            clickSound.play().catch(error => {
                console.log("Suara klik akan diputar setelah interaksi pertama.");
            });
        }
    }

    // 3. Ambil container login dan pasang listener
    const loginContainer = document.getElementById('auth-container');
    if (loginContainer) {
        loginContainer.addEventListener('click', function(event) {
            if (event.target.closest('button, a, label, .role-toggle-button')) {
                playClickSound();
            }
        });
        loginContainer.addEventListener('focusin', function(event) {
            if (event.target.tagName === 'INPUT') {
                playClickSound();
            }
        });
    }

    // --- BAGIAN 2: SUARA NOTIFIKASI (3 TIPE) ---
    
    // 1. Definisikan 3 TIPE SUARA NOTIFIKASI
    
    // Suara SUKSES (âœ…)
    const successSoundUrl = "https://files.catbox.moe/ryfrwh.mp3";
    const successSound = new Audio(successSoundUrl);
    successSound.preload = "auto";
    successSound.volume = 0.7;
    document.body.appendChild(successSound);

    // Suara GAGAL/ERROR (âŒ, âš ï¸, â—)
    const failureSoundUrl = "https://files.catbox.moe/z14kg4.mp3";
    const failureSound = new Audio(failureSoundUrl);
    failureSound.preload = "auto";
    failureSound.volume = 0.7;
    document.body.appendChild(failureSound);
    
    // Suara NETRAL (Untuk notif lain tanpa emoji)
    const neutralSoundUrl = "";
    const neutralSound = new Audio(neutralSoundUrl);
    neutralSound.preload = "auto";
    neutralSound.volume = 0.6; // Sedikit lebih pelan
    document.body.appendChild(neutralSound);

    
    // 2. Fungsi terpusat untuk mainkan suara notif
    function playNotificationSound(type) {
        
        // Hentikan suara klik (prioritas)
        if (clickSound) {
            clickSound.pause();
            clickSound.currentTime = 0;
        }

        // Hentikan suara notif lain (jaga-jaga agar tidak tumpuk)
        successSound.pause();
        failureSound.pause();
        neutralSound.pause();

        if (type === 'success' && successSound) {
            successSound.currentTime = 0;
            successSound.play().catch(e => console.log("Suara sukses menunggu interaksi."));
        } else if (type === 'failure' && failureSound) {
            failureSound.currentTime = 0;
            failureSound.play().catch(e => console.log("Suara gagal menunggu interaksi."));
        } else if (type === 'neutral' && neutralSound) {
            neutralSound.currentTime = 0;
            neutralSound.play().catch(e => console.log("Suara netral menunggu interaksi."));
        }
    }

    // 3. "Wrapper" untuk fungsi showNotification yang sudah ada
    // Cek jika fungsi aslinya (dibuat di baris 1205) ada
    if (typeof window.showNotification === 'function') {
        // Simpan referensi ke fungsi aslinya
        const originalShowNotification = window.showNotification;
        
        // Timpa (overwrite) fungsi aslinya dengan fungsi baru kita
        window.showNotification = function(message, duration = 3000) {
            
            // --> INI LOGIKA BARUNYA (Mendeteksi emoji)6
            if (message.startsWith('âœ…')) {
                playNotificationSound('success');
            } else if (message.startsWith('âŒ') || message.startsWith('âš ï¸') || message.startsWith('â—')) {
                playNotificationSound('failure');
            } else {
                // Mainkan suara netral jika tidak ada emoji khusus
                playNotificationSound('neutral');
            }
            
            // Panggil fungsi aslinya (agar notif tetap muncul)
            originalShowNotification.apply(window, [message, duration]);
        }
    }

} catch (error) {
    console.error("Gagal memuat script sound effect:", error);
}
// === AKHIR SCRIPT 3+1 SUARA EFEK ===
            
            document.getElementById('form-login').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = document.getElementById('login-id-input').value.trim();
                const password = document.getElementById('login-password-input').value;
                const rememberMe = document.getElementById('remember-me-checkbox').checked;
                let user;

                if (CURRENT_USER.role === 'Mahasiswa') {
                    user = await loginMahasiswa(id, password);
                } else { 
                    user = await loginDosen(id, password);
                }

                if (user) {
                    // --- PENAMBAHAN BARU: LOGIKA SINGLE SESSION ---
                    // 1. Buat token sesi unik
                    const newSessionToken = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2);
                    // 2. Tambahkan token ke objek user sebelum disimpan
                    user.activeSessionToken = newSessionToken; 

                    // 3. Update token di Firebase (ini akan me-logout perangkat lain)
                    try {
                        await update(ref(db, `users/${user.id}`), { activeSessionToken: newSessionToken });
                    } catch (tokenError) {
                        console.warn("Gagal memperbarui session token:", tokenError);
                        // Lanjutkan login, tapi mungkin ada masalah sinkronisasi
                    }
                    // --- AKHIR LOGIKA SINGLE SESSION ---


                    // --- LOGIKA REMEMBER ME (SAVING) ---
                    if (rememberMe) {
                        const rememberedUser = { id: id, password: password, role: CURRENT_USER.role };
                        localStorage.setItem(REMEMBER_ME_KEY, JSON.stringify(rememberedUser));
                    } else {
                        localStorage.removeItem(REMEMBER_ME_KEY);
                    }
                    // --- AKHIR LOGIKA REMEMBER ME ---

                    window.showNotification(`âœ… Masuk sebagai ${CURRENT_USER.role} berhasil!`, 3000);
                    saveUserState(user); // Simpan user (termasuk token baru) ke localStorage
                    setTimeout(() => switchToDashboard(user), 500); 
                }
            });

            document.getElementById('btn-mahasiswa').addEventListener('click', () => { toggleRole('Mahasiswa', true); });
            document.getElementById('btn-dosen').addEventListener('click', () => { toggleRole('Dosen', true); });
            document.getElementById('switch-link').addEventListener('click', function(e) {
                e.preventDefault();
                toggleFormMode();
            });
            
            // Atur input focus/blur styling
            document.querySelectorAll('.input-group input').forEach(input => {
                input.addEventListener('focus', function() {
                    this.closest('.input-group').classList.add('focus');
                });
                input.addEventListener('blur', function() {
                    this.closest('.input-group').classList.remove('focus');
                });
            });

            
            // --- (TIDAK BERUBAH) LOGIKA BARU: REMEMBER ME & FORGOT PASSWORD ---

            // 1. Logika "Remember Me" (LOADING)
            function loadRememberedUser() {
                const savedUser = localStorage.getItem(REMEMBER_ME_KEY);
                if (savedUser) {
                    const rememberedUser = JSON.parse(savedUser);
                    document.getElementById('login-id-input').value = rememberedUser.id;
                    document.getElementById('login-password-input').value = rememberedUser.password;
                    document.getElementById('remember-me-checkbox').checked = true;
                    // Set role yang benar di UI
                    toggleRole(rememberedUser.role, true); 
                    // Fokus ke input-group agar terlihat terisi
                    document.getElementById('login-id-input').closest('.input-group').classList.add('focus');
                    document.getElementById('login-password-input').closest('.input-group').classList.add('focus');
                }
            }
            
            // 2. Logika "Forgot Password" (Alur Baru)
            const forgotModal = document.getElementById('forgot-password-modal');
            const resetModal = document.getElementById('reset-password-modal'); // Modal baru
            
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                forgotModal.style.display = 'flex';
            });
            
            document.getElementById('close-forgot-modal-btn').addEventListener('click', () => {
                forgotModal.style.display = 'none';
                document.getElementById('forgot-id-input').value = '';
                document.getElementById('forgot-email-input').value = '';
            });
            
            // Tombol verifikasi di modal pertama
            document.getElementById('send-reset-btn').addEventListener('click', async () => {
                const id = document.getElementById('forgot-id-input').value.trim();
                const email = document.getElementById('forgot-email-input').value.trim();

                if (!id || !email) {
                    window.showNotification("â— ID dan Email tidak boleh kosong.", 3000);
                    return;
                }

                try {
                    const userRef = ref(db, `users/${id}`); 
                    const snapshot = await get(userRef);

                    if (!snapshot.exists()) {
                        window.showNotification("âŒ ID tidak ditemukan di database.", 4000);
                        return;
                    }

                    const userData = snapshot.val();
                    
                    if (userData.email.toLowerCase() === email.toLowerCase()) {
                        // --- INI PERUBAHANNYA ---
                        // 1. Simpan ID user yang akan direset
                        userToResetId = id; 
                        
                        // 2. Tampilkan ID di modal baru
                        document.getElementById('reset-user-id-display').textContent = id;
                        
                        // 3. Bersihkan & tutup modal lama
                        document.getElementById('forgot-id-input').value = '';
                        document.getElementById('forgot-email-input').value = '';
                        forgotModal.style.display = 'none';
                        
                        // 4. Tampilkan modal baru
                        resetModal.style.display = 'flex';
                        
                    } else {
                        window.showNotification("âŒ ID ditemukan, tapi email yang Anda masukkan salah.", 4000);
                    }
                } catch (error) {
                    console.error("Gagal cek password reset:", error);
                    window.showNotification("âŒ Gagal terhubung ke database. Coba lagi.", 5000);
                }
            });
            
            // Tombol "Batal" di modal reset baru
            document.getElementById('close-reset-modal-btn').addEventListener('click', () => {
                resetModal.style.display = 'none';
                document.getElementById('new-password-input').value = '';
                userToResetId = null; // Batalkan proses reset
            });
            
            // Tombol "Simpan Password Baru" di modal reset baru
            document.getElementById('save-new-password-btn').addEventListener('click', async () => {
                const newPassword = document.getElementById('new-password-input').value;
                
                if (newPassword.length < 6) {
                    window.showNotification("â— Password baru minimal 6 karakter.", 4000);
                    return;
                }
                
                if (!userToResetId) {
                    window.showNotification("âŒ Terjadi error. Silakan ulangi proses lupa password.", 5000);
                    resetModal.style.display = 'none';
                    return;
                }
                
                try {
                    // Update password di Firebase
                    await update(ref(db, `users/${userToResetId}`), { 
                        password: newPassword,
                        activeSessionToken: null // Kosongkan token sesi agar login ulang
                    });
                    
                    window.showNotification(`âœ… Password untuk ${userToResetId} berhasil direset! Silakan login.`, 5000);
                    
                    // Bersihkan dan tutup modal
                    resetModal.style.display = 'none';
                    document.getElementById('new-password-input').value = '';
                    userToResetId = null;
                    
                    // Jika data "remember me" adalah user ini, hapus
                    const savedUser = localStorage.getItem(REMEMBER_ME_KEY);
                    if (savedUser && JSON.parse(savedUser).id === userToResetId) {
                        localStorage.removeItem(REMEMBER_ME_KEY);
                        // Bersihkan juga form login jika datanya terisi
                        document.getElementById('login-id-input').value = '';
                        document.getElementById('login-password-input').value = '';
                        document.getElementById('remember-me-checkbox').checked = false;
                    }

                } catch (error) {
                    console.error("Gagal update password:", error);
                    window.showNotification("âŒ Gagal menyimpan password baru di database.", 5000);
                }
            });
            
            // --- LISTENER BARU UNTUK MENU KONTEKS CHAT ---
            document.getElementById('ctx-reply').addEventListener('click', (e) => {
                e.stopPropagation(); // Hentikan event agar tidak menutup menu
                handleChatMenuAction('reply');
            });
            document.getElementById('ctx-delete-self').addEventListener('click', (e) => {
                e.stopPropagation();
                handleChatMenuAction('delete_self');
            });
            document.getElementById('ctx-delete-all').addEventListener('click', (e) => {
                e.stopPropagation();
                handleChatMenuAction('delete_all');
            });

            // --- INISIALISASI ---
            const adModal = document.getElementById('ad-modal');
            const adCloseBtn = document.querySelector('.ad-close-btn');
            
            // Cek jika auto-login tidak terjadi
            if (!loggedInUser) {
                toggleFormMode(); // Panggil sekali untuk beralih ke mode Login (default)
                loadRememberedUser(); // Panggil fungsi untuk mengisi data "Remember Me"
                
                // ===== LOGIKA BARU: MENAMPILKAN MODAL IKLAN =====
                // Cek jika modal ada dan belum pernah ditampilkan sebelumnya
                if (adModal && !localStorage.getItem(AD_SHOWN_KEY)) {
                    // Tampilkan modal
                    adModal.classList.add('show');
                    
                    // Simpan status di localStorage agar tidak muncul lagi
                    localStorage.setItem(AD_SHOWN_KEY, 'true'); 
                    
                    // Listener untuk tombol tutupQ
                    adCloseBtn.onclick = function() {
                        adModal.classList.remove('show');
                    }

                    // Listener untuk klik di luar modal (backdrop)
                    window.onclick = function(event) {
                        if (event.target == adModal) {
                            adModal.classList.remove('show');
                        }
                    }
                }
                // ==================================================

            }
            
            
        });
        // ======================================= //
// === FUNGSI UNTUK SETTINGS (Ubah Password & PIN) === //
// ======================================= //

// Ubah Password
document.getElementById('btn-change-password')?.addEventListener('click', async function() {
    const currentPass = document.getElementById('current-password').value;
    const newPass = document.getElementById('new-password').value;
    const confirmPass = document.getElementById('confirm-password').value;
    const statusEl = document.getElementById('password-change-status');
    
    // Validasi
    if (!currentPass || !newPass || !confirmPass) {
        statusEl.innerHTML = '<div class="alert-warning">Harap isi semua field!</div>';
        return;
    }
    
    if (newPass.length < 6) {
        statusEl.innerHTML = '<div class="alert-warning">Password baru minimal 6 karakter!</div>';
        return;
    }
    
    if (newPass !== confirmPass) {
        statusEl.innerHTML = '<div class="alert-warning">Password baru tidak cocok!</div>';
        return;
    }
    
    try {
        // Ambil data user dari Firebase
        const userRef = ref(db, `users/${CURRENT_USER.id}`);
        const snapshot = await get(userRef);
        
        if (!snapshot.exists()) {
            statusEl.innerHTML = '<div class="alert-warning">User tidak ditemukan!</div>';
            return;
        }
        
        const userData = snapshot.val();
        
        // Verifikasi password saat ini
        if (userData.password !== currentPass) {
            statusEl.innerHTML = '<div class="alert-warning">Password saat ini salah!</div>';
            return;
        }
        
        // Update password di Firebase
        await update(userRef, { password: newPass });
        
        // Update local storage
        CURRENT_USER.password = newPass;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(CURRENT_USER));
        
        statusEl.innerHTML = '<div class="alert-success">âœ… Password berhasil diubah!</div>';
        
        // Clear form
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        
    } catch (error) {
        console.error('Error changing password:', error);
        statusEl.innerHTML = '<div class="alert-warning">âŒ Gagal mengubah password!</div>';
    }
});

// ======================================= //
// === FUNGSI UNTUK PIN VERIFICATION === //
// ======================================= //

let pinDigits = [];
let isSettingPin = false;

// Toggle PIN
document.getElementById('enable-pin-toggle')?.addEventListener('change', function() {
    const pinContainer = document.getElementById('pin-setup-container');
    if (this.checked) {
        pinContainer.style.display = 'block';
        isSettingPin = true;
        resetPinDisplay();
    } else {
        pinContainer.style.display = 'none';
        isSettingPin = false;
        // Hapus PIN dari local storage jika dinonaktifkan
        localStorage.removeItem(`user_pin_${CURRENT_USER.id}`);
        showPinStatus('PIN Verification telah dinonaktifkan.', 'success');
    }
});

// Setup PIN Keypad
function setupPinKeypad() {
    document.querySelectorAll('.pin-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            const number = this.dataset.number;
            
            if (action === 'clear') {
                pinDigits = [];
                updatePinDisplay();
            } else if (action === 'backspace') {
                pinDigits.pop();
                updatePinDisplay();
            } else if (number && pinDigits.length < 6) {
                pinDigits.push(number);
                updatePinDisplay();
            }
        });
    });
}

// Update PIN Display
function updatePinDisplay() {
    const digitElements = document.querySelectorAll('.pin-digit');
    const saveBtn = document.getElementById('btn-save-pin');
    
    digitElements.forEach((el, index) => {
        if (index < pinDigits.length) {
            el.textContent = 'â€¢';
            el.style.borderColor = '#007bff';
        } else {
            el.textContent = '';
            el.style.borderColor = '#ccc';
        }
    });
    
    // Enable save button jika PIN sudah 6 digit
    saveBtn.disabled = pinDigits.length !== 6;
}

// Reset PIN Display
function resetPinDisplay() {
    pinDigits = [];
    updatePinDisplay();
    document.getElementById('btn-save-pin').disabled = true;
}

// Simpan PIN
document.getElementById('btn-save-pin')?.addEventListener('click', function() {
    if (pinDigits.length !== 6) return;
    
    const pin = pinDigits.join('');
    
    // Simpan ke Local Storage
    localStorage.setItem(`user_pin_${CURRENT_USER.id}`, pin);
    
    // Simpan ke Firebase (optional)
    const userRef = ref(db, `users/${CURRENT_USER.id}`);
    update(userRef, { hasPin: true, pinEnabled: true });
    
    showPinStatus('âœ… PIN berhasil disimpan! PIN akan diminta saat login.', 'success');
    resetPinDisplay();
    
    // Nonaktifkan toggle setelah PIN disimpan
    setTimeout(() => {
        document.getElementById('enable-pin-toggle').checked = true;
    }, 100);
});

// Cancel PIN
document.getElementById('btn-cancel-pin')?.addEventListener('click', function() {
    resetPinDisplay();
    document.getElementById('enable-pin-toggle').checked = false;
    document.getElementById('pin-setup-container').style.display = 'none';
});

// Show PIN Status
function showPinStatus(message, type = 'info') {
    const statusEl = document.getElementById('pin-status');
    statusEl.innerHTML = `<div class="alert-${type}">${message}</div>`;
    setTimeout(() => {
        statusEl.innerHTML = '';
    }, 5000);
}

// ======================================= //
// === FUNGSI UNTUK FILE CONVERTER === //
// ======================================= //

let uploadedFile = null;

// Event Listener untuk File Upload
document.getElementById('converter-file-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    uploadedFile = file;
    
    // Tampilkan preview
    document.getElementById('file-preview').style.display = 'block';
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    document.getElementById('file-format').textContent = getFileExtension(file.name).toUpperCase();
});

// Upload ke Local Storage
document.getElementById('btn-upload-converter')?.addEventListener('click', async function() {
    if (!uploadedFile) {
        showConversionStatus('Pilih file terlebih dahulu!', 'warning');
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const fileData = {
            name: uploadedFile.name,
            size: uploadedFile.size,
            type: uploadedFile.type,
            extension: getFileExtension(uploadedFile.name),
            data: e.target.result,
            uploadedAt: new Date().toISOString()
        };
        
        // Simpan ke Local Storage
        const storageKey = `converter_file_${Date.now()}`;
        localStorage.setItem(storageKey, JSON.stringify(fileData));
        
        showConversionStatus('âœ… File berhasil diupload ke Local Storage!', 'success');
        loadStoredFiles();
        
        // Auto-set source format
        document.getElementById('source-format').value = fileData.extension;
    };
    
    reader.readAsDataURL(uploadedFile);
});

// Load stored files
function loadStoredFiles() {
    const filesList = document.getElementById('stored-files-list');
    filesList.innerHTML = '';
    
    let fileCount = 0;
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('converter_file_')) {
            try {
                const fileData = JSON.parse(localStorage.getItem(key));
                fileCount++;
                
                const fileItem = document.createElement('div');
                fileItem.className = 'stored-file-item';
                fileItem.style.cssText = 'padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;';
                fileItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${fileData.name}</strong>
                            <br>
                            <small>${formatFileSize(fileData.size)} â€¢ ${fileData.extension.toUpperCase()} â€¢ ${new Date(fileData.uploadedAt).toLocaleString()}</small>
                        </div>
                        <div>
                            <button class="btn-action btn-secondary btn-use-file" data-key="${key}" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-play"></i> Gunakan
                            </button>
                            <button class="btn-action btn-delete btn-delete-file" data-key="${key}" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                filesList.appendChild(fileItem);
            } catch (e) {
                console.error('Error parsing stored file:', e);
            }
        }
    }
    
    if (fileCount === 0) {
        filesList.innerHTML = '<p style="color: #666; text-align: center;">Tidak ada file di Local Storage.</p>';
    }
    
    // Add event listeners to buttons
    document.querySelectorAll('.btn-use-file').forEach(btn => {
        btn.addEventListener('click', function() {
            const key = this.dataset.key;
            const fileData = JSON.parse(localStorage.getItem(key));
            
            // Set sebagai source
            document.getElementById('source-format').value = fileData.extension;
            
            showConversionStatus(`File "${fileData.name}" dipilih sebagai sumber.`, 'info');
        });
    });
    
    document.querySelectorAll('.btn-delete-file').forEach(btn => {
        btn.addEventListener('click', function() {
            const key = this.dataset.key;
            if (confirm('Hapus file ini dari Local Storage?')) {
                localStorage.removeItem(key);
                loadStoredFiles();
                showConversionStatus('File dihapus dari Local Storage.', 'success');
            }
        });
    });
}

// Enable convert button when both formats selected
document.getElementById('source-format')?.addEventListener('change', updateConvertButton);
document.getElementById('target-format')?.addEventListener('change', updateConvertButton);

function updateConvertButton() {
    const source = document.getElementById('source-format').value;
    const target = document.getElementById('target-format').value;
    const btn = document.getElementById('btn-convert-file');
    
    btn.disabled = !(source && target && source !== target);
}

// Convert File
document.getElementById('btn-convert-file')?.addEventListener('click', function() {
    const sourceFormat = document.getElementById('source-format').value;
    const targetFormat = document.getElementById('target-format').value;
    
    if (!sourceFormat || !targetFormat || sourceFormat === targetFormat) return;
    
    // Simulasi konversi (ini hanya contoh - implementasi sebenarnya tergantung library)
    simulateFileConversion(sourceFormat, targetFormat);
});

function simulateFileConversion(source, target) {
    const statusEl = document.getElementById('conversion-status');
    const downloadSection = document.getElementById('download-section');
    
    // Tampilkan status konversi
    statusEl.innerHTML = `<div class="alert-info"><i class="fas fa-sync-alt fa-spin"></i> Mengonversi ${source.toUpperCase()} ke ${target.toUpperCase()}...</div>`;
    
    // Simulasi proses konversi
    setTimeout(() => {
        // Generate fake converted file
        const convertedFileName = `converted_file_${Date.now()}.${target}`;
        const convertedFileSize = Math.floor(Math.random() * 1000000) + 1000; // 1KB - 1MB
        
        // Update UI
        statusEl.innerHTML = `<div class="alert-success">âœ… Konversi berhasil!</div>`;
        
        // Tampilkan download section
        downloadSection.style.display = 'block';
        document.getElementById('converted-info').innerHTML = `
            <strong>${convertedFileName}</strong> â€¢ ${formatFileSize(convertedFileSize)}
        `;
        
        // Setup download button
        document.getElementById('btn-download-converted').onclick = function() {
            // Create fake download
            const fakeContent = `This is a simulated ${target.toUpperCase()} file converted from ${source.toUpperCase()} format.`;
            const blob = new Blob([fakeContent], { type: getMimeType(target) });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = convertedFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showConversionStatus('âœ… File berhasil didownload!', 'success');
        };
        
    }, 1500);
}

// Clear Local Storage
document.getElementById('btn-clear-storage')?.addEventListener('click', function() {
    if (confirm('Hapus semua file dari Local Storage?')) {
        const keysToRemove = [];
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('converter_file_')) {
                keysToRemove.push(key);
            }
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        loadStoredFiles();
        showConversionStatus('Semua file dihapus dari Local Storage.', 'success');
    }
});

// Helper Functions
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileExtension(filename) {
    return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2).toLowerCase();
}

function getMimeType(extension) {
    const mimeTypes = {
        'txt': 'text/plain',
        'pdf': 'application/pdf',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'csv': 'text/csv',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    };
    return mimeTypes[extension] || 'application/octet-stream';
}

function showConversionStatus(message, type = 'info') {
    const statusEl = document.getElementById('conversion-status');
    statusEl.innerHTML = `<div class="alert-${type}">${message}</div>`;
    setTimeout(() => {
        statusEl.innerHTML = '';
    }, 5000);
}

// ======================================= //
// === INISIALISASI === //
// ======================================= //

// Initialize PIN system
if (document.getElementById('enable-pin-toggle')) {
    setupPinKeypad();
    
    // Cek apakah PIN sudah ada
    const hasPin = localStorage.getItem(`user_pin_${CURRENT_USER.id}`);
    if (hasPin) {
        document.getElementById('enable-pin-toggle').checked = true;
        document.getElementById('pin-setup-container').style.display = 'none';
        showPinStatus('PIN Verification aktif.', 'success');
    }
}

// Initialize File Converter
if (document.getElementById('converter-file-input')) {
    // Load stored files on page load
    loadStoredFiles();
}

// ======================================= //
// === MODIFIKASI FUNGSI LOGIN UNTUK PIN === //
// ======================================= //

// Modifikasi fungsi handleLogin untuk menambahkan verifikasi PIN
async function handleLoginWithPIN(id, password, rememberMe = false) {
    // Proses login normal dulu...
    // ... (kode login yang sudah ada)
    
    // Setelah berhasil login, cek apakah user punya PIN
    const hasPin = localStorage.getItem(`user_pin_${id}`);
    
    if (hasPin) {
        // Tampilkan modal PIN
        showPinVerificationModal(id);
    } else {
        // Lanjutkan ke dashboard
        goToDashboard(userData);
    }
}

function showPinVerificationModal(userId) {
    // Buat modal PIN
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 300px;">
            <h3><i class="fas fa-shield-alt"></i> PIN Verification</h3>
            <p>Masukkan PIN 6 digit Anda:</p>
            
            <div id="pin-verify-display" style="display: flex; justify-content: center; gap: 10px; margin: 20px 0;">
                <div class="pin-digit-verify" style="width: 35px; height: 35px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 31px; font-size: 18px; font-weight: bold;"></div>
                <div class="pin-digit-verify" style="width: 35px; height: 35px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 31px; font-size: 18px; font-weight: bold;"></div>
                <div class="pin-digit-verify" style="width: 35px; height: 35px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 31px; font-size: 18px; font-weight: bold;"></div>
                <div class="pin-digit-verify" style="width: 35px; height: 35px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 31px; font-size: 18px; font-weight: bold;"></div>
                <div class="pin-digit-verify" style="width: 35px; height: 35px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 31px; font-size: 18px; font-weight: bold;"></div>
                <div class="pin-digit-verify" style="width: 35px; height: 35px; border: 2px solid #ccc; border-radius: 5px; text-align: center; line-height: 31px; font-size: 18px; font-weight: bold;"></div>
            </div>
            
            <!-- Keypad -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 200px; margin: 0 auto;">
                <button class="pin-btn-verify" data-number="1">1</button>
                <button class="pin-btn-verify" data-number="2">2</button>
                <button class="pin-btn-verify" data-number="3">3</button>
                <button class="pin-btn-verify" data-number="4">4</button>
                <button class="pin-btn-verify" data-number="5">5</button>
                <button class="pin-btn-verify" data-number="6">6</button>
                <button class="pin-btn-verify" data-number="7">7</button>
                <button class="pin-btn-verify" data-number="8">8</button>
                <button class="pin-btn-verify" data-number="9">9</button>
                <button class="pin-btn-verify" style="grid-column: 1/3;" data-action="clear">Clear</button>
                <button class="pin-btn-verify" data-number="0">0</button>
                <button class="pin-btn-verify" data-action="backspace"><i class="fas fa-backspace"></i></button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="btn-verify-pin" class="btn-action btn-primary" disabled>
                    <i class="fas fa-check"></i> Verifikasi
                </button>
            </div>
            
            <p style="font-size: 12px; color: #666; margin-top: 15px;">
                <i class="fas fa-info-circle"></i> PIN ini adalah keamanan tambahan untuk akun Anda.
            </p>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Setup PIN verification logic
    const pinDigitsVerify = [];
    
    // Update PIN display
    function updatePinVerifyDisplay() {
        const digitElements = document.querySelectorAll('.pin-digit-verify');
        const verifyBtn = document.getElementById('btn-verify-pin');
        
        digitElements.forEach((el, index) => {
            if (index < pinDigitsVerify.length) {
                el.textContent = 'â€¢';
                el.style.borderColor = '#007bff';
            } else {
                el.textContent = '';
                el.style.borderColor = '#ccc';
            }
        });
        
        verifyBtn.disabled = pinDigitsVerify.length !== 6;
    }
    
    // Setup keypad listeners
    modal.querySelectorAll('.pin-btn-verify').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            const number = this.dataset.number;
            
            if (action === 'clear') {
                pinDigitsVerify.length = 0;
                updatePinVerifyDisplay();
            } else if (action === 'backspace') {
                pinDigitsVerify.pop();
                updatePinVerifyDisplay();
            } else if (number && pinDigitsVerify.length < 6) {
                pinDigitsVerify.push(number);
                updatePinVerifyDisplay();
            }
        });
    });
    
    // Verify PIN
    modal.querySelector('#btn-verify-pin').addEventListener('click', function() {
        const enteredPin = pinDigitsVerify.join('');
        const storedPin = localStorage.getItem(`user_pin_${userId}`);
        
        if (enteredPin === storedPin) {
            // PIN benar, lanjutkan ke dashboard
            modal.remove();
            
            // Lanjutkan ke dashboard (fungsi goToDashboard sudah ada di sistem)
            // Pastikan CURRENT_USER sudah di-set
            window.showNotification('âœ… PIN verifikasi berhasil!', 3000);
            
            // Reload untuk memastikan semua state terupdate
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            // PIN salah
            pinDigitsVerify.length = 0;
            updatePinVerifyDisplay();
            window.showNotification('âŒ PIN salah! Coba lagi.', 3000);
        }
    });
    
    // Close modal saat klik di luar
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            // Jika user menutup modal PIN, batalkan login
            modal.remove();
            window.showNotification('âŒ Login dibatalkan. PIN diperlukan.', 3000);
            
            // Reset login form
            const loginForm = document.getElementById('form-login');
            if (loginForm) {
                loginForm.reset();
            }
            
            // Kembali ke login page
            document.body.classList.remove('dashboard-mode');
            document.body.classList.add('login-mode');
        }
    });
}

function initSidebarDropdowns() {

    const titles = document.querySelectorAll('.menu-group-title[data-target]');

    titles.forEach(title => {

        title.addEventListener('click', function (e) {

            e.preventDefault();
            e.stopPropagation();

            const dropdown = document.getElementById(this.dataset.target);
            if (!dropdown) return;

            const isOpen = dropdown.classList.contains('open');

            // ðŸ”´ tutup semua dropdown dulu
            document.querySelectorAll('.menu-group-title')
                .forEach(t => t.classList.remove('open'));

            document.querySelectorAll('.dropdown-menu')
                .forEach(d => d.classList.remove('open'));

            // ðŸŸ¢ buka hanya kalau sebelumnya tutup
            if (!isOpen) {
                this.classList.add('open');
                dropdown.classList.add('open');
            }

        });

    });

}

/* buka otomatis kalau menu aktif */
function setupActiveDropdown() {

    const activeLink = document.querySelector('.menu-link.active');
    if (!activeLink) return;

    const parentList = activeLink.closest('.dropdown-menu');
    if (!parentList) return;

    const parentTitle = document.querySelector(
        `.menu-group-title[data-target="${parentList.id}"]`
    );

    if (parentTitle) {
        parentTitle.classList.add('open');
        parentList.classList.add('open');
    }

}

document.addEventListener('DOMContentLoaded', () => {
    initSidebarDropdowns();
    setupActiveDropdown();
});
function injectCopyrightToActivePage(){

    const activePage = document.querySelector('.content-section.active');
    if(!activePage) return;

    // cegah dobel
    if(activePage.querySelector('.global-copyright')) return;

    const footer = document.createElement('div');
    footer.className = 'global-copyright';

    footer.innerHTML = `
        <p>Management System Information</p>
        <span>Developed by Â©MahasiswaSistemInformasi MSI</span>
    `;

    activePage.appendChild(footer);

}

/* saat halaman load */
document.addEventListener('DOMContentLoaded',injectCopyrightToActivePage);

/* setiap klik menu */
document.addEventListener('click',function(e){

    if(e.target.closest('.menu-link')){

        setTimeout(()=>{
            injectCopyrightToActivePage();
        },150);

    }

});

let imlekAudio = null;
let efekSudahJalan = false; 

document.addEventListener('DOMContentLoaded', function() {
    // 1. Inisialisasi Audio
    imlekAudio = new Audio('https://files.catbox.moe/pcellr.mp3'); 
    imlekAudio.loop = true;

    // 2. Buat Elemen Overlay & Teks secara dinamis
    const bgOverlay = document.createElement('div');
    bgOverlay.id = 'imlek-overlay-bg';
    document.body.appendChild(bgOverlay);

    const textOverlay = document.createElement('div');
    textOverlay.className = 'imlek-overlay-text';
    textOverlay.innerHTML = "<h1>æ–°å¹´å¿«ä¹</h1><p>HAPPY CHINESE NEW YEAR</p>";
    document.body.appendChild(textOverlay);

    const btnImlek = document.getElementById('imlekBtn');

    if (btnImlek) {
        btnImlek.addEventListener('click', function() {
            if (imlekAudio.paused) {
                imlekAudio.play();
                btnImlek.classList.add('playing');

                if (!efekSudahJalan) {
                    mulaiPestaImlek(bgOverlay, textOverlay);
                    efekSudahJalan = true; 
                }
            } else {
                imlekAudio.pause();
                btnImlek.classList.remove('playing');
            }
        });
    }
});

function mulaiPestaImlek(bg, txt) {
    // Aktifkan Background Hitam & Teks
    bg.classList.add('active');
    txt.classList.add('show');
    
    // Matikan setelah 6 detik
    setTimeout(() => {
        bg.classList.remove('active');
        txt.classList.remove('show');
    }, 6000);

    // EFEK KEMBANG API & ROKET
    var duration = 6 * 1000;
    var animationEnd = Date.now() + duration;
    var defaults = { startVelocity: 45, spread: 360, ticks: 100, zIndex: 10000 };

    var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();

        if (timeLeft <= 0) return clearInterval(interval);

        // ROKET MELUNCUR DARI BAWAH
        confetti({
            ...defaults,
            particleCount: 3,
            origin: { x: 0.2, y: 1 },
            angle: 80,
            spread: 5,
            colors: ['#ff0000', '#ffd700'],
            startVelocity: 65
        });

        confetti({
            ...defaults,
            particleCount: 3,
            origin: { x: 0.8, y: 1 },
            angle: 100,
            spread: 5,
            colors: ['#ff0000', '#ffd700'],
            startVelocity: 65
        });

        // LEDAKAN PETASAN BINTANG
        if(timeLeft % 400 < 50) { 
            confetti({
                ...defaults,
                particleCount: 40,
                origin: { x: Math.random() * 0.6 + 0.2, y: Math.random() * 0.4 + 0.2 },
                shapes: ['star'], 
                colors: ['#FFD700', '#FF0000', '#FFFFFF'],
                scalar: 1.4
            });
        }
    }, 150);
}

// ==========================================
// AUTO DELETE 1 MINGGU + TOMBOL HAPUS SEMUA DI CHANNEL "RIWAYAT ABSEN" (NPM 15125029)
// ==========================================

(function() {
    'use strict';
    
    // Konfigurasi
    const CONFIG = {
        AUTO_DELETE_DAYS: 7,
        ADMIN_NPM: '15125029',
        CHECK_INTERVAL: 3600000 // 1 jam
    };
    
    let isAdmin = false;
    let autoDeleteInterval = null;
    let buttonInjected = false;
    
    // ==========================================
    // UTILITY FUNCTIONS
    // ==========================================
    
    function parseDateKey(dateKey) {
        const parts = dateKey.split('-');
        if (parts.length === 3) {
            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }
        return null;
    }
    
    function getDaysDifference(date1, date2) {
        return Math.round((date2 - date1) / (24 * 60 * 60 * 1000));
    }
    
    function getCurrentTimestamp() {
        return new Date().toLocaleString('id-ID');
    }
    
    // ==========================================
    // CHECK ADMIN STATUS
    // ==========================================
    
    function checkIfAdmin() {
        // Cek CURRENT_USER
        if (typeof CURRENT_USER !== 'undefined' && CURRENT_USER) {
            const userId = CURRENT_USER.npm || CURRENT_USER.id || '';
            if (userId === CONFIG.ADMIN_NPM) return true;
        }
        
        // Cek localStorage
        try {
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                const user = JSON.parse(saved);
                const userId = user.npm || user.id || '';
                if (userId === CONFIG.ADMIN_NPM) return true;
            }
        } catch (e) {}
        
        return false;
    }
    
    // ==========================================
    // AUTO DELETE FUNCTION (Background)
    // ==========================================
    
    async function autoDeleteOldAbsensi() {
        console.log(`[${getCurrentTimestamp()}] ðŸ”„ Auto-check: Menghapus data >${CONFIG.AUTO_DELETE_DAYS} hari...`);
        
        try {
            const absensiRef = ref(db, 'absensi');
            const snapshot = await get(absensiRef);
            
            if (!snapshot.exists()) return;
            
            const data = snapshot.val();
            const today = new Date();
            let deletedCount = 0;
            
            for (const dateKey in data) {
                const dateObj = parseDateKey(dateKey);
                if (!dateObj) continue;
                
                const daysOld = getDaysDifference(dateObj, today);
                
                if (daysOld > CONFIG.AUTO_DELETE_DAYS) {
                    await remove(ref(db, `absensi/${dateKey}`));
                    deletedCount++;
                    console.log(`ðŸ—‘ï¸ Auto-deleted: ${dateKey} (${daysOld} hari)`);
                }
            }
            
            // Hapus juga dosen_signatures yang lama
            const dosenSnapshot = await get(ref(db, 'dosen_signatures'));
            if (dosenSnapshot.exists()) {
                const dosenData = dosenSnapshot.val();
                for (const dateKey in dosenData) {
                    const dateObj = parseDateKey(dateKey);
                    if (!dateObj) continue;
                    
                    const daysOld = getDaysDifference(dateObj, today);
                    if (daysOld > CONFIG.AUTO_DELETE_DAYS) {
                        await remove(ref(db, `dosen_signatures/${dateKey}`));
                        console.log(`ðŸ—‘ï¸ Auto-deleted signature: ${dateKey}`);
                    }
                }
            }
            
            if (deletedCount > 0 && typeof window.showNotification === 'function') {
                window.showNotification(`ðŸ§¹ ${deletedCount} riwayat lama otomatis dihapus`, 4000);
            }
            
        } catch (error) {
            console.error('Auto-delete error:', error);
        }
    }
    
    // ==========================================
    // DELETE ALL FUNCTION (Admin Only)
    // ==========================================
    
    async function deleteAllAbsensi() {
        const confirm1 = confirm(
            'âš ï¸ PERINGATAN PENTING!\n\n' +
            'Anda akan MENGHAPUS SEMUA data absensi!\n' +
            'Termasuk:\n' +
            'â€¢ Semua riwayat absensi mahasiswa\n' +
            'â€¢ Semua tanda tangan dosen\n\n' +
            'Tindakan ini TIDAK BISA DIBATALKAN!\n\n' +
            'Lanjutkan?'
        );
        if (!confirm1) return;
        
        const confirm2 = prompt('Untuk konfirmasi, ketik "HAPUS SEMUA":');
        if (confirm2 !== 'HAPUS SEMUA') {
            alert('âŒ Penghapusan dibatalkan');
            return;
        }
        
        const btn = document.getElementById('admin-delete-all-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghapus...';
        btn.disabled = true;
        
        try {
            console.log(`[${getCurrentTimestamp()}] ðŸ—‘ï¸ Admin ${CONFIG.ADMIN_NPM} menghapus SEMUA data...`);
            
            // Hapus semua absensi
            await remove(ref(db, 'absensi'));
            console.log('âœ… Data absensi dihapus');
            
            // Hapus semua tanda tangan dosen
            await remove(ref(db, 'dosen_signatures'));
            console.log('âœ… Data tanda tangan dihapus');
            
            // Notifikasi sukses
            if (typeof window.showNotification === 'function') {
                window.showNotification('âœ… Semua riwayat absensi berhasil dihapus!', 5000);
            } else {
                alert('âœ… Semua riwayat absensi berhasil dihapus!');
            }
            
            // Refresh tampilan riwayat absen
            if (typeof window.renderAbsenLog === 'function') {
                window.renderAbsenLog();
            }
            
            // Re-inject tombol setelah refresh
            setTimeout(() => {
                buttonInjected = false;
                injectDeleteButton();
            }, 1000);
            
        } catch (error) {
            console.error('Delete all error:', error);
            alert('âŒ Gagal menghapus: ' + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    // ==========================================
    // DETECT CHANNEL "RIWAYAT ABSEN"
    // ==========================================
    
    function isRiwayatAbsenChannel() {
        // Cek 1: URL hash
        if (window.location.hash === '#riwayat-absen') return true;
        
        // Cek 2: Active nav button
        const activeNav = document.querySelector('.nav-btn.active');
        if (activeNav && activeNav.textContent.includes('Riwayat Absen')) return true;
        
        // Cek 3: Visible container riwayat absen (yang untuk mahasiswa/dosen biasa)
        const riwayatContainer = document.getElementById('riwayat-absen-content');
        if (riwayatContainer && riwayatContainer.style.display !== 'none') return true;
        
        // Cek 4: Container dengan ID absen-log-container yang visible dan bukan untuk ketua kelas
        const absenLogContainer = document.getElementById('absen-log-container');
        if (absenLogContainer && 
            absenLogContainer.style.display !== 'none' &&
            absenLogContainer.offsetParent !== null) {
            
            // Pastikan BUKAN di ketua kelas page
            const ketuaContent = document.getElementById('ketua-kelas-content');
            if (ketuaContent && ketuaContent.style.display !== 'none') {
                return false; // Ini halaman ketua kelas, bukan riwayat absen biasa
            }
            
            // Cek apakah container ini ada di dalam riwayat-absen-content
            const parent = absenLogContainer.closest('#riwayat-absen-content');
            if (parent) return true;
        }
        
        return false;
    }
    
    // ==========================================
    // INJECT DELETE BUTTON INTO "RIWAYAT ABSEN" CHANNEL
    // ==========================================
    
    function injectDeleteButton() {
        // Validasi: harus admin, harus di channel riwayat absen, belum diinject
        if (!isAdmin) return;
        if (!isRiwayatAbsenChannel()) return;
        if (buttonInjected) return;
        
        // Cari container yang tepat untuk riwayat absen
        let targetContainer = document.getElementById('riwayat-absen-content');
        
        // Jika tidak ketemu, cari container utama yang visible
        if (!targetContainer) {
            const containers = [
                document.getElementById('absen-log-container'),
                document.querySelector('.content-section[style*="display: block"]'),
                document.querySelector('.main-content')
            ];
            
            for (const container of containers) {
                if (container && container.offsetParent !== null) {
                    targetContainer = container;
                    break;
                }
            }
        }
        
        if (!targetContainer) return;
        
        // Cek sudah ada tombol
        if (document.getElementById('admin-delete-section')) return;
        
        // Buat section tombol admin
        const deleteSection = document.createElement('div');
        deleteSection.id = 'admin-delete-section';
        deleteSection.style.cssText = `
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border: 2px solid #fc8181;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(220, 38, 38, 0.1);
            position: relative;
            overflow: hidden;
        `;
        
        // Tambahkan strip merah di atas
        deleteSection.innerHTML = `
            <div style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #e53e3e, #c53030);
            "></div>
            
            <div style="margin-bottom: 12px;">
                <i class="fas fa-exclamation-triangle" style="color: #e53e3e; font-size: 28px;"></i>
            </div>
            
            <h4 style="
                color: #c53030; 
                margin: 0 0 8px 0; 
                font-size: 16px;
                font-weight: bold;
            ">
                âš ï¸ ZONA BERBAHAYA - ADMIN ONLY
            </h4>
            
            <p style="
                color: #742a2a; 
                font-size: 13px; 
                margin: 0 0 15px 0;
                line-height: 1.4;
            ">
                Tombol ini akan menghapus <strong>SELURUH</strong> data absensi dari database.<br>
                Tindakan ini <strong>PERMANEN</strong> dan tidak bisa dikembalikan.
            </p>
            
            <button id="admin-delete-all-btn" style="
                background: linear-gradient(135deg, #e53e3e, #c53030);
                color: white;
                border: none;
                padding: 14px 35px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
                box-shadow: 0 4px 6px rgba(229, 62, 62, 0.3);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(229,62,62,0.4)'" 
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(229,62,62,0.3)'">
                <i class="fas fa-trash-alt"></i> HAPUS SEMUA RIWAYAT
            </button>
            
            <div style="
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px dashed #fc8181;
            ">
                <p style="
                    color: #9b2c2c; 
                    font-size: 11px; 
                    margin: 0;
                    font-family: monospace;
                ">
                    ðŸ‘¤ NPM: ${CONFIG.ADMIN_NPM} | ðŸ• ${getCurrentTimestamp()}
                </p>
            </div>
        `;
        
        // Insert di awal container
        targetContainer.insertBefore(deleteSection, targetContainer.firstChild);
        
        // Add event listener
        document.getElementById('admin-delete-all-btn').addEventListener('click', deleteAllAbsensi);
        
        buttonInjected = true;
        console.log('âœ… Admin delete button injected into Riwayat Absen channel');
    }
    
    // ==========================================
    // MONITOR NAVIGATION CHANGES
    // ==========================================
    
    function setupNavigationMonitor() {
        // Monitor hash changes
        window.addEventListener('hashchange', () => {
            buttonInjected = false; // Reset agar bisa inject ulang
            setTimeout(injectDeleteButton, 300);
        });
        
        // Monitor click pada nav buttons
        document.addEventListener('click', (e) => {
            const navBtn = e.target.closest('.nav-btn');
            if (navBtn) {
                buttonInjected = false;
                setTimeout(injectDeleteButton, 500);
            }
        });
        
        // Observer untuk perubahan DOM
        const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.type === 'childList') {
                    // Cek jika riwayat absen container muncul
                    setTimeout(() => {
                        if (isRiwayatAbsenChannel() && !buttonInjected) {
                            injectDeleteButton();
                        }
                    }, 300);
                }
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Check periodic
        setInterval(() => {
            if (isRiwayatAbsenChannel() && !buttonInjected) {
                injectDeleteButton();
            }
        }, 1000);
    }
    
    // ==========================================
    // INITIALIZATION
    // ==========================================
    
    function init() {
        // Cek admin status
        isAdmin = checkIfAdmin();
        
        if (isAdmin) {
            console.log(`ðŸ‘‘ Admin mode active for NPM ${CONFIG.ADMIN_NPM}`);
            console.log('ðŸ“ Tombol hapus akan muncul di channel "Riwayat Absen"');
        }
        
        // Jalankan auto-delete background
        autoDeleteOldAbsensi();
        autoDeleteInterval = setInterval(autoDeleteOldAbsensi, CONFIG.CHECK_INTERVAL);
        
        // Setup navigation monitor
        setupNavigationMonitor();
        
        // Initial check
        setTimeout(() => {
            if (isRiwayatAbsenChannel()) {
                injectDeleteButton();
            }
        }, 1000);
        
        // Re-check setelah login
        setTimeout(() => {
            isAdmin = checkIfAdmin();
            if (isAdmin && isRiwayatAbsenChannel()) {
                injectDeleteButton();
            }
        }, 3000);
    }
    
    // Jalankan
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // Re-init saat auth berubah
    if (typeof onAuthStateChanged !== 'undefined' && typeof auth !== 'undefined') {
        onAuthStateChanged(auth, () => {
            setTimeout(() => {
                isAdmin = checkIfAdmin();
                buttonInjected = false;
                if (isAdmin && isRiwayatAbsenChannel()) {
                    injectDeleteButton();
                }
            }, 1500);
        });
    }
    
    // Expose fungsi global (opsional)
    window.AbsensiAdmin = {
        isAdmin: () => isAdmin,
        isRiwayatAbsen: isRiwayatAbsenChannel,
        injectButton: injectDeleteButton,
        deleteAll: deleteAllAbsensi
    };
    
})();
    </script>

</body>
</html>
